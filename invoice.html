<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supreme Enterprises - Invoice System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Auth Styles */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .auth-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .auth-logo img {
            height: 60px;
        }
        
        .auth-form .form-group {
            margin-bottom: 15px;
        }
        
        .auth-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .auth-form input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .auth-form button:hover {
            background: #2980b9;
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }
        
        /* Admin Dashboard Styles */
        .dashboard {
            background: white;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .dashboard-title {
            color: var(--primary-color);
        }
        
        .dashboard-logo {
            height: 60px;
        }
        
        .dashboard-user {
            display: flex;
            align-items: center;
        }
        
        .dashboard-user img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .dashboard-logout {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .dashboard-logout:hover {
            background: #c0392b;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            white-space: nowrap;
        }
        
        .tab.active {
            background: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form Styles */
        .form-section {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        button {
            padding: 10px 15px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--accent-color);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-success {
            background: var(--success-color);
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Table Styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Invoice Preview */
        .invoice-preview {
            margin-bottom: 30px;
        }
        
        .page {
            width: 210mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 15mm;
            box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background: white;
            position: relative;
        }
        
        /* Invoice Specific Styles */
        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .company-info {
            flex: 1;
        }
        
        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .invoice-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--primary-color);
            text-transform: uppercase;
        }
        
        .invoice-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .invoice-number, .invoice-date {
            font-weight: bold;
        }
        
        .address-block {
            display: flex;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .from-address, .bill-to-address, .ship-to-address {
            flex: 1;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background: #f9f9f9;
        }
        
        .address-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .invoice-table th {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
        }
        
        .invoice-table td {
            vertical-align: top;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f2f2f2;
        }
        
        .tax-details {
            width: 50%;
            float: right;
            margin-top: 20px;
        }
        
        .amount-in-words {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .signature-area {
            display: flex;
            justify-content: space-between;
            margin-top: 80px;
        }
        
        .signature {
            text-align: center;
            width: 200px;
        }
        
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 50px;
            padding-top: 5px;
        }
        
        .signature-image {
            height: 80px;
            margin-bottom: 10px;
        }
        
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 12px;
            color: #777;
        }
        
        /* Product Autocomplete */
        .product-autocomplete {
            position: relative;
        }
        
        .autocomplete-results {
            position: absolute;
            z-index: 1000;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .autocomplete-item {
            padding: 8px 10px;
            cursor: pointer;
        }
        
        .autocomplete-item:hover {
            background-color: #f5f5f5;
        }
        
        /* History Styles */
        .history-item {
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            background: white;
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .history-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .history-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Client Management */
        .client-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .client-list {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .client-item {
            padding: 15px;
            border: 1px solid #ddd;
            margin-bottom: 15px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .client-info {
            flex: 1;
        }
        
        .client-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Settings */
        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            background: var(--accent-color);
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Share Link */
        .share-container {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .share-link {
            display: flex;
            margin-bottom: 15px;
        }
        
        .share-link input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            margin-right: 0;
        }
        
        .share-link button {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            margin-left: 0;
        }
        
        .share-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .share-options button {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .share-options .btn-whatsapp {
            background: #25D366;
        }
        
        .share-options .btn-email {
            background: #D44638;
        }
        
        /* Customer View */
        .customer-view {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .customer-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .page, .page * {
                visibility: visible;
            }
            .page {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                box-shadow: none;
                margin: 0;
                padding: 15mm;
            }
            .no-print {
                display: none !important;
            }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .address-block {
                flex-direction: column;
            }
            
            .tax-details {
                width: 100%;
                float: none;
            }
            
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .client-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .client-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-user {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Container (Initially Visible) -->
    <div id="auth-container" class="auth-container">
        <div class="auth-box">
            <div class="auth-logo">
                <img src="https://admin.supremeenterpeises.com/img/2.png" alt="Supreme Enterprises Logo">
            </div>
            <h2 class="auth-title">Admin Login</h2>
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Enter your password">
                </div>
                <button type="submit">Login</button>
            </form>
            <div class="auth-footer">
                <p>Restricted access for authorized personnel only</p>
            </div>
        </div>
    </div>
    
    <!-- Admin Dashboard (Initially Hidden) -->
    <div id="admin-dashboard" class="container" style="display: none;">
        <div class="dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Invoice System</h1>
                <img src="https://admin.supremeenterpeises.com/img/2.png" alt="Supreme Enterprises Logo" class="dashboard-logo">
                <div class="dashboard-user">
                    <img id="user-photo" src="https://admin.supremeenterpeises.com/img/2.png" alt="User Photo">
                    <span id="user-name">Admin</span>
                    <button id="logout-btn" class="dashboard-logout">Logout</button>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="openTab('invoice-tab')">Invoice Details</div>
                <div class="tab" onclick="openTab('history-tab')">Invoice History</div>
                <div class="tab" onclick="openTab('clients-tab')">Clients Management</div>
                <div class="tab" onclick="openTab('settings-tab')">Settings</div>
            </div>
            
            <!-- Form Section -->
            <div id="invoice-tab" class="tab-content active">
                <div class="form-section">
                    <h2>Invoice Details</h2>
                    
                    <div class="grid-container">
                        <div class="form-group">
                            <label>Invoice No.</label>
                            <input type="text" id="invoiceNo" placeholder="e.g., INV-2023-001">
                        </div>
                        <div class="form-group">
                            <label>Invoice Date</label>
                            <input type="date" id="invoiceDate">
                        </div>
                        <div class="form-group">
                            <label>Due Date</label>
                            <input type="date" id="dueDate">
                        </div>
                        <div class="form-group">
                            <label>Reference No.</label>
                            <input type="text" id="referenceNo" placeholder="Reference number">
                        </div>
                    </div>
                    
                    <h3>From (Seller)</h3>
                    <div class="grid-container">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="sellerName" value="SUPREME ENTERPRISES">
                        </div>
                        <div class="form-group">
                            <label>GSTIN</label>
                            <input type="text" id="sellerGST" placeholder="Seller GSTIN">
                        </div>
                        <div class="form-group">
                            <label>State Code</label>
                            <input type="text" id="sellerStateCode" placeholder="State Code">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="sellerAddress" rows="3" placeholder="Seller Address"></textarea>
                    </div>
                    
                    <h3>Bill To</h3>
                    <div class="grid-container">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="billToName" placeholder="Customer Name">
                        </div>
                        <div class="form-group">
                            <label>GSTIN</label>
                            <input type="text" id="billToGST" placeholder="Customer GSTIN">
                        </div>
                        <div class="form-group">
                            <label>State Code</label>
                            <input type="text" id="billToStateCode" placeholder="State Code">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea id="billToAddress" rows="3" placeholder="Customer Address"></textarea>
                    </div>
                    
                    <h3>Ship To</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="sameAsBillTo" onchange="toggleShipTo()"> Same as Bill To
                        </label>
                    </div>
                    <div id="shipToFields">
                        <div class="grid-container">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" id="shipToName" placeholder="Shipping Name">
                            </div>
                            <div class="form-group">
                                <label>GSTIN</label>
                                <input type="text" id="shipToGST" placeholder="Shipping GSTIN">
                            </div>
                            <div class="form-group">
                                <label>State Code</label>
                                <input type="text" id="shipToStateCode" placeholder="State Code">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <textarea id="shipToAddress" rows="3" placeholder="Shipping Address"></textarea>
                        </div>
                    </div>
                    
                    <h3>Dispatch Details</h3>
                    <div class="grid-container">
                        <div class="form-group">
                            <label>Transport Mode</label>
                            <input type="text" id="transportMode" placeholder="e.g., Road, Air, etc.">
                        </div>
                        <div class="form-group">
                            <label>Vehicle No.</label>
                            <input type="text" id="vehicleNo" placeholder="Vehicle Number">
                        </div>
                        <div class="form-group">
                            <label>eWay Bill No.</label>
                            <input type="text" id="ewayBillNo" placeholder="eWay Bill Number">
                        </div>
                    </div>
                    
                    <h3>Items</h3>
                    <table id="itemsTable">
                        <thead>
                            <tr>
                                <th width="5%">#</th>
                                <th width="25%">Product</th>
                                <th width="10%">HSN Code</th>
                                <th width="10%">GST %</th>
                                <th width="10%">Qty</th>
                                <th width="10%">Rate</th>
                                <th width="10%">Taxable</th>
                                <th width="10%">CGST</th>
                                <th width="10%">SGST</th>
                                <th width="10%">Amount</th>
                                <th width="5%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            <!-- Items will be added here -->
                        </tbody>
                    </table>
                    <button onclick="addItem()"><i class="fas fa-plus"></i> Add Item</button>
                    
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea id="notes" rows="2" placeholder="Additional notes">E. & O.E</textarea>
                    </div>
                    
                    <button onclick="generateInvoice()" class="btn-success"><i class="fas fa-file-invoice"></i> Generate Invoice</button>
                    <button onclick="saveInvoice()" class="btn-success"><i class="fas fa-save"></i> Save Invoice</button>
                    <button onclick="clearForm()" class="btn-danger"><i class="fas fa-trash"></i> Clear Form</button>
                </div>
                
                <!-- Invoice Preview -->
                <div class="invoice-preview">
                    <h2>Invoice Preview</h2>
                    <div id="invoicePreview" class="page">
                        <!-- Invoice will be rendered here -->
                    </div>
                    <div class="no-print">
                        <button onclick="printInvoice()"><i class="fas fa-print"></i> Print</button>
                        <button onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export to PDF</button>
                    </div>
                </div>
            </div>
            
            <!-- Invoice History -->
            <div id="history-tab" class="tab-content">
                <div class="challan-history">
                    <h2>Invoice History</h2>
                    <div id="historyList">
                        <!-- Saved invoices will appear here -->
                    </div>
                </div>
            </div>

            <!-- Clients Management -->
            <div id="clients-tab" class="tab-content">
                <div class="client-form">
                    <h2>Add New Client</h2>
                    <div class="grid-container">
                        <div class="form-group">
                            <label>Client Name</label>
                            <input type="text" id="clientName" placeholder="Client Name">
                        </div>
                        <div class="form-group">
                            <label>Contact Person</label>
                            <input type="text" id="clientContact" placeholder="Contact Person">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="clientEmail" placeholder="Email">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="clientPhone" placeholder="Phone">
                        </div>
                        <div class="form-group">
                            <label>GSTIN</label>
                            <input type="text" id="clientGST" placeholder="GSTIN">
                        </div>
                        <div class="form-group">
                            <label>State Code</label>
                            <input type="text" id="clientStateCode" placeholder="State Code">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Billing Address</label>
                        <textarea id="clientBillingAddress" rows="3" placeholder="Billing Address"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Shipping Address</label>
                        <textarea id="clientShippingAddress" rows="3" placeholder="Shipping Address"></textarea>
                    </div>
                    <button onclick="saveClient()" class="btn-success"><i class="fas fa-save"></i> Save Client</button>
                    <button onclick="clearClientForm()" class="btn-danger"><i class="fas fa-trash"></i> Clear Form</button>
                </div>

                <div class="client-list">
                    <h2>Client List</h2>
                    <div class="form-group">
                        <input type="text" id="clientSearch" placeholder="Search clients..." oninput="searchClients()">
                    </div>
                    <div id="clientsList">
                        <!-- Client list will appear here -->
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="settings-section">
                    <h2>Company Settings</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Company Name</label>
                            <input type="text" id="companyName" value="SUPREME ENTERPRISES">
                        </div>
                        <div class="form-group">
                            <label>GSTIN</label>
                            <input type="text" id="companyGST" placeholder="Company GSTIN">
                        </div>
                        <div class="form-group">
                            <label>State Code</label>
                            <input type="text" id="companyStateCode" placeholder="State Code">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Company Address</label>
                        <textarea id="companyAddress" rows="3" placeholder="Company Address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="companyPhone" placeholder="Phone">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="companyEmail" placeholder="Email">
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" id="companyWebsite" placeholder="Website">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Signature Image URL</label>
                        <input type="text" id="signatureImageUrl" placeholder="https://example.com/signature.png">
                        <small>Upload your signature image to a hosting service and paste the URL here</small>
                    </div>
                    <button onclick="saveCompanySettings()" class="btn-success"><i class="fas fa-save"></i> Save Settings</button>
                </div>

                <div class="settings-section">
                    <h3>Invoice Settings</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Invoice Prefix</label>
                            <input type="text" id="invoicePrefix" value="INV">
                        </div>
                        <div class="form-group">
                            <label>Next Invoice Number</label>
                            <input type="number" id="nextInvoiceNumber" value="1001">
                        </div>
                        <div class="form-group">
                            <label>Default Due Days</label>
                            <input type="number" id="defaultDueDays" value="30">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Default Notes</label>
                        <textarea id="defaultNotes" rows="2">E. & O.E</textarea>
                    </div>
                    <button onclick="saveInvoiceSettings()" class="btn-success"><i class="fas fa-save"></i> Save Settings</button>
                </div>

                <div class="settings-section">
                    <h3>Product Management</h3>
                    <div class="form-group">
                        <label>Add New Product</label>
                        <div class="form-row">
                            <div class="form-group">
                                <input type="text" id="newProductName" placeholder="Product Name">
                            </div>
                            <div class="form-group">
                                <input type="text" id="newProductHSN" placeholder="HSN Code">
                            </div>
                            <div class="form-group">
                                <input type="number" id="newProductGST" placeholder="GST %">
                            </div>
                        </div>
                        <div class="form-group">
                            <textarea id="newProductDescription" rows="2" placeholder="Product Description"></textarea>
                        </div>
                        <button onclick="addNewProduct()" class="btn-success"><i class="fas fa-plus"></i> Add Product</button>
                    </div>
                    <div id="productsList">
                        <!-- Product list will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Customer View (Initially Hidden) -->
    <div id="customer-view" class="customer-view" style="display: none;">
        <div id="customer-invoice-preview" class="page">
            <!-- Invoice will be rendered here -->
        </div>
        <div class="customer-actions no-print">
            <button onclick="window.print()"><i class="fas fa-print"></i> Print</button>
            <button onclick="downloadAsPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBzl1R3xsNUKQ9wO3DX8nHt3O0NkI6Cc_E",
            authDomain: "cola-d7685.firebaseapp.com",
            projectId: "cola-d7685",
            storageBucket: "cola-d7685.appspot.com",
            messagingSenderId: "206120855200",
            appId: "1:206120855200:web:d88691337ce6a1b2dd4bc5",
            measurementId: "G-W3VMM4VNM1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Product database with HSN codes and GST rates
        let products = [
            { id: 1, name: "Campa Cola - 200ml", hsn: "22021010", gst: 28, description: "Flavoured sweetened aerated beverage" },
            { id: 2, name: "Power Up - 200ml", hsn: "22021010", gst: 28, description: "Flavoured sweetened aerated beverage" },
            { id: 3, name: "Orange - 200ml", hsn: "22021010", gst: 28, description: "Flavoured sweetened aerated beverage" },
            { id: 4, name: "Campa Soda - 500ml", hsn: "22011020", gst: 18, description: "Aerated water (not sweetened/flavoured)" },
            { id: 5, name: "Campa Cola - 500ml", hsn: "22021010", gst: 28, description: "Flavoured sweetened aerated beverage" },
            { id: 6, name: "Orange - 500ml", hsn: "22021010", gst: 28, description: "Flavoured sweetened aerated beverage" },
            { id: 7, name: "Gold Boost Tin", hsn: "22021090", gst: 28, description: "Energy drink (flavoured/sweetened beverage not under fruit juice)" },
            { id: 8, name: "Berry Kick - 200ml", hsn: "22021090", gst: 28, description: "Energy drink (flavoured/sweetened)" },
            { id: 9, name: "Lemon - 200ml", hsn: "22021010", gst: 28, description: "Flavoured aerated beverage" },
            { id: 10, name: "Raskik Tetra Mango - 125ml", hsn: "22029920", gst: 12, description: "Fruit juice–based drink (tetra pack)" },
            { id: 11, name: "Raskik Mango - 150ml", hsn: "22029920", gst: 12, description: "Fruit juice–based drink" },
            { id: 12, name: "Raskik Nimbu Pani - 150ml", hsn: "22029920", gst: 12, description: "Fruit juice–based drink" },
            { id: 13, name: "Raskik Apple Drink - 150ml", hsn: "22029920", gst: 12, description: "Fruit juice–based drink" },
            { id: 14, name: "Raskik Mixed Fruit - 150ml", hsn: "22029920", gst: 12, description: "Fruit juice–based drink" },
            { id: 15, name: "Raskik Glucose - 150ml", hsn: "22029920", gst: 12, description: "Fruit juice–based drink (glucose added)" },
            { id: 16, name: "Spinner Lemon - 150ml", hsn: "22029100", gst: 18, description: "Other non-alcoholic beverages (non-coconut water)" },
            { id: 17, name: "Spinner Orange - 150ml", hsn: "22029100", gst: 18, description: "Other non-alcoholic beverages (non-coconut water)" },
            { id: 18, name: "Spinner Nitro - 150ml", hsn: "22029100", gst: 18, description: "Other non-alcoholic beverages (non-coconut water)" },
            { id: 19, name: "Independence Water - 750ml", hsn: "22011010", gst: 18, description: "Mineral/Aerated water (unflavoured & unsweetened)" }
        ];
        
        // Check authentication state on page load
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                if (user.email === 'admin@supremeenterpeises.com') {
                    // Show admin dashboard
                    showAdminDashboard(user);
                } else {
                    // Not authorized - sign out
                    auth.signOut();
                    showToast('Only admin@supremeenterpeises is authorized to access this system', true);
                }
            } else {
                // User is signed out
                showAuthContainer();
            }
            
            // Check if we're viewing a shared invoice
            checkSharedInvoice();
        });
        
        // Login form submission
        document.getElementById('login-form').addEventListener('submit', e => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    // Login successful
                    showToast('Login successful!');
                })
                .catch(error => {
                    // Login failed
                    showToast(error.message, true);
                });
        });
        
        // Logout button
        document.getElementById('logout-btn').addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    showToast('Logged out successfully');
                })
                .catch(error => {
                    showToast(error.message, true);
                });
        });
        
        // Show auth container
        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('customer-view').style.display = 'none';
        }
        
        // Show admin dashboard
        function showAdminDashboard(user) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            document.getElementById('customer-view').style.display = 'none';
            
            // Set user info
            document.getElementById('user-name').textContent = user.email;
            if (user.photoURL) {
                document.getElementById('user-photo').src = user.photoURL;
            }
            
            // Initialize form
            initInvoiceForm();
            loadHistory();
            loadClients();
            loadSettings();
            loadProducts();
        }
        
        // Show customer view
        function showCustomerView(invoice) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('customer-view').style.display = 'block';
            
            // Display invoice
            displayInvoiceForCustomer(invoice);
        }
        
        // Initialize invoice form
        function initInvoiceForm() {
            // Set default values
            document.getElementById('invoiceNo').value = 'INV-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('invoiceDate').valueAsDate = new Date();
            
            // Set due date to 30 days from now
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').valueAsDate = dueDate;
            
            // Add 3 empty items by default
            addItem();
            addItem();
            addItem();
            
            generateInvoice();
        }
        
        // Show toast notification
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = isError ? 'toast error show' : 'toast show';
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // Tab navigation
        function openTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Activate the selected tab
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // Toggle ship to address
        function toggleShipTo() {
            const sameAsBillTo = document.getElementById('sameAsBillTo').checked;
            const shipToFields = document.getElementById('shipToFields');
            
            if (sameAsBillTo) {
                shipToFields.style.display = 'none';
            } else {
                shipToFields.style.display = 'block';
            }
        }
        
        // Add a new item row
        function addItem(product = null) {
            const tbody = document.getElementById('itemsBody');
            const row = document.createElement('tr');
            
            if (product) {
                row.innerHTML = `
                    <td>${tbody.children.length + 1}</td>
                    <td>
                        <div class="product-autocomplete">
                            <input type="text" class="item-name" value="${product.name}" oninput="searchProducts(this)" data-product-id="${product.id}">
                            <div class="autocomplete-results"></div>
                        </div>
                    </td>
                    <td><input type="text" class="item-hsn" value="${product.hsn}" readonly></td>
                    <td><input type="number" class="item-gst" value="${product.gst}" readonly></td>
                    <td><input type="number" class="item-qty" placeholder="Qty" value="1" min="1" onchange="calculateRow(this)"></td>
                    <td><input type="number" class="item-rate" placeholder="Rate" value="0" min="0" step="0.01" onchange="calculateRow(this)"></td>
                    <td class="item-taxable">0.00</td>
                    <td class="item-cgst">0.00</td>
                    <td class="item-sgst">0.00</td>
                    <td class="item-amount">0.00</td>
                    <td><button onclick="removeItem(this)" class="btn-danger"><i class="fas fa-trash"></i></button></td>
                `;
            } else {
                row.innerHTML = `
                    <td>${tbody.children.length + 1}</td>
                    <td>
                        <div class="product-autocomplete">
                            <input type="text" class="item-name" placeholder="Product Name" oninput="searchProducts(this)">
                            <div class="autocomplete-results"></div>
                        </div>
                    </td>
                    <td><input type="text" class="item-hsn" placeholder="HSN" readonly></td>
                    <td><input type="number" class="item-gst" placeholder="GST %" readonly></td>
                    <td><input type="number" class="item-qty" placeholder="Qty" value="1" min="1" onchange="calculateRow(this)"></td>
                    <td><input type="number" class="item-rate" placeholder="Rate" value="0" min="0" step="0.01" onchange="calculateRow(this)"></td>
                    <td class="item-taxable">0.00</td>
                    <td class="item-cgst">0.00</td>
                    <td class="item-sgst">0.00</td>
                    <td class="item-amount">0.00</td>
                    <td><button onclick="removeItem(this)" class="btn-danger"><i class="fas fa-trash"></i></button></td>
                `;
            }
            
            tbody.appendChild(row);
            
            // Initialize autocomplete for the new row
            if (!product) {
                const input = row.querySelector('.item-name');
                searchProducts(input);
            }
        }
        
        // Search products for autocomplete
        function searchProducts(input) {
            const searchTerm = input.value.toLowerCase();
            const resultsContainer = input.parentNode.querySelector('.autocomplete-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredProducts = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) || 
                product.hsn.includes(searchTerm)
            );
            
            if (filteredProducts.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            resultsContainer.innerHTML = filteredProducts.map(product => `
                <div class="autocomplete-item" 
                     data-id="${product.id}"
                     data-name="${product.name}"
                     data-hsn="${product.hsn}"
                     data-gst="${product.gst}"
                     onclick="selectProduct(this, '${input.id}')">
                    <strong>${product.name}</strong><br>
                    <small>HSN: ${product.hsn} | GST: ${product.gst}% | ${product.description}</small>
                </div>
            `).join('');
            
            resultsContainer.style.display = 'block';
        }
        
        // Select product from autocomplete
        function selectProduct(item, inputId) {
            const product = {
                id: item.getAttribute('data-id'),
                name: item.getAttribute('data-name'),
                hsn: item.getAttribute('data-hsn'),
                gst: item.getAttribute('data-gst')
            };
            
            const row = item.closest('tr') || document.querySelector(`#${inputId}`).closest('tr');
            
            row.querySelector('.item-name').value = product.name;
            row.querySelector('.item-hsn').value = product.hsn;
            row.querySelector('.item-gst').value = product.gst;
            row.querySelector('.item-name').setAttribute('data-product-id', product.id);
            
            // Hide results
            item.closest('.autocomplete-results').style.display = 'none';
            
            // Focus on quantity
            row.querySelector('.item-qty').focus();
        }
        
        // Remove an item row
        function removeItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateItemNumbers();
            calculateTotals();
        }
        
        // Update item numbers sequentially
        function updateItemNumbers() {
            const rows = document.querySelectorAll('#itemsBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }
        
        // Calculate row amounts
        function calculateRow(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
            const gst = parseFloat(row.querySelector('.item-gst').value) || 0;
            
            const taxable = qty * rate;
            const cgst = taxable * (gst / 200); // Divided by 200 because 14% of taxable is 28%/2
            const sgst = cgst; // Same as CGST
            const amount = taxable + cgst + sgst;
            
            row.querySelector('.item-taxable').textContent = taxable.toFixed(2);
            row.querySelector('.item-cgst').textContent = cgst.toFixed(2);
            row.querySelector('.item-sgst').textContent = sgst.toFixed(2);
            row.querySelector('.item-amount').textContent = amount.toFixed(2);
            
            calculateTotals();
        }
        
        // Calculate invoice totals
        function calculateTotals() {
            let taxableTotal = 0;
            let cgstTotal = 0;
            let sgstTotal = 0;
            let amountTotal = 0;
            
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                taxableTotal += parseFloat(row.querySelector('.item-taxable').textContent) || 0;
                cgstTotal += parseFloat(row.querySelector('.item-cgst').textContent) || 0;
                sgstTotal += parseFloat(row.querySelector('.item-sgst').textContent) || 0;
                amountTotal += parseFloat(row.querySelector('.item-amount').textContent) || 0;
            });
            
            return {
                taxable: taxableTotal,
                cgst: cgstTotal,
                sgst: sgstTotal,
                total: amountTotal
            };
        }
        
        // Generate invoice preview
        function generateInvoice() {
            const invoiceNo = document.getElementById('invoiceNo').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const referenceNo = document.getElementById('referenceNo').value;
            
            const sellerName = document.getElementById('sellerName').value;
            const sellerAddress = document.getElementById('sellerAddress').value;
            const sellerGST = document.getElementById('sellerGST').value;
            const sellerStateCode = document.getElementById('sellerStateCode').value;
            
            const billToName = document.getElementById('billToName').value;
            const billToAddress = document.getElementById('billToAddress').value;
            const billToGST = document.getElementById('billToGST').value;
            const billToStateCode = document.getElementById('billToStateCode').value;
            
            const sameAsBillTo = document.getElementById('sameAsBillTo').checked;
            const shipToName = sameAsBillTo ? billToName : document.getElementById('shipToName').value;
            const shipToAddress = sameAsBillTo ? billToAddress : document.getElementById('shipToAddress').value;
            const shipToGST = sameAsBillTo ? billToGST : document.getElementById('shipToGST').value;
            const shipToStateCode = sameAsBillTo ? billToStateCode : document.getElementById('shipToStateCode').value;
            
            const transportMode = document.getElementById('transportMode').value;
            const vehicleNo = document.getElementById('vehicleNo').value;
            const ewayBillNo = document.getElementById('ewayBillNo').value;
            
            const notes = document.getElementById('notes').value;
            
            // Get signature image from settings
            const signatureImageUrl = document.getElementById('signatureImageUrl').value;
            
            // Get items
            const items = [];
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                items.push({
                    name: row.querySelector('.item-name').value,
                    hsn: row.querySelector('.item-hsn').value,
                    gst: row.querySelector('.item-gst').value,
                    qty: row.querySelector('.item-qty').value,
                    rate: row.querySelector('.item-rate').value,
                    taxable: row.querySelector('.item-taxable').textContent,
                    cgst: row.querySelector('.item-cgst').textContent,
                    sgst: row.querySelector('.item-sgst').textContent,
                    amount: row.querySelector('.item-amount').textContent
                });
            });
            
            const totals = calculateTotals();
            
            // Generate HTML for invoice
            const invoiceHTML = `
                <div class="invoice-header">
                    <div class="company-info">
                        <div class="company-name">${sellerName}</div>
                        <div>${sellerAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${sellerGST} | State Code: ${sellerStateCode}</div>
                    </div>
                    <div>
                        <div class="invoice-number">Invoice No: ${invoiceNo}</div>
                        <div class="invoice-date">Date: ${new Date(invoiceDate).toLocaleDateString()}</div>
                        <div>Due Date: ${new Date(dueDate).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <div class="invoice-title">TAX INVOICE</div>
                
                <div class="address-block">
                    <div class="from-address">
                        <div class="address-title">From</div>
                        <div><strong>${sellerName}</strong></div>
                        <div>${sellerAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${sellerGST}</div>
                        <div>State Code: ${sellerStateCode}</div>
                    </div>
                    <div class="bill-to-address">
                        <div class="address-title">Bill To</div>
                        <div><strong>${billToName}</strong></div>
                        <div>${billToAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${billToGST}</div>
                        <div>State Code: ${billToStateCode}</div>
                    </div>
                    <div class="ship-to-address">
                        <div class="address-title">Ship To</div>
                        <div><strong>${shipToName}</strong></div>
                        <div>${shipToAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${shipToGST}</div>
                        <div>State Code: ${shipToStateCode}</div>
                    </div>
                </div>
                
                <div class="invoice-meta">
                    <div><strong>Transport Mode:</strong> ${transportMode}</div>
                    <div><strong>Vehicle No:</strong> ${vehicleNo}</div>
                    <div><strong>eWay Bill No:</strong> ${ewayBillNo}</div>
                </div>
                
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Description of Goods</th>
                            <th>HSN Code</th>
                            <th>GST %</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Taxable Value</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => `
                            <tr>
                                <td class="text-center">${index + 1}</td>
                                <td>${item.name}</td>
                                <td class="text-center">${item.hsn}</td>
                                <td class="text-center">${item.gst}%</td>
                                <td class="text-center">${item.qty}</td>
                                <td class="text-right">${parseFloat(item.rate).toFixed(2)}</td>
                                <td class="text-right">${item.taxable}</td>
                                <td class="text-right">${item.cgst}</td>
                                <td class="text-right">${item.sgst}</td>
                                <td class="text-right">${item.amount}</td>
                            </tr>
                        `).join('')}
                        <tr class="total-row">
                            <td colspan="6" class="text-right"><strong>Total</strong></td>
                            <td class="text-right">${totals.taxable.toFixed(2)}</td>
                            <td class="text-right">${totals.cgst.toFixed(2)}</td>
                            <td class="text-right">${totals.sgst.toFixed(2)}</td>
                            <td class="text-right">${totals.total.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="tax-details">
                    <table>
                        <tr>
                            <td><strong>Total Taxable Amount:</strong></td>
                            <td class="text-right">${totals.taxable.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Total CGST:</strong></td>
                            <td class="text-right">${totals.cgst.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Total SGST:</strong></td>
                            <td class="text-right">${totals.sgst.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Invoice Total:</strong></td>
                            <td class="text-right">${totals.total.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="amount-in-words">
                    <strong>Amount in Words:</strong> ${numberToWords(totals.total)} Rupees Only
                </div>
                
                <div class="signature-area">
                    <div class="signature">
                        ${signatureImageUrl ? `<img src="${signatureImageUrl}" alt="Signature" class="signature-image">` : ''}
                        <div class="signature-line"></div>
                        <div>Authorized Signatory</div>
                    </div>
                </div>
                
                <div class="footer">
                    <div>${notes}</div>
                    <div>Thank you for your business!</div>
                </div>
            `;
            
            document.getElementById('invoicePreview').innerHTML = invoiceHTML;
        }
        
        // Convert number to words
        function numberToWords(num) {
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 
                          'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 
                          'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            
            function convertLessThanOneThousand(n) {
                if (n === 0) return '';
                if (n < 20) return ones[n];
                if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
                return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' and ' + convertLessThanOneThousand(n % 100) : '');
            }
            
            if (num === 0) return 'Zero';
            let result = '';
            const numStr = num.toString().split('.');
            const wholeNum = parseInt(numStr[0]);
            const decimalNum = numStr.length > 1 ? parseInt(numStr[1]) : 0;
            
            if (wholeNum >= 10000000) {
                result += convertLessThanOneThousand(Math.floor(wholeNum / 10000000)) + ' Crore ';
                wholeNum %= 10000000;
            }
            
            if (wholeNum >= 100000) {
                result += convertLessThanOneThousand(Math.floor(wholeNum / 100000)) + ' Lakh ';
                wholeNum %= 100000;
            }
            
            if (wholeNum >= 1000) {
                result += convertLessThanOneThousand(Math.floor(wholeNum / 1000)) + ' Thousand ';
                wholeNum %= 1000;
            }
            
            if (wholeNum > 0) {
                result += convertLessThanOneThousand(wholeNum);
            }
            
            if (decimalNum > 0) {
                result += ' and ' + convertLessThanOneThousand(decimalNum) + ' Paise';
            }
            
            return result.trim();
        }
        
        // Print invoice
        function printInvoice() {
            window.print();
        }
        
        // Export to PDF
        function exportToPDF() {
            const element = document.getElementById('invoicePreview');
            
            html2canvas(element, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('Invoice_' + document.getElementById('invoiceNo').value + '.pdf');
            });
        }
        
        // Save invoice to history and Firebase
        async function saveInvoice() {
            const invoiceData = {
                id: Date.now().toString(),
                invoiceNo: document.getElementById('invoiceNo').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                referenceNo: document.getElementById('referenceNo').value,
                sellerName: document.getElementById('sellerName').value,
                sellerAddress: document.getElementById('sellerAddress').value,
                sellerGST: document.getElementById('sellerGST').value,
                sellerStateCode: document.getElementById('sellerStateCode').value,
                billToName: document.getElementById('billToName').value,
                billToAddress: document.getElementById('billToAddress').value,
                billToGST: document.getElementById('billToGST').value,
                billToStateCode: document.getElementById('billToStateCode').value,
                sameAsBillTo: document.getElementById('sameAsBillTo').checked,
                shipToName: document.getElementById('shipToName').value,
                shipToAddress: document.getElementById('shipToAddress').value,
                shipToGST: document.getElementById('shipToGST').value,
                shipToStateCode: document.getElementById('shipToStateCode').value,
                transportMode: document.getElementById('transportMode').value,
                vehicleNo: document.getElementById('vehicleNo').value,
                ewayBillNo: document.getElementById('ewayBillNo').value,
                notes: document.getElementById('notes').value,
                signatureImageUrl: document.getElementById('signatureImageUrl').value,
                totalAmount: calculateTotals().total.toFixed(2),
                createdAt: new Date().toISOString(),
                items: []
            };
            
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                invoiceData.items.push({
                    name: row.querySelector('.item-name').value,
                    hsn: row.querySelector('.item-hsn').value,
                    gst: row.querySelector('.item-gst').value,
                    qty: row.querySelector('.item-qty').value,
                    rate: row.querySelector('.item-rate').value,
                    taxable: row.querySelector('.item-taxable').textContent,
                    cgst: row.querySelector('.item-cgst').textContent,
                    sgst: row.querySelector('.item-sgst').textContent,
                    amount: row.querySelector('.item-amount').textContent
                });
            });
            
            try {
                // Save to localStorage
                let history = JSON.parse(localStorage.getItem('invoiceHistory')) || [];
                history.unshift(invoiceData);
                localStorage.setItem('invoiceHistory', JSON.stringify(history));
                
                // Save to Firebase
                await db.collection('invoices').doc(invoiceData.id).set(invoiceData);
                
                // Generate shareable link
                // In the saveInvoice() function, replace the shareLink generation with:
                const shareLink = `https://admin.supremeenterpeises.com/c?invoice=${invoiceData.id}`;
                
                // Show success message with share link
                showToast('Invoice saved successfully!');
                
                // Add share options to UI
                const shareDiv = document.createElement('div');
                shareDiv.className = 'share-container';
                shareDiv.innerHTML = `
                    <h3>Share Invoice</h3>
                    <div class="share-link">
                        <input type="text" id="shareLink" value="${shareLink}" readonly>
                        <button onclick="copyShareLink()"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                    <div class="share-options">
                        <button class="btn-whatsapp" onclick="shareViaWhatsApp('${shareLink}')"><i class="fab fa-whatsapp"></i> Share via WhatsApp</button>
                        <button class="btn-email" onclick="shareViaEmail('${shareLink}')"><i class="fas fa-envelope"></i> Share via Email</button>
                    </div>
                `;
                
                const invoicePreview = document.querySelector('.invoice-preview');
                const existingShareLink = invoicePreview.querySelector('.share-container');
                if (existingShareLink) {
                    existingShareLink.replaceWith(shareDiv);
                } else {
                    invoicePreview.appendChild(shareDiv);
                }
                
                loadHistory();
            } catch (error) {
                console.error('Error saving invoice:', error);
                showToast('Error saving invoice!', true);
            }
        }
        
        // Copy share link to clipboard
        function copyShareLink() {
            const shareLink = document.getElementById('shareLink');
            shareLink.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard!');
        }
        
        // Share via WhatsApp
        function shareViaWhatsApp(link) {
            const message = `Please find your invoice here: ${link}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Share via Email
        function shareViaEmail(link) {
            const subject = 'Your Invoice from Supreme Enterprises';
            const body = `Dear Customer,\n\nPlease find your invoice here: ${link}\n\nThank you for your business!\n\nSupreme Enterprises`;
            const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;
        }
        
        // Load invoice history
        async function loadHistory() {
            try {
                // Load from localStorage
                let history = JSON.parse(localStorage.getItem('invoiceHistory')) || [];
                
                // Also load from Firebase
                const querySnapshot = await db.collection('invoices').orderBy('createdAt', 'desc').get();
                querySnapshot.forEach(doc => {
                    const invoice = doc.data();
                    // Only add if not already in local history
                    if (!history.find(i => i.id === invoice.id)) {
                        history.unshift(invoice);
                    }
                });
                
                const historyList = document.getElementById('historyList');
                
                if (history.length === 0) {
                    historyList.innerHTML = '<p>No saved invoices found.</p>';
                    return;
                }
                
                historyList.innerHTML = history.map(invoice => `
                    <div class="history-item">
                        <h3>${invoice.invoiceNo} - ${invoice.billToName}</h3>
                        <p><strong>Date:</strong> ${new Date(invoice.invoiceDate).toLocaleDateString()}</p>
                        <p><strong>Total Amount:</strong> ₹${invoice.totalAmount}</p>
                        <div class="history-actions">
                            <button onclick="loadInvoice('${invoice.id}')"><i class="fas fa-eye"></i> View</button>
                            <button onclick="deleteInvoice('${invoice.id}')" class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                            <button onclick="shareInvoice('${invoice.id}')" class="btn-success"><i class="fas fa-share"></i> Share</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading history:', error);
                showToast('Error loading invoice history!', true);
            }
        }
        
        // Load invoice from history
        function loadInvoice(id) {
            // First check localStorage
            let history = JSON.parse(localStorage.getItem('invoiceHistory')) || [];
            let invoice = history.find(inv => inv.id === id);
            
            if (!invoice) {
                // If not found in localStorage, try Firebase
                db.collection('invoices').doc(id).get().then(doc => {
                    if (doc.exists) {
                        invoice = doc.data();
                        displayInvoice(invoice);
                    } else {
                        showToast('Invoice not found!', true);
                    }
                }).catch(error => {
                    console.error('Error loading invoice:', error);
                    showToast('Error loading invoice!', true);
                });
            } else {
                displayInvoice(invoice);
            }
        }
        
        // Display invoice data in form
        function displayInvoice(invoice) {
            // Open the invoice tab
            openTab('invoice-tab');
            
            // Load basic info
            document.getElementById('invoiceNo').value = invoice.invoiceNo;
            document.getElementById('invoiceDate').value = invoice.invoiceDate;
            document.getElementById('dueDate').value = invoice.dueDate;
            document.getElementById('referenceNo').value = invoice.referenceNo || '';
            
            // Seller info
            document.getElementById('sellerName').value = invoice.sellerName;
            document.getElementById('sellerAddress').value = invoice.sellerAddress;
            document.getElementById('sellerGST').value = invoice.sellerGST;
            document.getElementById('sellerStateCode').value = invoice.sellerStateCode;
            
            // Bill To info
            document.getElementById('billToName').value = invoice.billToName;
            document.getElementById('billToAddress').value = invoice.billToAddress;
            document.getElementById('billToGST').value = invoice.billToGST;
            document.getElementById('billToStateCode').value = invoice.billToStateCode;
            
            // Ship To info
            document.getElementById('sameAsBillTo').checked = invoice.sameAsBillTo;
            toggleShipTo();
            
            if (!invoice.sameAsBillTo) {
                document.getElementById('shipToName').value = invoice.shipToName;
                document.getElementById('shipToAddress').value = invoice.shipToAddress;
                document.getElementById('shipToGST').value = invoice.shipToGST;
                document.getElementById('shipToStateCode').value = invoice.shipToStateCode;
            }
            
            // Dispatch info
            document.getElementById('transportMode').value = invoice.transportMode || '';
            document.getElementById('vehicleNo').value = invoice.vehicleNo || '';
            document.getElementById('ewayBillNo').value = invoice.ewayBillNo || '';
            
            // Notes
            document.getElementById('notes').value = invoice.notes || 'E. & O.E';
            
            // Signature image
            document.getElementById('signatureImageUrl').value = invoice.signatureImageUrl || '';
            
            // Clear existing items
            document.getElementById('itemsBody').innerHTML = '';
            
            // Add items
            invoice.items.forEach(item => {
                addItem();
                const rows = document.querySelectorAll('#itemsBody tr');
                const lastRow = rows[rows.length - 1];
                
                lastRow.querySelector('.item-name').value = item.name;
                lastRow.querySelector('.item-hsn').value = item.hsn;
                lastRow.querySelector('.item-gst').value = item.gst;
                lastRow.querySelector('.item-qty').value = item.qty;
                lastRow.querySelector('.item-rate').value = item.rate;
                
                // Trigger calculation
                calculateRow(lastRow.querySelector('.item-rate'));
            });
            
            // Generate preview
            generateInvoice();
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        // Display invoice for customer view
        function displayInvoiceForCustomer(invoice) {
            const totals = {
                taxable: invoice.items.reduce((sum, item) => sum + parseFloat(item.taxable), 0),
                cgst: invoice.items.reduce((sum, item) => sum + parseFloat(item.cgst), 0),
                sgst: invoice.items.reduce((sum, item) => sum + parseFloat(item.sgst), 0),
                total: invoice.items.reduce((sum, item) => sum + parseFloat(item.amount), 0)
            };
            
            const invoiceHTML = `
                <div class="invoice-header">
                    <div class="company-info">
                        <div class="company-name">${invoice.sellerName}</div>
                        <div>${invoice.sellerAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${invoice.sellerGST} | State Code: ${invoice.sellerStateCode}</div>
                    </div>
                    <div>
                        <div class="invoice-number">Invoice No: ${invoice.invoiceNo}</div>
                        <div class="invoice-date">Date: ${new Date(invoice.invoiceDate).toLocaleDateString()}</div>
                        <div>Due Date: ${new Date(invoice.dueDate).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <div class="invoice-title">TAX INVOICE</div>
                
                <div class="address-block">
                    <div class="from-address">
                        <div class="address-title">From</div>
                        <div><strong>${invoice.sellerName}</strong></div>
                        <div>${invoice.sellerAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${invoice.sellerGST}</div>
                        <div>State Code: ${invoice.sellerStateCode}</div>
                    </div>
                    <div class="bill-to-address">
                        <div class="address-title">Bill To</div>
                        <div><strong>${invoice.billToName}</strong></div>
                        <div>${invoice.billToAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${invoice.billToGST}</div>
                        <div>State Code: ${invoice.billToStateCode}</div>
                    </div>
                    <div class="ship-to-address">
                        <div class="address-title">Ship To</div>
                        <div><strong>${invoice.shipToName}</strong></div>
                        <div>${invoice.shipToAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN: ${invoice.shipToGST}</div>
                        <div>State Code: ${invoice.shipToStateCode}</div>
                    </div>
                </div>
                
                <div class="invoice-meta">
                    <div><strong>Transport Mode:</strong> ${invoice.transportMode || ''}</div>
                    <div><strong>Vehicle No:</strong> ${invoice.vehicleNo || ''}</div>
                    <div><strong>eWay Bill No:</strong> ${invoice.ewayBillNo || ''}</div>
                </div>
                
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Description of Goods</th>
                            <th>HSN Code</th>
                            <th>GST %</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Taxable Value</th>
                            <th>CGST</th>
                            <th>SGST</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoice.items.map((item, index) => `
                            <tr>
                                <td class="text-center">${index + 1}</td>
                                <td>${item.name}</td>
                                <td class="text-center">${item.hsn}</td>
                                <td class="text-center">${item.gst}%</td>
                                <td class="text-center">${item.qty}</td>
                                <td class="text-right">${parseFloat(item.rate).toFixed(2)}</td>
                                <td class="text-right">${item.taxable}</td>
                                <td class="text-right">${item.cgst}</td>
                                <td class="text-right">${item.sgst}</td>
                                <td class="text-right">${item.amount}</td>
                            </tr>
                        `).join('')}
                        <tr class="total-row">
                            <td colspan="6" class="text-right"><strong>Total</strong></td>
                            <td class="text-right">${totals.taxable.toFixed(2)}</td>
                            <td class="text-right">${totals.cgst.toFixed(2)}</td>
                            <td class="text-right">${totals.sgst.toFixed(2)}</td>
                            <td class="text-right">${totals.total.toFixed(2)}</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="tax-details">
                    <table>
                        <tr>
                            <td><strong>Total Taxable Amount:</strong></td>
                            <td class="text-right">${totals.taxable.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Total CGST:</strong></td>
                            <td class="text-right">${totals.cgst.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Total SGST:</strong></td>
                            <td class="text-right">${totals.sgst.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td><strong>Invoice Total:</strong></td>
                            <td class="text-right">${totals.total.toFixed(2)}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="amount-in-words">
                    <strong>Amount in Words:</strong> ${numberToWords(totals.total)} Rupees Only
                </div>
                
                <div class="signature-area">
                    <div class="signature">
                        ${invoice.signatureImageUrl ? `<img src="${invoice.signatureImageUrl}" alt="Signature" class="signature-image">` : ''}
                        <div class="signature-line"></div>
                        <div>Authorized Signatory</div>
                    </div>
                </div>
                
                <div class="footer">
                    <div>${invoice.notes || 'E. & O.E'}</div>
                    <div>Thank you for your business!</div>
                </div>
            `;
            
            document.getElementById('customer-invoice-preview').innerHTML = invoiceHTML;
        }
        
        // Download as PDF for customer view
        function downloadAsPDF() {
            const element = document.getElementById('customer-invoice-preview');
            
            html2canvas(element, {
                scale: 2,
                logging: false,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('Invoice.pdf');
            });
        }
        
        // Delete invoice from history and Firebase
        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this invoice?')) return;
            
            try {
                // Delete from localStorage
                let history = JSON.parse(localStorage.getItem('invoiceHistory')) || [];
                history = history.filter(inv => inv.id !== id);
                localStorage.setItem('invoiceHistory', JSON.stringify(history));
                
                // Delete from Firebase
                await db.collection('invoices').doc(id).delete();
                
                showToast('Invoice deleted successfully!');
                loadHistory();
            } catch (error) {
                console.error('Error deleting invoice:', error);
                showToast('Error deleting invoice!', true);
            }
        }
        
        // Share invoice by generating a shareable link
        function shareInvoice(id) {
            const shareLink = `${window.location.origin}${window.location.pathname}?invoice=${id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Invoice',
                    text: 'View this invoice',
                    url: shareLink
                }).catch(err => {
                    console.error('Error sharing:', err);
                    copyToClipboard(shareLink);
                });
            } else {
                copyToClipboard(shareLink);
            }
        }
        
        // Check if URL has invoice parameter to load shared invoice
        function checkSharedInvoice() {
            const urlParams = new URLSearchParams(window.location.search);
            const invoiceId = urlParams.get('invoice');
            
            if (invoiceId) {
                // Check if user is admin
                const user = auth.currentUser;
                if (user && user.email === 'admin@supremeenterpeises.com') {
                    // Admin viewing shared link - load in admin view
                    loadInvoice(invoiceId);
                } else {
                    // Customer viewing shared link - load in customer view
                    db.collection('invoices').doc(invoiceId).get().then(doc => {
                        if (doc.exists) {
                            showCustomerView(doc.data());
                        } else {
                            showToast('Invoice not found!', true);
                            showAuthContainer();
                        }
                    }).catch(error => {
                        console.error('Error loading invoice:', error);
                        showToast('Error loading invoice!', true);
                        showAuthContainer();
                    });
                }
            }
        }
        
        // Clear form
        function clearForm() {
            if (!confirm('Are you sure you want to clear the form? All unsaved data will be lost.')) return;
            
            // Reset form fields
            document.getElementById('invoiceNo').value = 'INV-' + new Date().getFullYear() + '-' + Math.floor(1000 + Math.random() * 9000);
            document.getElementById('invoiceDate').valueAsDate = new Date();
            
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').valueAsDate = dueDate;
            
            document.getElementById('referenceNo').value = '';
            document.getElementById('sellerName').value = 'SUPREME ENTERPRISES';
            document.getElementById('sellerGST').value = '';
            document.getElementById('sellerStateCode').value = '';
            document.getElementById('sellerAddress').value = '';
            document.getElementById('billToName').value = '';
            document.getElementById('billToGST').value = '';
            document.getElementById('billToStateCode').value = '';
            document.getElementById('billToAddress').value = '';
            document.getElementById('sameAsBillTo').checked = true;
            document.getElementById('shipToName').value = '';
            document.getElementById('shipToGST').value = '';
            document.getElementById('shipToStateCode').value = '';
            document.getElementById('shipToAddress').value = '';
            document.getElementById('transportMode').value = '';
            document.getElementById('vehicleNo').value = '';
            document.getElementById('ewayBillNo').value = '';
            document.getElementById('notes').value = 'E. & O.E';
            
            // Clear items and add 3 empty rows
            document.getElementById('itemsBody').innerHTML = '';
            addItem();
            addItem();
            addItem();
            
            // Generate empty preview
            generateInvoice();
        }

        // Client Management Functions
        function saveClient() {
            const clientData = {
                id: Date.now().toString(),
                name: document.getElementById('clientName').value,
                contact: document.getElementById('clientContact').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                gst: document.getElementById('clientGST').value,
                stateCode: document.getElementById('clientStateCode').value,
                billingAddress: document.getElementById('clientBillingAddress').value,
                shippingAddress: document.getElementById('clientShippingAddress').value,
                createdAt: new Date().toISOString()
            };

            if (!clientData.name) {
                showToast('Client name is required!', true);
                return;
            }

            try {
                // Save to localStorage
                let clients = JSON.parse(localStorage.getItem('clients')) || [];
                clients.unshift(clientData);
                localStorage.setItem('clients', JSON.stringify(clients));
                
                // Save to Firebase
                db.collection('clients').doc(clientData.id).set(clientData);
                
                showToast('Client saved successfully!');
                loadClients();
                clearClientForm();
            } catch (error) {
                console.error('Error saving client:', error);
                showToast('Error saving client!', true);
            }
        }

        async function loadClients() {
            try {
                // Load from localStorage
                let clients = JSON.parse(localStorage.getItem('clients')) || [];
                
                // Also load from Firebase
                const querySnapshot = await db.collection('clients').orderBy('createdAt', 'desc').get();
                querySnapshot.forEach(doc => {
                    const client = doc.data();
                    // Only add if not already in local clients
                    if (!clients.find(c => c.id === client.id)) {
                        clients.unshift(client);
                    }
                });
                
                const clientsList = document.getElementById('clientsList');

                if (clients.length === 0) {
                    clientsList.innerHTML = '<p>No clients found. Add your first client above.</p>';
                    return;
                }

                clientsList.innerHTML = clients.map(client => `
                    <div class="client-item">
                        <div class="client-info">
                            <h3>${client.name}</h3>
                            <p><strong>Contact:</strong> ${client.contact} | <strong>Phone:</strong> ${client.phone}</p>
                            <p><strong>GSTIN:</strong> ${client.gst} | <strong>State Code:</strong> ${client.stateCode}</p>
                        </div>
                        <div class="client-actions">
                            <button onclick="editClient('${client.id}')"><i class="fas fa-edit"></i> Edit</button>
                            <button onclick="deleteClient('${client.id}')" class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                            <button onclick="useClientForInvoice('${client.id}')" class="btn-success"><i class="fas fa-file-invoice"></i> Use for Invoice</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading clients:', error);
                showToast('Error loading clients!', true);
            }
        }

        function clearClientForm() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientContact').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientGST').value = '';
            document.getElementById('clientStateCode').value = '';
            document.getElementById('clientBillingAddress').value = '';
            document.getElementById('clientShippingAddress').value = '';
            
            // Reset save button if it was in update mode
            const saveBtn = document.querySelector('#clients-tab .btn-success');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Client';
            saveBtn.onclick = function() { saveClient(); };
        }

        function editClient(id) {
            // First check localStorage
            let clients = JSON.parse(localStorage.getItem('clients')) || [];
            let client = clients.find(c => c.id === id);
            
            if (!client) {
                // If not found in localStorage, try Firebase
                db.collection('clients').doc(id).get().then(doc => {
                    if (doc.exists) {
                        client = doc.data();
                        displayClientForm(client);
                    } else {
                        showToast('Client not found!', true);
                    }
                }).catch(error => {
                    console.error('Error loading client:', error);
                    showToast('Error loading client!', true);
                });
            } else {
                displayClientForm(client);
            }
        }
        
        function displayClientForm(client) {
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientContact').value = client.contact;
            document.getElementById('clientEmail').value = client.email;
            document.getElementById('clientPhone').value = client.phone;
            document.getElementById('clientGST').value = client.gst;
            document.getElementById('clientStateCode').value = client.stateCode;
            document.getElementById('clientBillingAddress').value = client.billingAddress;
            document.getElementById('clientShippingAddress').value = client.shippingAddress;

            // Store the current client ID for updating
            document.getElementById('clientName').dataset.clientId = client.id;

            // Change save button to update
            const saveBtn = document.querySelector('#clients-tab .btn-success');
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Update Client';
            saveBtn.onclick = function() { updateClient(client.id); };

            // Scroll to form
            document.querySelector('#clients-tab .client-form').scrollIntoView();
        }

        async function updateClient(id) {
            const clients = JSON.parse(localStorage.getItem('clients')) || [];
            const index = clients.findIndex(c => c.id === id);

            if (index === -1) {
                showToast('Client not found!', true);
                return;
            }

            const updatedClient = {
                id: id,
                name: document.getElementById('clientName').value,
                contact: document.getElementById('clientContact').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                gst: document.getElementById('clientGST').value,
                stateCode: document.getElementById('clientStateCode').value,
                billingAddress: document.getElementById('clientBillingAddress').value,
                shippingAddress: document.getElementById('clientShippingAddress').value,
                createdAt: clients[index].createdAt
            };

            try {
                // Update in localStorage
                clients[index] = updatedClient;
                localStorage.setItem('clients', JSON.stringify(clients));
                
                // Update in Firebase
                await db.collection('clients').doc(id).update(updatedClient);
                
                showToast('Client updated successfully!');
                loadClients();
                clearClientForm();
            } catch (error) {
                console.error('Error updating client:', error);
                showToast('Error updating client!', true);
            }
        }

        async function deleteClient(id) {
            if (!confirm('Are you sure you want to delete this client?')) return;

            try {
                // Delete from localStorage
                let clients = JSON.parse(localStorage.getItem('clients')) || [];
                clients = clients.filter(c => c.id !== id);
                localStorage.setItem('clients', JSON.stringify(clients));
                
                // Delete from Firebase
                await db.collection('clients').doc(id).delete();
                
                showToast('Client deleted successfully!');
                loadClients();
            } catch (error) {
                console.error('Error deleting client:', error);
                showToast('Error deleting client!', true);
            }
        }

        function useClientForInvoice(id) {
            // First check localStorage
            let clients = JSON.parse(localStorage.getItem('clients')) || [];
            let client = clients.find(c => c.id === id);
            
            if (!client) {
                // If not found in localStorage, try Firebase
                db.collection('clients').doc(id).get().then(doc => {
                    if (doc.exists) {
                        client = doc.data();
                        fillClientDetails(client);
                    } else {
                        showToast('Client not found!', true);
                    }
                }).catch(error => {
                    console.error('Error loading client:', error);
                    showToast('Error loading client!', true);
                });
            } else {
                fillClientDetails(client);
            }
        }
        
        function fillClientDetails(client) {
            // Switch to invoice tab
            openTab('invoice-tab');

            // Fill client details
            document.getElementById('billToName').value = client.name;
            document.getElementById('billToGST').value = client.gst;
            document.getElementById('billToStateCode').value = client.stateCode;
            document.getElementById('billToAddress').value = client.billingAddress;

            // Check if shipping is same as billing
            if (client.shippingAddress && client.shippingAddress !== client.billingAddress) {
                document.getElementById('sameAsBillTo').checked = false;
                document.getElementById('shipToName').value = client.name;
                document.getElementById('shipToGST').value = client.gst;
                document.getElementById('shipToStateCode').value = client.stateCode;
                document.getElementById('shipToAddress').value = client.shippingAddress;
                toggleShipTo();
            } else {
                document.getElementById('sameAsBillTo').checked = true;
                toggleShipTo();
            }

            // Focus on items
            document.querySelector('.item-name').focus();
        }

        function searchClients() {
            const searchTerm = document.getElementById('clientSearch').value.toLowerCase();
            const clients = JSON.parse(localStorage.getItem('clients')) || [];
            
            if (!searchTerm) {
                loadClients();
                return;
            }

            const filteredClients = clients.filter(client => 
                client.name.toLowerCase().includes(searchTerm) || 
                client.contact.toLowerCase().includes(searchTerm) || 
                client.email.toLowerCase().includes(searchTerm) || 
                client.phone.includes(searchTerm) || 
                client.gst.includes(searchTerm)
            );

            const clientsList = document.getElementById('clientsList');

            if (filteredClients.length === 0) {
                clientsList.innerHTML = '<p>No clients match your search.</p>';
                return;
            }

            clientsList.innerHTML = filteredClients.map(client => `
                <div class="client-item">
                    <div class="client-info">
                        <h3>${client.name}</h3>
                        <p><strong>Contact:</strong> ${client.contact} | <strong>Phone:</strong> ${client.phone}</p>
                        <p><strong>GSTIN:</strong> ${client.gst} | <strong>State Code:</strong> ${client.stateCode}</p>
                    </div>
                    <div class="client-actions">
                        <button onclick="editClient('${client.id}')"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteClient('${client.id}')" class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                        <button onclick="useClientForInvoice('${client.id}')" class="btn-success"><i class="fas fa-file-invoice"></i> Use for Invoice</button>
                    </div>
                </div>
            `).join('');
        }

        // Settings Functions
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('settings')) || {};

            // Company Settings
            if (settings.company) {
                document.getElementById('companyName').value = settings.company.name || 'SUPREME ENTERPRISES';
                document.getElementById('companyGST').value = settings.company.gst || '';
                document.getElementById('companyStateCode').value = settings.company.stateCode || '';
                document.getElementById('companyAddress').value = settings.company.address || '';
                document.getElementById('companyPhone').value = settings.company.phone || '';
                document.getElementById('companyEmail').value = settings.company.email || '';
                document.getElementById('companyWebsite').value = settings.company.website || '';
                document.getElementById('signatureImageUrl').value = settings.company.signatureImageUrl || '';
            }

            // Invoice Settings
            if (settings.invoice) {
                document.getElementById('invoicePrefix').value = settings.invoice.prefix || 'INV';
                document.getElementById('nextInvoiceNumber').value = settings.invoice.nextNumber || 1001;
                document.getElementById('defaultDueDays').value = settings.invoice.dueDays || 30;
                document.getElementById('defaultNotes').value = settings.invoice.notes || 'E. & O.E';
            }

            // Update seller info in invoice form if company settings exist
            if (settings.company) {
                document.getElementById('sellerName').value = settings.company.name || 'SUPREME ENTERPRISES';
                document.getElementById('sellerGST').value = settings.company.gst || '';
                document.getElementById('sellerStateCode').value = settings.company.stateCode || '';
                document.getElementById('sellerAddress').value = settings.company.address || '';
            }
        }

        function saveCompanySettings() {
            const settings = JSON.parse(localStorage.getItem('settings')) || {};

            settings.company = {
                name: document.getElementById('companyName').value,
                gst: document.getElementById('companyGST').value,
                stateCode: document.getElementById('companyStateCode').value,
                address: document.getElementById('companyAddress').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                signatureImageUrl: document.getElementById('signatureImageUrl').value
            };

            localStorage.setItem('settings', JSON.stringify(settings));

            // Update seller info in invoice form
            document.getElementById('sellerName').value = settings.company.name;
            document.getElementById('sellerGST').value = settings.company.gst;
            document.getElementById('sellerStateCode').value = settings.company.stateCode;
            document.getElementById('sellerAddress').value = settings.company.address;

            showToast('Company settings saved successfully!');
        }

        function saveInvoiceSettings() {
            const settings = JSON.parse(localStorage.getItem('settings')) || {};

            settings.invoice = {
                prefix: document.getElementById('invoicePrefix').value,
                nextNumber: parseInt(document.getElementById('nextInvoiceNumber').value),
                dueDays: parseInt(document.getElementById('defaultDueDays').value),
                notes: document.getElementById('defaultNotes').value
            };

            localStorage.setItem('settings', JSON.stringify(settings));

            // Update default notes in invoice form
            document.getElementById('notes').value = settings.invoice.notes;

            showToast('Invoice settings saved successfully!');
        }

        function loadProducts() {
            const storedProducts = JSON.parse(localStorage.getItem('products'));
            if (storedProducts && storedProducts.length > 0) {
                products.push(...storedProducts);
            }

            const productsList = document.getElementById('productsList');
            productsList.innerHTML = products.map(product => `
                <div class="client-item" style="margin-top: 10px;">
                    <div class="client-info">
                        <h3>${product.name}</h3>
                        <p><strong>HSN:</strong> ${product.hsn} | <strong>GST:</strong> ${product.gst}%</p>
                        <p>${product.description}</p>
                    </div>
                    <div class="client-actions">
                        <button onclick="editProduct(${product.id})"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteProduct(${product.id})" class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addNewProduct() {
            const newProduct = {
                id: Date.now(),
                name: document.getElementById('newProductName').value,
                hsn: document.getElementById('newProductHSN').value,
                gst: parseInt(document.getElementById('newProductGST').value),
                description: document.getElementById('newProductDescription').value
            };

            if (!newProduct.name || !newProduct.hsn || isNaN(newProduct.gst)) {
                showToast('Please fill all required fields for the product!', true);
                return;
            }

            products.push(newProduct);
            
            // Save to localStorage
            const storedProducts = JSON.parse(localStorage.getItem('products')) || [];
            storedProducts.push(newProduct);
            localStorage.setItem('products', JSON.stringify(storedProducts));

            // Reload products list
            loadProducts();

            // Clear form
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductHSN').value = '';
            document.getElementById('newProductGST').value = '';
            document.getElementById('newProductDescription').value = '';

            showToast('Product added successfully!');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);

            if (!product) {
                showToast('Product not found!', true);
                return;
            }

            document.getElementById('newProductName').value = product.name;
            document.getElementById('newProductHSN').value = product.hsn;
            document.getElementById('newProductGST').value = product.gst;
            document.getElementById('newProductDescription').value = product.description;

            // Store the current product ID for updating
            document.getElementById('newProductName').dataset.productId = product.id;

            // Change add button to update
            const addBtn = document.querySelector('#settings-tab .btn-success');
            addBtn.innerHTML = '<i class="fas fa-save"></i> Update Product';
            addBtn.onclick = function() { updateProduct(product.id); };

            // Scroll to form
            document.querySelector('#settings-tab .form-group').scrollIntoView();
        }

        function updateProduct(id) {
            const productIndex = products.findIndex(p => p.id === id);

            if (productIndex === -1) {
                showToast('Product not found!', true);
                return;
            }

            const updatedProduct = {
                id: id,
                name: document.getElementById('newProductName').value,
                hsn: document.getElementById('newProductHSN').value,
                gst: parseInt(document.getElementById('newProductGST').value),
                description: document.getElementById('newProductDescription').value
            };

            products[productIndex] = updatedProduct;
            
            // Update in localStorage
            const storedProducts = JSON.parse(localStorage.getItem('products')) || [];
            const storedIndex = storedProducts.findIndex(p => p.id === id);
            if (storedIndex !== -1) {
                storedProducts[storedIndex] = updatedProduct;
                localStorage.setItem('products', JSON.stringify(storedProducts));
            }

            // Reload products list
            loadProducts();

            // Clear form and reset button
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductHSN').value = '';
            document.getElementById('newProductGST').value = '';
            document.getElementById('newProductDescription').value = '';

            const addBtn = document.querySelector('#settings-tab .btn-success');
            addBtn.innerHTML = '<i class="fas fa-plus"></i> Add Product';
            addBtn.onclick = function() { addNewProduct(); };

            showToast('Product updated successfully!');
        }

        function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            // Remove from products array
            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex !== -1) {
                products.splice(productIndex, 1);
            }

            // Remove from localStorage
            const storedProducts = JSON.parse(localStorage.getItem('products')) || [];
            const updatedStoredProducts = storedProducts.filter(p => p.id !== id);
            localStorage.setItem('products', JSON.stringify(updatedStoredProducts));

            // Reload products list
            loadProducts();

            showToast('Product deleted successfully!');
        }
        
        // Close autocomplete when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.matches('.item-name')) {
                document.querySelectorAll('.autocomplete-results').forEach(results => {
                    results.style.display = 'none';
                });
            }
        });

        // Copy text to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('Link copied to clipboard!');
        }
    </script>
</body>
</html>
