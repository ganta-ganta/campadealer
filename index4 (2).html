<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campa Beverages - Inventory & Invoice System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { 
      font-family: Arial; 
      padding: 10px; 
      max-width: 100%; 
      margin: auto; 
      font-size: 14px; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
      font-size: 12px;
    }
    th, td { 
      border: 1px solid #ccc; 
      padding: 6px; 
      text-align: center; 
    }
    th { 
      background-color: #f4f4f4; 
      font-size: 12px;
    }
    .btn { 
      padding: 6px 10px; 
      font-size: 12px;
      color: white; 
      border: none; 
      cursor: pointer; 
      margin: 2px 0;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
    }
    .btn-primary { background: #007bff; }
    .btn-success { background: green; }
    .btn-danger { background: red; }
    .btn-warning { background: #ffc107; }
    .btn-info { background: #17a2b8; }
    .right { text-align: right; }
    .signature { margin-top: 20px; }
    .company-header { 
      background-color: #f8f9fa; 
      padding: 10px; 
      border-radius: 5px;
      font-size: 12px;
    }
    .login-container { 
      max-width: 100%; 
      margin: 20px auto;
      padding: 0 10px;
    }
    .hidden { display: none; }
    .nav-tabs { 
      margin-bottom: 10px;
      font-size: 12px;
    }
    .nav-link {
      padding: 8px 12px;
    }
    .offline-banner { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      background: #ffc107; 
      color: #000; 
      padding: 8px; 
      text-align: center;
      z-index: 1000;
      font-size: 12px;
    }
    .modal-lg { max-width: 95%; }
    .form-control, .form-select {
      padding: 6px;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .input-group {
      margin-bottom: 6px;
    }
    .card {
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-body {
      padding: 10px;
    }
    .card-title {
      font-size: 14px;
    }
    .card-text {
      font-size: 12px;
    }
    h2 { font-size: 18px; }
    h3 { font-size: 16px; }
    h4 { font-size: 14px; }
    .badge {
      font-size: 10px;
      padding: 3px 5px;
    }
    .stock-low { background-color: #fff3cd; }
    .stock-out { background-color: #f8d7da; }
    .card-header {
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    .text-success {
      color: #28a745 !important;
    }
    .text-danger {
      color: #dc3545 !important;
    }
    .table-sm td, .table-sm th {
      padding: 0.3rem;
    }
    .card.bg-primary, 
    .card.bg-success, 
    .card.bg-info, 
    .card.bg-warning {
      color: white;
    }
    .card.bg-primary .card-text,
    .card.bg-success .card-text,
    .card.bg-info .card-text,
    .card.bg-warning .card-text {
      opacity: 0.8;
      font-size: 0.85rem;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 576px) {
      .nav-tabs .nav-item {
        width: 33.33%;
        text-align: center;
      }
      .nav-link {
        padding: 8px 4px;
        font-size: 11px;
      }
      .company-header {
        padding: 8px;
      }
      .tab-content {
        padding: 5px;
      }
      .row {
        margin-left: -5px;
        margin-right: -5px;
      }
      .col-md-6, .col-md-4, .col-md-2 {
        padding-left: 5px;
        padding-right: 5px;
      }
      #invoiceBody td, #invoiceBody th {
        padding: 4px;
      }
      .btn {
        width: 100%;
        margin-bottom: 5px;
      }
      .modal-body {
        padding: 10px;
      }
    }
    
    /* Print styles */
    @media print {
      body { padding: 0; font-size: 12px; }
      .nav-tabs, .btn, #offlineBanner { display: none !important; }
      .company-header { padding: 5px; }
      table { font-size: 10px; }
      th, td { padding: 3px; }
    }
  </style>
</head>
<body>

<div id="offlineBanner" class="offline-banner hidden">
  You are currently offline. Changes will be saved locally and synced when you reconnect.
</div>

<div id="loginPage" class="login-container">
  <h2 class="text-center mb-3">Campa Beverages Login</h2>
  <div class="card">
    <div class="card-body">
      <div class="mb-2">
        <label for="loginEmail" class="form-label">Email</label>
        <input type="email" class="form-control" id="loginEmail" placeholder="operator@campa.com">
      </div>
      <div class="mb-3">
        <label for="loginPassword" class="form-label">Password</label>
        <input type="password" class="form-control" id="loginPassword" placeholder="Password">
      </div>
      <button id="loginBtn" class="btn btn-primary w-100">Login</button>
    </div>
  </div>
</div>

<div id="appContainer" class="hidden">
  <ul class="nav nav-tabs" id="myTab">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#invoiceTab">Invoices</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#stockTab">Stock</a>
    </li>
    <li class="nav-item" id="adminTabItem">
      <a class="nav-link" data-bs-toggle="tab" href="#adminTab">Admin</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#dashboardTab">Dashboard</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#operatorSalesTab">Operator Sales</a>
    </li>
    <li class="nav-item ml-auto">
      <button onclick="logout()" class="btn btn-danger btn-sm">Logout</button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Invoice Generator Tab -->
    <div class="tab-pane fade show active" id="invoiceTab">
      <div class="company-header">
        <h2>Campa Beverages Pvt. Ltd.</h2>
        <p><strong>Invoice No:</strong> <span id="invoiceNo"></span></p>
        <p><strong>Date:</strong> <span id="invoiceDate"></span></p>
      </div>

      <div class="row mb-2">
        <div class="col-md-6">
          <h4>Dealer Info</h4>
          <input type="text" id="dealerName" class="form-control mb-1" placeholder="Dealer Name" required>
          <input type="text" id="dealerAddress" class="form-control mb-1" placeholder="Address">
          <input type="text" id="dealerGST" class="form-control mb-1" placeholder="GSTIN">
        </div>
        <div class="col-md-6">
          <h4>Add Product</h4>
          <select id="productSelect" class="form-select mb-1">
            <option value="">-- Select --</option>
            <option value="Campa Cola|600 ml|28">Campa Cola - 600 ml</option>
            <option value="Campa Orange|600 ml|28">Campa Orange - 600 ml</option>
            <option value="Campa Lemon|600 ml|28">Campa Lemon - 600 ml</option>
            <option value="Campa Cloudy Lemon|600 ml|30">Cloudy Lemon - 600 ml</option>
            <option value="Power-Up Cola|500 ml|32">Power-Up - 500 ml</option>
            <option value="Campa Soda|500 ml|25">Campa Soda - 500 ml</option>
            <option value="Bubbles Soda|750 ml|28">Bubbles - 750 ml</option>
            <option value="Spinner Energy|200 ml|35">Spinner - 200 ml</option>
            <option value="Runner Energy|250 ml|38">Runner - 250 ml</option>
            <option value="Joos Mango|200 ml|22">Joos Mango - 200 ml</option>
            <option value="Independence Water|1.5 L|20">Water - 1.5 L</option>
            <option value="Sure Water|1 L|18">Water - 1 L</option>
          </select>
          <div class="input-group mb-2">
            <input type="number" id="qty" class="form-control" placeholder="Qty" min="1" value="1">
            <button class="btn btn-primary" onclick="addProduct()">Add</button>
          </div>
        </div>
      </div>

      <div style="overflow-x: auto;">
        <table class="table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>Size</th>
              <th>Qty</th>
              <th>Rate</th>
              <th>Amount</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="invoiceBody"></tbody>
        </table>
      </div>

      <div class="right mt-2">
        <h4>Subtotal: ₹<span id="subtotal">0.00</span></h4>
        <h4>GST (18%): ₹<span id="gst">0.00</span></h4>
        <h3>Total: ₹<span id="total">0.00</span></h3>
      </div>

      <div class="mt-3">
        <button class="btn btn-success" onclick="saveInvoice()">Save</button>
        <button class="btn btn-success" onclick="printInvoice()">Print</button>
        <button class="btn btn-warning" onclick="saveDraft()">Draft</button>
      </div>
    </div>

    <!-- Van Stock Management Tab -->
    <div class="tab-pane fade" id="stockTab">
      <h3>Van Stock - <span id="vanOperatorName"></span></h3>
      <div class="alert alert-info py-2">
        <strong>Current:</strong> <span id="currentStockDisplay"></span>
      </div>
      
      <h4>Request Stock</h4>
      <div class="row">
        <div class="col-md-6">
          <select id="stockProductSelect" class="form-select mb-1">
            <option value="">-- Select --</option>
            <option value="Campa Cola|600 ml">Campa Cola - 600 ml</option>
            <option value="Campa Orange|600 ml">Campa Orange - 600 ml</option>
            <option value="Campa Lemon|600 ml">Campa Lemon - 600 ml</option>
            <option value="Campa Cloudy Lemon|600 ml">Cloudy Lemon - 600 ml</option>
            <option value="Power-Up Cola|500 ml">Power-Up - 500 ml</option>
            <option value="Campa Soda|500 ml">Campa Soda - 500 ml</option>
            <option value="Bubbles Soda|750 ml">Bubbles - 750 ml</option>
            <option value="Spinner Energy|200 ml">Spinner - 200 ml</option>
            <option value="Runner Energy|250 ml">Runner - 250 ml</option>
            <option value="Joos Mango|200 ml">Joos Mango - 200 ml</option>
            <option value="Independence Water|1.5 L">Water - 1.5 L</option>
            <option value="Sure Water|1 L">Water - 1 L</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="number" id="stockQty" class="form-control" placeholder="Qty" min="1" value="1">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="requestStock()">Request</button>
        </div>
      </div>
      
      <h4 class="mt-3">Current Stock</h4>
      <div style="overflow-x: auto;">
        <table class="table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>Size</th>
              <th>Loaded</th>
              <th>Sold</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody id="vanStockBody"></tbody>
        </table>
      </div>
      
      <h4 class="mt-3">Pending Requests</h4>
      <div style="overflow-x: auto;">
        <table class="table-bordered">
          <thead>
            <tr>
              <th>Product</th>
              <th>Size</th>
              <th>Qty</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="pendingRequestsBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Admin Dashboard Tab -->
    <div class="tab-pane fade" id="adminTab">
      <h3>Admin Dashboard</h3>
      
      <div class="row mb-2">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-primary text-white py-2">
              Pending Invoices
            </div>
            <div class="card-body p-2">
              <div id="pendingApprovalsList"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-warning text-white py-2">
              Pending Stock Requests
            </div>
            <div class="card-body p-2">
              <div id="pendingStockApprovals"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card mb-2">
        <div class="card-header bg-info text-white py-2">
          Warehouse Management
        </div>
        <div class="card-body p-2">
          <div class="row">
            <div class="col-md-4">
              <select id="warehouseProductSelect" class="form-select mb-2">
                <option value="">-- Select Product --</option>
                <option value="Campa Cola|600 ml">Campa Cola - 600 ml</option>
                <option value="Campa Orange|600 ml">Campa Orange - 600 ml</option>
                <option value="Campa Lemon|600 ml">Campa Lemon - 600 ml</option>
                <option value="Campa Cloudy Lemon|600 ml">Cloudy Lemon - 600 ml</option>
                <option value="Power-Up Cola|500 ml">Power-Up - 500 ml</option>
                <option value="Campa Soda|500 ml">Campa Soda - 500 ml</option>
                <option value="Bubbles Soda|750 ml">Bubbles - 750 ml</option>
                <option value="Spinner Energy|200 ml">Spinner - 200 ml</option>
                <option value="Runner Energy|250 ml">Runner - 250 ml</option>
                <option value="Joos Mango|200 ml">Joos Mango - 200 ml</option>
                <option value="Independence Water|1.5 L">Water - 1.5 L</option>
                <option value="Sure Water|1 L">Water - 1 L</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="number" id="warehouseQty" class="form-control" placeholder="Qty" min="1" value="1">
            </div>
            <div class="col-md-3">
              <select id="warehouseAction" class="form-select mb-2">
                <option value="add">Add Stock</option>
                <option value="remove">Remove Stock</option>
              </select>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" onclick="updateWarehouseStock()">Update</button>
            </div>
          </div>
          
          <h5 class="mt-3">Current Warehouse Stock</h5>
          <div style="overflow-x: auto;">
            <table class="table-bordered">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Size</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody id="warehouseStockBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="card mb-2">
        <div class="card-header bg-success text-white py-2">
          Van Operators
        </div>
        <div class="card-body p-2">
          <div id="vanOperatorsSummary"></div>
        </div>
      </div>
      
      <h4>Recent Invoices</h4>
      <div class="mb-2">
        <button class="btn btn-secondary btn-sm" onclick="exportInvoices('csv')">CSV</button>
        <button class="btn btn-secondary btn-sm" onclick="exportInvoices('excel')">Excel</button>
      </div>
      <div style="overflow-x: auto;">
        <table class="table-bordered">
          <thead>
            <tr>
              <th>Inv No</th>
              <th>Date</th>
              <th>Dealer</th>
              <th>Amount</th>
              <th>Operator</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="invoicesList"></tbody>
        </table>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-pane fade" id="dashboardTab">
      <h3>Sales Dashboard</h3>
      
      <div class="row mb-3">
        <div class="col-md-4">
          <select id="dashboardTimeRange" class="form-select" onchange="loadDashboardData()">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="col-md-4" id="customDateRange" style="display:none;">
          <input type="date" id="dashboardStartDate" class="form-control">
        </div>
        <div class="col-md-4" id="customDateRangeEnd" style="display:none;">
          <input type="date" id="dashboardEndDate" class="form-control">
        </div>
      </div>
      
      <!-- Download Buttons -->
      <div class="mb-3">
        <button class="btn btn-primary btn-sm" onclick="exportDashboardData('today')">Download Today</button>
        <button class="btn btn-primary btn-sm" onclick="exportDashboardData('week')">Download Week</button>
        <button class="btn btn-primary btn-sm" onclick="exportDashboardData('month')">Download Month</button>
        <button class="btn btn-secondary btn-sm" onclick="toggleView()">Toggle View</button>
      </div>
      
      <!-- Summary Cards -->
      <div class="row mb-3">
        <div class="col-md-3">
          <div class="card text-white bg-primary">
            <div class="card-body">
              <h5 class="card-title">Total Sales</h5>
              <h2 id="totalSales">₹0.00</h2>
              <p class="card-text"><span id="salesChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success">
            <div class="card-body">
              <h5 class="card-title">Total Quantity</h5>
              <h2 id="totalQuantity">0</h2>
              <p class="card-text"><span id="quantityChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info">
            <div class="card-body">
              <h5 class="card-title">Products Sold</h5>
              <h2 id="totalProducts">0</h2>
              <p class="card-text"><span id="productsChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-warning">
            <div class="card-body">
              <h5 class="card-title">Avg. Sale</h5>
              <h2 id="avgSale">₹0.00</h2>
              <p class="card-text"><span id="avgSaleChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Product/Quantity Toggle View -->
      <div id="productView">
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between">
                <h5>Sales Trend</h5>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType('sales')">
                    <i class="bi bi-bar-chart"></i> Toggle Chart
                  </button>
                </div>
              </div>
              <div class="card-body">
                <canvas id="salesTrendChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Top Products by Revenue</h5>
              </div>
              <div class="card-body">
                <canvas id="topProductsChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="quantityView" style="display:none;">
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between">
                <h5>Quantity Trend</h5>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType('quantity')">
                    <i class="bi bi-bar-chart"></i> Toggle Chart
                  </button>
                </div>
              </div>
              <div class="card-body">
                <canvas id="quantityTrendChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Top Products by Quantity</h5>
              </div>
              <div class="card-body">
                <canvas id="topQuantityChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Tables -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Product Performance</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Qty</th>
                    <th>Revenue</th>
                    <th>% of Total</th>
                  </tr>
                </thead>
                <tbody id="productPerformance">
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Daily Summary</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Invoices</th>
                    <th>Qty</th>
                    <th>Revenue</th>
                  </tr>
                </thead>
                <tbody id="dailySummary">
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Operator Sales Tab -->
    <div class="tab-pane fade" id="operatorSalesTab">
      <h3>Van Operator Sales Performance</h3>
      
      <div class="row mb-3">
        <div class="col-md-4">
          <select id="operatorSelect" class="form-select">
            <option value="all">All Operators</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>
        <div class="col-md-4">
          <select id="productFilter" class="form-select">
            <option value="all">All Products</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>
        <div class="col-md-4">
          <select id="timePeriodFilter" class="form-select">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
      </div>
      
      <div class="row mb-3" id="customDateRangeOperator" style="display:none;">
        <div class="col-md-6">
          <input type="date" id="operatorStartDate" class="form-control">
        </div>
        <div class="col-md-6">
          <input type="date" id="operatorEndDate" class="form-control">
        </div>
      </div>
      
      <div class="mb-3">
        <button class="btn btn-primary" onclick="loadOperatorSales()">Apply Filters</button>
        <button class="btn btn-success" onclick="exportOperatorSales()">Export Data</button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5>Product-wise Sales by Operator</h5>
        </div>
        <div class="card-body" style="overflow-x: auto;">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Operator</th>
                <th>Product</th>
                <th>Size</th>
                <th>Quantity Sold</th>
                <th>Total Revenue</th>
                <th>% of Operator Sales</th>
              </tr>
            </thead>
            <tbody id="operatorSalesBody">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="card mt-3">
        <div class="card-header">
          <h5>Sales Summary</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <canvas id="operatorProductChart" height="300"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="operatorPerformanceChart" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SheetJS for export -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut,
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    addDoc,
    updateDoc,
    query,
    where,
    orderBy,
    limit,
    getDocs,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBm2Y2-KaPh_9prtDyEh75ys9bOS_YivyU",
    authDomain: "campacola-45a6c.firebaseapp.com",
    projectId: "campacola-45a6c",
    storageBucket: "campacola-45a6c.appspot.com",
    messagingSenderId: "950062364838",
    appId: "1:950062364838:web:c016c1c2b63d661dc09c67",
    measurementId: "G-0F1FMP4D6X"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Global variables
  let currentUser = null;
  let subtotal = 0;
  let invoiceItems = [];
  let vanStock = {};
  let invoiceCounter = 0;
  let isOnline = navigator.onLine;
  const offlineInvoices = JSON.parse(localStorage.getItem('offlineInvoices')) || [];
  const offlineStockRequests = JSON.parse(localStorage.getItem('offlineStockRequests')) || [];
  const draftInvoices = JSON.parse(localStorage.getItem('draftInvoices')) || [];
  let salesTrendChart = null;
  let quantityTrendChart = null;
  let topProductsChart = null;
  let topQuantityChart = null;
  let operatorProductChart = null;
  let operatorPerformanceChart = null;
  let currentView = 'product'; // 'product' or 'quantity'
  let currentChartType = { sales: 'line', quantity: 'line' };

  // Initialize the app
  function initApp() {
    // Hide app container initially
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    
    // Create invoice modal
    createInvoiceModal();
    
    // Connect login button
    document.getElementById('loginBtn').addEventListener('click', login);
    
    // Setup offline detection
    window.addEventListener('online', handleConnectionChange);
    window.addEventListener('offline', handleConnectionChange);
    updateOnlineStatus();
    
    // Set default dates for dashboard
    const today = new Date();
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(today.getDate() - 7);
    
    document.getElementById('dashboardStartDate').valueAsDate = oneWeekAgo;
    document.getElementById('dashboardEndDate').valueAsDate = today;
    document.getElementById('operatorStartDate').valueAsDate = oneWeekAgo;
    document.getElementById('operatorEndDate').valueAsDate = today;
    
    // Initialize operator sales tab when shown
    document.getElementById('operatorSalesTab').addEventListener('shown.bs.tab', function() {
      initOperatorSalesTab();
    });
    
    // Check if user is already logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadUserData();
        document.getElementById('appContainer').classList.remove('hidden');
        document.getElementById('loginPage').classList.add('hidden');
      }
    }, (error) => {
      console.error("Auth state error:", error);
      alert("Authentication error: " + error.message);
    });
  }

  // Initialize operator sales tab
  async function initOperatorSalesTab() {
    // Populate operator dropdown
    const operatorSelect = document.getElementById('operatorSelect');
    operatorSelect.innerHTML = '<option value="all">All Operators</option>';
    
    // Populate product filter
    const productFilter = document.getElementById('productFilter');
    productFilter.innerHTML = '<option value="all">All Products</option>';
    
    // Setup event listeners
    document.getElementById('timePeriodFilter').addEventListener('change', function() {
      const isCustom = this.value === 'custom';
      document.getElementById('customDateRangeOperator').style.display = isCustom ? 'flex' : 'none';
    });
    
    // Load initial data
    await loadOperators();
    await loadProducts();
    loadOperatorSales();
  }

  // Load operators list
  async function loadOperators() {
    try {
      const querySnapshot = await getDocs(collection(db, 'vanStock'));
      const operatorSelect = document.getElementById('operatorSelect');
      
      querySnapshot.forEach(doc => {
        // Get operator email from vanStock document ID (assuming ID is operator UID)
        // You might need to store operator emails in vanStock documents for better display
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = doc.id.substring(0, 8) + '...'; // Shorten for display
        operatorSelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading operators:", error);
    }
  }

  // Load products list
  async function loadProducts() {
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      const productFilter = document.getElementById('productFilter');
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const key in warehouseData) {
          const [name, size] = key.split('|');
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${name} (${size})`;
          productFilter.appendChild(option);
        }
      }
    } catch (error) {
      console.error("Error loading products:", error);
    }
  }

  // Main function to load operator sales data
  async function loadOperatorSales() {
    try {
      // Get filter values
      const operatorId = document.getElementById('operatorSelect').value;
      const productFilter = document.getElementById('productFilter').value;
      const timePeriod = document.getElementById('timePeriodFilter').value;
      
      // Determine date range
      let startDate, endDate = new Date();
      endDate.setHours(23, 59, 59, 999);
      
      if (timePeriod === 'custom') {
        startDate = new Date(document.getElementById('operatorStartDate').value);
        endDate = new Date(document.getElementById('operatorEndDate').value);
        endDate.setHours(23, 59, 59, 999);
      } else {
        startDate = calculateStartDate(timePeriod);
      }
      
      // Build the Firestore query
      let invoicesQuery = query(
        collection(db, 'invoices'),
        where('invoiceDate', '>=', startDate),
        where('invoiceDate', '<=', endDate),
        where('status', '==', 'approved')
      );
      
      // Add operator filter if not "all"
      if (operatorId !== 'all') {
        invoicesQuery = query(invoicesQuery, where('createdByUid', '==', operatorId));
      }
      
      const querySnapshot = await getDocs(invoicesQuery);
      
      // Process the data
      const operatorSales = {};
      const productSales = {};
      let totalQuantity = 0;
      let totalRevenue = 0;
      
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        const operatorKey = invoice.createdByUid || invoice.createdBy; // Fallback to email if UID not available
        
        if (!operatorSales[operatorKey]) {
          operatorSales[operatorKey] = {
            email: invoice.createdBy,
            products: {},
            totalQuantity: 0,
            totalRevenue: 0
          };
        }
        
        invoice.items.forEach(item => {
          const productKey = `${item.name}|${item.size}`;
          
          // Apply product filter if not "all"
          if (productFilter === 'all' || productFilter === productKey) {
            // Update operator sales
            if (!operatorSales[operatorKey].products[productKey]) {
              operatorSales[operatorKey].products[productKey] = {
                name: item.name,
                size: item.size,
                quantity: 0,
                revenue: 0
              };
            }
            
            operatorSales[operatorKey].products[productKey].quantity += item.qty;
            operatorSales[operatorKey].products[productKey].revenue += item.amount;
            operatorSales[operatorKey].totalQuantity += item.qty;
            operatorSales[operatorKey].totalRevenue += item.amount;
            
            // Update global product sales
            if (!productSales[productKey]) {
              productSales[productKey] = {
                name: item.name,
                size: item.size,
                quantity: 0,
                revenue: 0
              };
            }
            
            productSales[productKey].quantity += item.qty;
            productSales[productKey].revenue += item.amount;
            
            // Update totals
            totalQuantity += item.qty;
            totalRevenue += item.amount;
          }
        });
      });
      
      // Update the table
      updateOperatorSalesTable(operatorSales);
      
      // Update the charts
      updateOperatorCharts(operatorSales, productSales);
      
    } catch (error) {
      console.error("Error loading operator sales:", error);
      alert("Error loading operator sales data: " + error.message);
    }
  }

  function calculateStartDate(timePeriod) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    switch(timePeriod) {
      case 'today':
        return today;
      case 'week':
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
        return weekStart;
      case 'month':
        return new Date(today.getFullYear(), today.getMonth(), 1);
      case 'quarter':
        const quarter = Math.floor(today.getMonth() / 3);
        return new Date(today.getFullYear(), quarter * 3, 1);
      case 'year':
        return new Date(today.getFullYear(), 0, 1);
      default:
        return new Date(0); // All time
    }
  }

  function updateOperatorSalesTable(operatorSales) {
    const tbody = document.getElementById('operatorSalesBody');
    tbody.innerHTML = '';
    
    for (const operatorId in operatorSales) {
      const operator = operatorSales[operatorId];
      
      for (const productKey in operator.products) {
        const product = operator.products[productKey];
        const percentage = operator.totalRevenue > 0 
          ? (product.revenue / operator.totalRevenue * 100) 
          : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${operator.email}</td>
          <td>${product.name}</td>
          <td>${product.size}</td>
          <td>${product.quantity}</td>
          <td>₹${product.revenue.toFixed(2)}</td>
          <td>${percentage.toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
      }
    }
    
    if (tbody.children.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">No sales data found for selected filters</td></tr>';
    }
  }

  function updateOperatorCharts(operatorSales, productSales) {
    // Operator Performance Chart (Top operators by quantity)
    const operatorsArray = Object.values(operatorSales)
      .sort((a, b) => b.totalQuantity - a.totalQuantity)
      .slice(0, 5);
    
    const operatorLabels = operatorsArray.map(op => op.email.substring(0, 8) + '...');
    const operatorQuantities = operatorsArray.map(op => op.totalQuantity);
    
    // Product Performance Chart (Top products across all operators)
    const productsArray = Object.values(productSales)
      .sort((a, b) => b.quantity - a.quantity)
      .slice(0, 5);
    
    const productLabels = productsArray.map(p => `${p.name} (${p.size})`);
    const productQuantities = productsArray.map(p => p.quantity);
    
    // Destroy previous charts if they exist
    if (operatorPerformanceChart) {
      operatorPerformanceChart.destroy();
    }
    if (operatorProductChart) {
      operatorProductChart.destroy();
    }
    
    // Create Operator Performance Chart
    const operatorCtx = document.getElementById('operatorPerformanceChart').getContext('2d');
    operatorPerformanceChart = new Chart(operatorCtx, {
      type: 'bar',
      data: {
        labels: operatorLabels,
        datasets: [{
          label: 'Quantity Sold',
          data: operatorQuantities,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Top Operators by Quantity'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Items Sold'
            }
          }
        }
      }
    });
    
    // Create Product Performance Chart
    const productCtx = document.getElementById('operatorProductChart').getContext('2d');
    operatorProductChart = new Chart(productCtx, {
      type: 'pie',
      data: {
        labels: productLabels,
        datasets: [{
          data: productQuantities,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Top Products Across Operators'
          }
        }
      }
    });
  }

  // Export operator sales data
  async function exportOperatorSales() {
    try {
      // Get the current table data
      const rows = document.getElementById('operatorSalesBody').querySelectorAll('tr');
      
      // Prepare CSV content
      let csv = 'Operator,Product,Size,Quantity Sold,Total Revenue,% of Operator Sales\n';
      
      rows.forEach(row => {
        if (row.cells.length === 6) { // Skip the "no data" row
          const cells = Array.from(row.cells).map(cell => {
            // Handle currency values (remove ₹ symbol)
            return cell.textContent.replace('₹', '').trim();
          });
          csv += cells.join(',') + '\n';
        }
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // Generate filename based on filters
      const operator = document.getElementById('operatorSelect').value === 'all' ? 'all-operators' : document.getElementById('operatorSelect').value;
      const product = document.getElementById('productFilter').value === 'all' ? 'all-products' : document.getElementById('productFilter').value;
      const period = document.getElementById('timePeriodFilter').value;
      
      a.download = `operator-sales_${operator}_${product}_${period}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      
    } catch (error) {
      console.error("Error exporting operator sales:", error);
      alert("Error exporting data: " + error.message);
    }
  }

  // Handle connection changes
  function handleConnectionChange() {
    isOnline = navigator.onLine;
    updateOnlineStatus();
    if (isOnline) {
      syncOfflineData();
    }
  }

  function updateOnlineStatus() {
    const offlineBanner = document.getElementById('offlineBanner');
    if (isOnline) {
      offlineBanner.classList.add('hidden');
    } else {
      offlineBanner.classList.remove('hidden');
    }
  }

  // Sync offline data when connection is restored
  async function syncOfflineData() {
    if (!currentUser) return;
    
    // Sync offline invoices
    while (offlineInvoices.length > 0) {
      const invoice = offlineInvoices[0];
      try {
        await addDoc(collection(db, 'invoices'), invoice);
        offlineInvoices.shift();
        localStorage.setItem('offlineInvoices', JSON.stringify(offlineInvoices));
      } catch (error) {
        console.error("Error syncing offline invoice:", error);
        break;
      }
    }
    
    // Sync stock requests
    while (offlineStockRequests.length > 0) {
      const request = offlineStockRequests[0];
      try {
        await addDoc(collection(db, 'stockRequests'), request);
        offlineStockRequests.shift();
        localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
      } catch (error) {
        console.error("Error syncing stock request:", error);
        break;
      }
    }
    
    // Reload data after sync
    if (currentUser.email === 'admin@campabeverages.com') {
      loadPendingApprovals();
      loadPendingStockApprovals();
      loadWarehouseStock();
    } else {
      loadPendingStockRequests();
    }
  }

  // Create invoice modal for detailed view
  function createInvoiceModal() {
    const modalHTML = `
      <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Invoice Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody">
              <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="printInvoiceFromModal()">Print</button>
              <span id="approvalButtons"></span>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  // Login function
  async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      currentUser = userCredential.user;
      document.getElementById('appContainer').classList.remove('hidden');
      document.getElementById('loginPage').classList.add('hidden');
      loadUserData();
    } catch (error) {
      alert('Login failed: ' + error.message);
      console.error("Login error:", error);
    }
  }

  // Logout function
  function logout() {
    signOut(auth).then(() => {
      currentUser = null;
      document.getElementById('appContainer').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  }

  // Load user-specific data
  async function loadUserData() {
    if (!currentUser) return;
    
    // Show/hide admin tab based on user role
    const isAdmin = currentUser.email === 'admin@campabeverages.com';
    document.getElementById('adminTabItem').classList.toggle('hidden', !isAdmin);
    
    if (isAdmin) {
      loadAdminData();
      loadWarehouseStock();
    } else {
      loadOperatorData();
    }
    
    // Generate invoice number
    generateInvoiceNo();
    
    // Setup real-time listeners
    setupRealTimeListeners();
    
    // Initialize dashboard if shown
    if (document.getElementById('dashboardTab').classList.contains('active')) {
      loadDashboardData();
    }
  }

  // Setup real-time listeners
  function setupRealTimeListeners() {
    if (currentUser.email === 'admin@campabeverages.com') {
      // Invoices
      onSnapshot(query(collection(db, 'invoices'), where('status', '==', 'pending')), 
        () => loadPendingApprovals());
        
      // Stock requests
      onSnapshot(query(collection(db, 'stockRequests'), where('status', '==', 'pending')), 
        () => loadPendingStockApprovals());
    }
  }

  // Load operator-specific data
  async function loadOperatorData() {
    // Set van operator name
    document.getElementById('vanOperatorName').textContent = currentUser.email.split('@')[0];
    
    // Load van stock
    try {
      const vanStockDoc = await getDoc(doc(db, 'vanStock', currentUser.uid));
      if (vanStockDoc.exists()) {
        vanStock = vanStockDoc.data().stock || {};
        updateVanStockDisplay();
      } else {
        // Initialize empty stock if none exists
        vanStock = {};
        updateVanStockDisplay();
      }
    } catch (error) {
      console.error("Error loading van stock:", error);
      alert("Error loading van stock: " + error.message);
    }
    
    // Load pending stock requests
    loadPendingStockRequests();
  }

  // Load admin-specific data
  async function loadAdminData() {
    loadPendingApprovals();
    loadPendingStockApprovals();
    loadVanOperatorsSummary();
    loadRecentInvoices();
  }

  // Load warehouse stock data
  async function loadWarehouseStock() {
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      const tbody = document.getElementById('warehouseStockBody');
      tbody.innerHTML = '';
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const [key, qty] of Object.entries(warehouseData)) {
          const [name, size] = key.split('|');
          const row = document.createElement('tr');
          row.className = qty < 10 ? 'stock-low' : (qty === 0 ? 'stock-out' : '');
          row.innerHTML = `
            <td>${name}</td>
            <td>${size}</td>
            <td>${qty}</td>
          `;
          tbody.appendChild(row);
        }
      }
    } catch (error) {
      console.error("Error loading warehouse stock:", error);
      alert("Error loading warehouse stock: " + error.message);
    }
  }

  // Generate invoice number
  async function generateInvoiceNo() {
    try {
      const counterDoc = await getDoc(doc(db, 'counters', 'invoiceCounter'));
      if (counterDoc.exists()) {
        invoiceCounter = counterDoc.data().value;
      } else {
        // Initialize counter if it doesn't exist
        invoiceCounter = 0;
        await setDoc(doc(db, 'counters', 'invoiceCounter'), { value: invoiceCounter });
      }
    } catch (error) {
      console.error("Error loading invoice counter:", error);
      invoiceCounter = 0;
    }
    
    const now = new Date();
    const id = 'CB-' + now.getFullYear() + '-' + String(invoiceCounter + 1).padStart(4, '0');
    document.getElementById('invoiceNo').textContent = id;
    document.getElementById('invoiceDate').textContent = now.toLocaleDateString();
  }

  // Add product to invoice
  function addProduct() {
    const select = document.getElementById('productSelect');
    const value = select.value;
    const qty = parseInt(document.getElementById('qty').value) || 1;
    
    if (!value) return alert('Please select a product.');
    if (qty <= 0) return alert('Quantity must be greater than 0.');
    
    const [name, size, rate] = value.split('|');
    const productKey = `${name}|${size}`;
    
    // Check stock if operator
    if (currentUser.email !== 'admin@campabeverages.com') {
      if (!vanStock[productKey] || vanStock[productKey].remaining < qty) {
        return alert('Not enough stock in van for this product!');
      }
    }
    
    const amount = qty * parseFloat(rate);
    subtotal += amount;
    
    // Add to invoice items
    const item = {
      name,
      size,
      qty,
      rate: parseFloat(rate),
      amount
    };
    
    invoiceItems.push(item);
    
    // Update invoice table
    updateInvoiceTable();
    
    // Update van stock (preliminary - will be finalized on save)
    if (currentUser.email !== 'admin@campabeverages.com') {
      vanStock[productKey].sold = (vanStock[productKey].sold || 0) + qty;
      vanStock[productKey].remaining = vanStock[productKey].loaded - vanStock[productKey].sold;
      updateVanStockDisplay();
    }
  }

  // Update invoice table display
  function updateInvoiceTable() {
    const invoiceBody = document.getElementById('invoiceBody');
    invoiceBody.innerHTML = '';
    
    let newSubtotal = 0;
    
    invoiceItems.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.size}</td>
        <td>${item.qty}</td>
        <td>₹${item.rate.toFixed(2)}</td>
        <td>₹${item.amount.toFixed(2)}</td>
        <td><button class="btn btn-danger btn-sm" onclick="removeItem(${index})">X</button></td>
      `;
      invoiceBody.appendChild(row);
      newSubtotal += item.amount;
    });
    
    subtotal = newSubtotal;
    const gst = subtotal * 0.18;
    const total = subtotal + gst;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('gst').textContent = gst.toFixed(2);
    document.getElementById('total').textContent = total.toFixed(2);
  }

  // Remove item from invoice
  function removeItem(index) {
    const removedItem = invoiceItems.splice(index, 1)[0];
    
    // Update van stock if needed
    if (currentUser.email !== 'admin@campabeverages.com') {
      const productKey = `${removedItem.name}|${removedItem.size}`;
      if (vanStock[productKey]) {
        vanStock[productKey].sold -= removedItem.qty;
        vanStock[productKey].remaining = vanStock[productKey].loaded - vanStock[productKey].sold;
        updateVanStockDisplay();
      }
    }
    
    updateInvoiceTable();
  }

  // Save invoice to Firebase
  async function saveInvoice() {
    if (invoiceItems.length === 0) return alert('Add products to invoice before saving!');
    
    const dealerName = document.getElementById('dealerName').value;
    if (!dealerName) return alert('Please enter dealer name!');
    
    const invoiceNo = document.getElementById('invoiceNo').textContent;
    const invoiceDate = document.getElementById('invoiceDate').textContent;
    
    const gst = subtotal * 0.18;
    const total = subtotal + gst;
    
    const invoiceData = {
      invoiceNo,
      invoiceDate: new Date(),
      dealer: {
        name: dealerName,
        address: document.getElementById('dealerAddress').value || '',
        gstin: document.getElementById('dealerGST').value || ''
      },
      items: invoiceItems,
      subtotal,
      gst,
      total,
      status: currentUser.email === 'admin@campabeverages.com' ? 'approved' : 'pending',
      createdBy: currentUser.email,
      createdByUid: currentUser.uid,
      createdAt: serverTimestamp(),
      isOffline: !isOnline
    };
    
    if (isOnline) {
      try {
        // Save invoice
        await addDoc(collection(db, 'invoices'), invoiceData);
        
        // Update invoice counter
        invoiceCounter++;
        await setDoc(doc(db, 'counters', 'invoiceCounter'), { value: invoiceCounter });
        
        // Update van stock if operator
        if (currentUser.email !== 'admin@campabeverages.com') {
          await setDoc(doc(db, 'vanStock', currentUser.uid), {
            stock: vanStock,
            lastUpdated: serverTimestamp()
          });
        }
        
        alert('Invoice saved successfully!');
        resetInvoiceForm();
      } catch (error) {
        console.error("Error saving invoice:", error);
        // Fallback to offline
        saveInvoiceOffline(invoiceData);
      }
    } else {
      saveInvoiceOffline(invoiceData);
    }
  }

  // Save invoice offline
  function saveInvoiceOffline(invoiceData) {
    offlineInvoices.push(invoiceData);
    localStorage.setItem('offlineInvoices', JSON.stringify(offlineInvoices));
    
    // Update van stock locally
    if (currentUser.email !== 'admin@campabeverages.com') {
      localStorage.setItem(`vanStock_${currentUser.uid}`, JSON.stringify(vanStock));
    }
    
    alert('Invoice saved offline. Will sync when connection is restored.');
    resetInvoiceForm();
  }

  // Save draft invoice
  function saveDraft() {
    if (invoiceItems.length === 0) return alert('Add products to invoice before saving!');
    
    const dealerName = document.getElementById('dealerName').value;
    if (!dealerName) return alert('Please enter dealer name!');
    
    const invoiceNo = document.getElementById('invoiceNo').textContent;
    
    const draftData = {
      invoiceNo,
      dealerName,
      dealerAddress: document.getElementById('dealerAddress').value || '',
      dealerGST: document.getElementById('dealerGST').value || '',
      items: invoiceItems,
      subtotal,
      timestamp: new Date().toISOString()
    };
    
    draftInvoices.push(draftData);
    localStorage.setItem('draftInvoices', JSON.stringify(draftInvoices));
    
    alert('Draft saved successfully!');
    resetInvoiceForm();
  }

  // Reset invoice form
  function resetInvoiceForm() {
    invoiceItems = [];
    subtotal = 0;
    document.getElementById('invoiceBody').innerHTML = '';
    document.getElementById('subtotal').textContent = '0.00';
    document.getElementById('gst').textContent = '0.00';
    document.getElementById('total').textContent = '0.00';
    document.getElementById('dealerName').value = '';
    document.getElementById('dealerAddress').value = '';
    document.getElementById('dealerGST').value = '';
    generateInvoiceNo();
  }

  // Print invoice
  function printInvoice() {
    window.print();
  }

  // Print from modal
  function printInvoiceFromModal() {
    const modal = document.getElementById('invoiceModal');
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Invoice Print</title>');
    printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
    printWindow.document.write('<style>body { font-family: Arial; padding: 5px; font-size: 12px; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(modal.querySelector('.modal-body').innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  }

  // Van stock management functions
  async function requestStock() {
    const select = document.getElementById('stockProductSelect');
    const value = select.value;
    const qty = parseInt(document.getElementById('stockQty').value) || 1;
    
    if (!value) return alert('Please select a product.');
    if (qty <= 0) return alert('Quantity must be greater than 0.');
    
    const [name, size] = value.split('|');
    
    // Check warehouse availability first
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      if (warehouseSnap.exists()) {
        const warehouseStock = warehouseSnap.data();
        const productKey = `${name}|${size}`;
        
        if (!warehouseStock[productKey] || warehouseStock[productKey] < qty) {
          return alert('Not enough stock in warehouse!');
        }
      }
    } catch (error) {
      console.error("Error checking warehouse stock:", error);
      return alert('Error checking warehouse availability');
    }
    
    const stockRequest = {
      operatorId: currentUser.uid,
      operatorEmail: currentUser.email,
      product: { name, size },
      quantity: qty,
      timestamp: new Date(),
      status: 'pending',
      isOffline: !isOnline
    };
    
    if (isOnline) {
      try {
        await addDoc(collection(db, 'stockRequests'), stockRequest);
        alert('Stock request submitted for admin approval');
        loadPendingStockRequests();
      } catch (error) {
        console.error("Error saving stock request:", error);
        saveStockRequestOffline(stockRequest);
      }
    } else {
      saveStockRequestOffline(stockRequest);
    }
    
    document.getElementById('stockQty').value = '';
  }

  // Save stock request offline
  function saveStockRequestOffline(request) {
    offlineStockRequests.push(request);
    localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
    alert('Stock request saved offline. Will submit when connection is restored.');
    loadPendingStockRequests();
  }

  // Update warehouse stock
  async function updateWarehouseStock() {
    const select = document.getElementById('warehouseProductSelect');
    const value = select.value;
    const qty = parseInt(document.getElementById('warehouseQty').value) || 1;
    const action = document.getElementById('warehouseAction').value;
    
    if (!value) return alert('Please select a product.');
    if (qty <= 0) return alert('Quantity must be greater than 0.');
    
    const [name, size] = value.split('|');
    const productKey = `${name}|${size}`;
    
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      let warehouseData = warehouseSnap.exists() ? warehouseSnap.data() : {};
      if (!warehouseData[productKey]) {
        warehouseData[productKey] = 0;
      }
      
      if (action === 'add') {
        warehouseData[productKey] += qty;
      } else {
        if (warehouseData[productKey] < qty) {
          return alert('Not enough stock to remove!');
        }
        warehouseData[productKey] -= qty;
      }
      
      await setDoc(warehouseRef, warehouseData);
      alert('Warehouse stock updated!');
      loadWarehouseStock();
    } catch (error) {
      console.error("Error updating warehouse stock:", error);
      alert('Error updating warehouse: ' + error.message);
    }
  }

  // Update van stock display
  function updateVanStockDisplay() {
    const vanStockBody = document.getElementById('vanStockBody');
    vanStockBody.innerHTML = '';
    
    let stockDisplay = '';
    let totalStock = 0;
    let lowStockCount = 0;
    
    for (const key in vanStock) {
      const item = vanStock[key];
      const row = document.createElement('tr');
      row.className = item.remaining < 5 ? 'stock-low' : (item.remaining === 0 ? 'stock-out' : '');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.size}</td>
        <td>${item.loaded}</td>
        <td>${item.sold}</td>
        <td>${item.remaining}</td>
      `;
      vanStockBody.appendChild(row);
      
      if (item.remaining > 0) {
        stockDisplay += `${item.name} (${item.size}): ${item.remaining}, `;
        totalStock += item.remaining;
        
        if (item.remaining < 5) {
          lowStockCount++;
        }
      }
    }
    
    const summaryHTML = `
      <div class="row text-center mb-2">
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body p-2">
              <h6>Total Products</h6>
              <h4>${Object.keys(vanStock).length}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body p-2">
              <h6>Total Stock</h6>
              <h4>${totalStock}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body p-2">
              <h6>Low Stock (<5)</h6>
              <h4>${lowStockCount}</h4>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('currentStockDisplay').innerHTML = 
      summaryHTML + (stockDisplay.length > 0 ? stockDisplay.slice(0, -2) : 'No stock available');
    
    // Update tab title with stock count
    document.querySelector('[href="#stockTab"]').innerHTML = 
      `Stock <span class="badge bg-primary">${totalStock}</span>`;
  }

  // Load pending stock requests for operator
  async function loadPendingStockRequests() {
    const pendingRequestsBody = document.getElementById('pendingRequestsBody');
    pendingRequestsBody.innerHTML = '';
    
    // Check offline requests first
    const allRequests = [...offlineStockRequests];
    
    if (isOnline) {
      try {
        const q = query(
          collection(db, 'stockRequests'),
          where('operatorId', '==', currentUser.uid),
          orderBy('timestamp', 'desc')
        );
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
          allRequests.push({ id: doc.id, ...doc.data() });
        });
      } catch (error) {
        console.error("Error loading stock requests:", error);
      }
    }
    
    allRequests.forEach(request => {
      let displayDate = 'N/A';
      try {
        if (request.timestamp) {
          const dateObj = request.timestamp.toDate ? request.timestamp.toDate() : new Date(request.timestamp);
          displayDate = dateObj.toLocaleDateString();
        }
      } catch (e) {
        console.error("Error formatting date:", e);
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${request.product.name}</td>
        <td>${request.product.size}</td>
        <td>${request.quantity}</td>
        <td>${displayDate}</td>
        <td>${request.status} ${request.isOffline ? '(Offline)' : ''}</td>
      `;
      pendingRequestsBody.appendChild(row);
    });
  }

  // Admin functions
  async function loadPendingApprovals() {
    try {
      const q = query(
        collection(db, 'invoices'),
        where('status', '==', 'pending'),
        orderBy('createdAt', 'desc'),
        limit(5)
      );
      
      const querySnapshot = await getDocs(q);
      let html = '';
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        html += `
          <div class="card mb-2">
            <div class="card-body p-2">
              <h5 class="card-title mb-1">${invoice.invoiceNo}</h5>
              <p class="card-text mb-1">
                <strong>Dealer:</strong> ${invoice.dealer.name}<br>
                <strong>Amount:</strong> ₹${invoice.total.toFixed(2)}<br>
                <strong>Operator:</strong> ${invoice.createdBy}
              </p>
              <button onclick="approveInvoice('${doc.id}')" class="btn btn-success btn-sm">Approve</button>
              <button onclick="rejectInvoice('${doc.id}')" class="btn btn-danger btn-sm">Reject</button>
              <button onclick="viewInvoice('${doc.id}')" class="btn btn-primary btn-sm">View</button>
            </div>
          </div>
        `;
      });
      
      if (!html) html = '<p>No pending approvals</p>';
      document.getElementById('pendingApprovalsList').innerHTML = html;
    } catch (error) {
      console.error("Error loading pending approvals:", error);
      alert("Error loading pending approvals: " + error.message);
    }
  }

  async function loadPendingStockApprovals() {
    try {
      let allRequests = [];
      
      // Get online requests
      if (isOnline) {
        const q = query(
          collection(db, 'stockRequests'),
          where('status', '==', 'pending'),
          orderBy('timestamp', 'desc')
        );
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
          allRequests.push({ id: doc.id, ...doc.data() });
        });
      }
      
      // Add offline requests
      allRequests = allRequests.concat(offlineStockRequests);
      
      let html = '';
      allRequests.forEach(request => {
        const isOffline = request.isOffline || false;
        const requestId = request.id || 'offline-' + Math.random().toString(36).substr(2, 9);
        
        html += `
          <div class="card mb-2">
            <div class="card-body p-2">
              <h5 class="mb-1">${request.product.name} (${request.product.size})</h5>
              <p class="mb-1">Operator: ${request.operatorEmail}</p>
              <p class="mb-1">Qty: ${request.quantity}</p>
              <p class="mb-1">Date: ${request.timestamp ? new Date(request.timestamp).toLocaleDateString() : 'N/A'}</p>
              ${isOffline ? '<p class="text-warning mb-1">Offline Request</p>' : ''}
              <button onclick="approveStockRequest('${requestId}', '${request.operatorId}', 
                '${request.product.name}', '${request.product.size}', ${request.quantity}, ${isOffline})" 
                class="btn btn-success btn-sm">Approve</button>
              <button onclick="rejectStockRequest('${requestId}', ${isOffline})" 
                class="btn btn-danger btn-sm">Reject</button>
            </div>
          </div>
        `;
      });
      
      if (!html) html = '<p>No pending requests</p>';
      document.getElementById('pendingStockApprovals').innerHTML = html;
    } catch (error) {
      console.error("Error loading stock requests:", error);
      alert("Error loading stock requests: " + error.message);
    }
  }

  async function loadVanOperatorsSummary() {
    try {
      const querySnapshot = await getDocs(collection(db, 'vanStock'));
      let html = '<table class="table"><thead><tr><th>Operator</th><th>Products</th><th>Stock</th></tr></thead><tbody>';
      
      querySnapshot.forEach(doc => {
        const stock = doc.data().stock;
        let productCount = 0;
        let totalStock = 0;
        
        for (const key in stock) {
          productCount++;
          totalStock += stock[key].remaining;
        }
        
        html += `
          <tr>
            <td>${doc.id.substring(0, 8)}...</td>
            <td>${productCount}</td>
            <td>${totalStock}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('vanOperatorsSummary').innerHTML = html;
    } catch (error) {
      console.error("Error loading van operators summary:", error);
      alert("Error loading van operators: " + error.message);
    }
  }

  async function loadRecentInvoices() {
    try {
      const q = query(
        collection(db, 'invoices'),
        orderBy('createdAt', 'desc'),
        limit(10)
      );
      
      const querySnapshot = await getDocs(q);
      let html = '';
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        html += `
          <tr>
            <td>${invoice.invoiceNo}</td>
            <td>${invoice.invoiceDate.toDate().toLocaleDateString()}</td>
            <td>${invoice.dealer.name.substring(0, 10)}...</td>
            <td>₹${invoice.total.toFixed(2)}</td>
            <td>${invoice.createdBy.substring(0, 10)}...</td>
            <td>${invoice.status}</td>
            <td>
              <button onclick="viewInvoice('${doc.id}')" class="btn btn-primary btn-sm">View</button>
            </td>
          </tr>
        `;
      });
      
      document.getElementById('invoicesList').innerHTML = html;
    } catch (error) {
      console.error("Error loading recent invoices:", error);
      alert("Error loading invoices: " + error.message);
    }
  }

  async function approveInvoice(invoiceId) {
    try {
      await updateDoc(doc(db, 'invoices', invoiceId), {
        status: 'approved',
        approvedAt: serverTimestamp(),
        approvedBy: currentUser.email
      });
      alert('Invoice approved!');
      loadPendingApprovals();
      loadRecentInvoices();
    } catch (error) {
      console.error("Error approving invoice:", error);
      alert('Error approving invoice: ' + error.message);
    }
  }

  async function rejectInvoice(invoiceId) {
    try {
      await updateDoc(doc(db, 'invoices', invoiceId), {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        rejectedBy: currentUser.email
      });
      alert('Invoice rejected!');
      loadPendingApprovals();
      loadRecentInvoices();
    } catch (error) {
      console.error("Error rejecting invoice:", error);
      alert('Error rejecting invoice: ' + error.message);
    }
  }

  async function approveStockRequest(requestId, operatorId, productName, productSize, quantity, isOffline) {
    try {
      if (!isOffline) {
        // Update request status in Firestore
        await updateDoc(doc(db, 'stockRequests', requestId), {
            status: 'approved',
            approvedAt: serverTimestamp(),
            approvedBy: currentUser.email
        });
      } else {
        // Remove from offline requests
        const index = offlineStockRequests.findIndex(req => 
            req.operatorId === operatorId && 
            req.product.name === productName && 
            req.product.size === productSize &&
            req.quantity === quantity
        );
        if (index !== -1) {
            offlineStockRequests.splice(index, 1);
            localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
        }
      }
      
      // Record stock transaction
      await addDoc(collection(db, 'stockTransactions'), {
        type: 'load',
        product: {
          name: productName,
          size: productSize
        },
        quantity: quantity,
        operatorId: operatorId,
        operatorEmail: isOffline ? 'Offline Sync' : currentUser.email,
        timestamp: serverTimestamp(),
        approvedBy: currentUser.email
      });
      
      // Update van stock
      const productKey = `${productName}|${productSize}`;
      const vanStockRef = doc(db, 'vanStock', operatorId);
      const vanStockDoc = await getDoc(vanStockRef);
      
      let stockData = vanStockDoc.exists() ? vanStockDoc.data().stock : {};
      
      if (!stockData[productKey]) {
        stockData[productKey] = {
          name: productName,
          size: productSize,
          loaded: 0,
          sold: 0,
          remaining: 0
        };
      }
      
      stockData[productKey].loaded += quantity;
      stockData[productKey].remaining += quantity;
      
      await setDoc(vanStockRef, { 
        stock: stockData,
        lastUpdated: serverTimestamp()
      });
      
      // Update warehouse stock
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseDoc = await getDoc(warehouseRef);
      
      let warehouseData = warehouseDoc.exists() ? warehouseDoc.data() : {};
      if (!warehouseData[productKey]) {
        warehouseData[productKey] = 0;
      }
      
      warehouseData[productKey] -= quantity;
      
      await setDoc(warehouseRef, warehouseData);
      
      alert('Stock request approved and updated!');
      loadPendingStockApprovals();
      loadWarehouseStock();
    } catch (error) {
      console.error("Error approving stock request:", error);
      alert('Error approving stock request: ' + error.message);
    }
  }

  async function rejectStockRequest(requestId, isOffline) {
    try {
      if (!isOffline) {
        await updateDoc(doc(db, 'stockRequests', requestId), {
          status: 'rejected',
          rejectedAt: serverTimestamp(),
          rejectedBy: currentUser.email
        });
      } else {
        // Remove from offline requests
        const index = offlineStockRequests.findIndex(req => req.id === requestId);
        if (index !== -1) {
          offlineStockRequests.splice(index, 1);
          localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
        }
      }
      
      alert('Stock request rejected!');
      loadPendingStockApprovals();
    } catch (error) {
      console.error("Error rejecting stock request:", error);
      alert('Error rejecting stock request: ' + error.message);
    }
  }

  async function viewInvoice(invoiceId) {
    try {
      const docRef = doc(db, 'invoices', invoiceId);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const invoice = docSnap.data();
        let itemsHTML = '';
        
        invoice.items.forEach(item => {
          itemsHTML += `
            <tr>
              <td>${item.name}</td>
              <td>${item.size}</td>
              <td>${item.qty}</td>
              <td>₹${item.rate.toFixed(2)}</td>
              <td>₹${item.amount.toFixed(2)}</td>
            </tr>
          `;
        });
        
        const modalBody = `
          <div class="company-header">
            <h2>Campa Beverages Pvt. Ltd.</h2>
            <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
            <p><strong>Date:</strong> ${invoice.invoiceDate.toDate().toLocaleDateString()}</p>
            <p><strong>Status:</strong> ${invoice.status}</p>
            <p><strong>Operator:</strong> ${invoice.createdBy}</p>
          </div>
          
          <div class="mt-2">
            <h4>Dealer Information</h4>
            <p><strong>Name:</strong> ${invoice.dealer.name}</p>
            <p><strong>Address:</strong> ${invoice.dealer.address || 'N/A'}</p>
            <p><strong>GSTIN:</strong> ${invoice.dealer.gstin || 'N/A'}</p>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="table-bordered mt-2">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Size</th>
                  <th>Qty</th>
                  <th>Rate</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>${itemsHTML}</tbody>
            </table>
          </div>
          
          <div class="right mt-2">
            <h4>Subtotal: ₹${invoice.subtotal.toFixed(2)}</h4>
            <h4>GST (18%): ₹${invoice.gst.toFixed(2)}</h4>
            <h3>Total: ₹${invoice.total.toFixed(2)}</h3>
          </div>
        `;
        
        document.getElementById('invoiceModalBody').innerHTML = modalBody;
        
        // Add approval buttons if pending
        const approvalButtons = document.getElementById('approvalButtons');
        if (invoice.status === 'pending') {
          approvalButtons.innerHTML = `
            <button onclick="approveInvoice('${invoiceId}')" class="btn btn-success btn-sm">Approve</button>
            <button onclick="rejectInvoice('${invoiceId}')" class="btn btn-danger btn-sm">Reject</button>
          `;
        } else {
          approvalButtons.innerHTML = '';
        }
        
        const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
        modal.show();
      }
    } catch (error) {
      console.error("Error loading invoice:", error);
      alert('Error loading invoice: ' + error.message);
    }
  }

  // Export invoices
  function exportInvoices(format) {
    try {
      const table = document.getElementById('invoicesList');
      const rows = table.querySelectorAll('tr');
      
      const data = [];
      const headers = ['Invoice No', 'Date', 'Dealer', 'Amount', 'Operator', 'Status'];
      data.push(headers);
      
      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        if (cols.length > 0) {
          const rowData = [
            cols[0].innerText,
            cols[1].innerText,
            cols[2].innerText,
            cols[3].innerText,
            cols[4].innerText,
            cols[5].innerText
          ];
          data.push(rowData);
        }
      });
      
      if (format === 'csv') {
        let csv = '';
        data.forEach(row => {
          csv += row.join(',') + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'campa_invoices.csv';
        a.click();
      } else if (format === 'excel') {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Invoices');
        XLSX.writeFile(wb, 'campa_invoices.xlsx');
      }
    } catch (error) {
      console.error("Error exporting invoices:", error);
      alert('Error exporting invoices: ' + error.message);
    }
  }

  // Dashboard functions
  document.getElementById('dashboardTab').addEventListener('shown.bs.tab', function() {
    loadDashboardData();
  });

  document.getElementById('dashboardTimeRange').addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    document.getElementById('customDateRange').style.display = isCustom ? 'block' : 'none';
    document.getElementById('customDateRangeEnd').style.display = isCustom ? 'block' : 'none';
    
    if (!isCustom) {
      loadDashboardData();
    }
  });

  // Toggle between product and quantity views
  function toggleView() {
    const productView = document.getElementById('productView');
    const quantityView = document.getElementById('quantityView');
    
    if (currentView === 'product') {
      productView.style.display = 'none';
      quantityView.style.display = 'block';
      currentView = 'quantity';
    } else {
      productView.style.display = 'block';
      quantityView.style.display = 'none';
      currentView = 'product';
    }
    
    // Redraw charts for the current view
    loadDashboardData();
  }

  // Toggle chart type (line/bar)
  function toggleChartType(chartGroup) {
    currentChartType[chartGroup] = currentChartType[chartGroup] === 'line' ? 'bar' : 'line';
    loadDashboardData();
  }

  async function loadDashboardData() {
    try {
      const timeRange = document.getElementById('dashboardTimeRange').value;
      let startDate, endDate, previousStartDate, previousEndDate;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Set date ranges based on selection
      switch(timeRange) {
        case 'today':
          startDate = new Date(today);
          endDate = new Date(today);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today);
          previousStartDate.setDate(today.getDate() - 1);
          previousEndDate = new Date(previousStartDate);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'week':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
          endDate = new Date(today);
          endDate.setDate(today.getDate() + (6 - today.getDay())); // End of week (Saturday)
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(startDate);
          previousStartDate.setDate(startDate.getDate() - 7);
          previousEndDate = new Date(endDate);
          previousEndDate.setDate(endDate.getDate() - 7);
          break;
          
        case 'month':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          previousEndDate = new Date(today.getFullYear(), today.getMonth(), 0);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'quarter':
          const quarter = Math.floor(today.getMonth() / 3);
          startDate = new Date(today.getFullYear(), quarter * 3, 1);
          endDate = new Date(today.getFullYear(), (quarter * 3) + 3, 0);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today.getFullYear(), (quarter * 3) - 3, 1);
          previousEndDate = new Date(today.getFullYear(), quarter * 3, 0);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'year':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = new Date(today.getFullYear(), 11, 31);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today.getFullYear() - 1, 0, 1);
          previousEndDate = new Date(today.getFullYear() - 1, 11, 31);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'custom':
          startDate = new Date(document.getElementById('dashboardStartDate').value);
          endDate = new Date(document.getElementById('dashboardEndDate').value);
          endDate.setHours(23, 59, 59, 999);
          
          if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
          }
          
          // For custom range, we won't calculate previous period comparison
          previousStartDate = null;
          previousEndDate = null;
          break;
      }
      
      // Get current period data
      const currentData = await getDashboardData(startDate, endDate);
      
      // Get previous period data if not custom range
      let previousData = {};
      if (timeRange !== 'custom') {
        previousData = await getDashboardData(previousStartDate, previousEndDate);
      }
      
      // Update summary cards
      updateSummaryCards(currentData, previousData);
      
      // Update charts
      updateCharts(currentData);
      
      // Update recent transactions
      updateRecentTransactions(currentData.recentTransactions);
      
      // Update stock alerts
      await updateStockAlerts();
      
    } catch (error) {
      console.error("Error loading dashboard data:", error);
      alert('Error loading dashboard: ' + error.message);
    }
  }

  async function getDashboardData(startDate, endDate) {
    const result = {
      totalSales: 0,
      totalQuantity: 0,
      totalProducts: 0,
      transactionCount: 0,
      salesByDay: {},
      quantityByDay: {},
      salesByProduct: {},
      quantityByProduct: {},
      recentTransactions: [],
      dailySummaries: []
    };
    
    // Get invoices for the period
    const invoicesQuery = query(
      collection(db, 'invoices'),
      where('invoiceDate', '>=', startDate),
      where('invoiceDate', '<=', endDate),
      where('status', '==', 'approved'),
      orderBy('invoiceDate', 'desc')
    );
    
    const invoicesSnapshot = await getDocs(invoicesQuery);
    result.transactionCount = invoicesSnapshot.size;
    
    // Process each invoice
    invoicesSnapshot.forEach(doc => {
      const invoice = doc.data();
      const invoiceDate = invoice.invoiceDate.toDate();
      const dayKey = invoiceDate.toLocaleDateString();
      
      result.totalSales += invoice.total;
      
      // Initialize daily summaries if not exists
      if (!result.dailySummaries.find(d => d.date === dayKey)) {
        result.dailySummaries.push({
          date: dayKey,
          invoices: 0,
          quantity: 0,
          revenue: 0
        });
      }
      
      // Update daily summary
      const dailySummary = result.dailySummaries.find(d => d.date === dayKey);
      dailySummary.invoices += 1;
      dailySummary.revenue += invoice.total;
      
      // Process items
      invoice.items.forEach(item => {
        const productQty = item.qty;
        result.totalQuantity += productQty;
        result.totalProducts += 1;
        dailySummary.quantity += productQty;
        
        // Group by day
        if (!result.salesByDay[dayKey]) {
          result.salesByDay[dayKey] = 0;
          result.quantityByDay[dayKey] = 0;
        }
        result.salesByDay[dayKey] += item.amount;
        result.quantityByDay[dayKey] += productQty;
        
        // Group by product
        const productKey = `${item.name}|${item.size}`;
        if (!result.salesByProduct[productKey]) {
          result.salesByProduct[productKey] = {
            name: item.name,
            size: item.size,
            quantity: 0,
            sales: 0
          };
          result.quantityByProduct[productKey] = {
            name: item.name,
            size: item.size,
            quantity: 0,
            sales: 0
          };
        }
        result.salesByProduct[productKey].quantity += productQty;
        result.salesByProduct[productKey].sales += item.amount;
        result.quantityByProduct[productKey].quantity += productQty;
        result.quantityByProduct[productKey].sales += item.amount;
      });
      
      // Add to recent transactions
      if (result.recentTransactions.length < 5) {
        result.recentTransactions.push({
          time: invoiceDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          dealer: invoice.dealer.name,
          amount: invoice.total
        });
      }
    });
    
    // Sort daily summaries by date
    result.dailySummaries.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    return result;
  }

  function updateSummaryCards(currentData, previousData = {}) {
    document.getElementById('totalSales').textContent = `₹${currentData.totalSales.toFixed(2)}`;
    document.getElementById('totalQuantity').textContent = currentData.totalQuantity;
    document.getElementById('totalProducts').textContent = Object.keys(currentData.salesByProduct).length;
    
    const avgSale = currentData.transactionCount > 0 
      ? currentData.totalSales / currentData.transactionCount 
      : 0;
    document.getElementById('avgSale').textContent = `₹${avgSale.toFixed(2)}`;
    
    // Calculate changes vs previous period if available
    if (previousData.totalSales !== undefined) {
      updateChangeIndicator('sales', currentData.totalSales, previousData.totalSales);
      updateChangeIndicator('quantity', currentData.totalQuantity, previousData.totalQuantity);
      updateChangeIndicator('products', Object.keys(currentData.salesByProduct).length, 
        Object.keys(previousData.salesByProduct || {}).length);
      
      const prevAvgSale = previousData.transactionCount > 0 
        ? previousData.totalSales / previousData.transactionCount 
        : 0;
      updateChangeIndicator('avgSale', avgSale, prevAvgSale);
    }
  }

  function updateChangeIndicator(field, current, previous) {
    const change = previous > 0 
      ? ((current - previous) / previous) * 100 
      : current > 0 ? 100 : 0;
    
    const element = document.getElementById(`${field}Change`);
    element.textContent = `${change.toFixed(1)}%`;
    element.className = change >= 0 ? 'text-success' : 'text-danger';
  }

  function updateCharts(data) {
    // Sales Trend Chart
    const days = Object.keys(data.salesByDay);
    const salesData = days.map(day => data.salesByDay[day]);
    const quantityData = days.map(day => data.quantityByDay[day]);
    
    updateTrendChart('salesTrendChart', days, salesData, 'Daily Sales', 'Revenue (₹)', currentChartType.sales);
    updateTrendChart('quantityTrendChart', days, quantityData, 'Daily Quantity', 'Items Sold', currentChartType.quantity);
    
    // Top Products Charts
    const topProductsByRevenue = Object.values(data.salesByProduct)
      .sort((a, b) => b.sales - a.sales)
      .slice(0, 5);
    
    const topProductsByQuantity = Object.values(data.quantityByProduct)
      .sort((a, b) => b.quantity - a.quantity)
      .slice(0, 5);
    
    updateTopProductsChart('topProductsChart', 
      topProductsByRevenue.map(p => `${p.name} (${p.size})`),
      topProductsByRevenue.map(p => p.sales),
      'Top Products by Revenue');
    
    updateTopProductsChart('topQuantityChart', 
      topProductsByQuantity.map(p => `${p.name} (${p.size})`),
      topProductsByQuantity.map(p => p.quantity),
      'Top Products by Quantity');
    
    // Update tables
    updateProductPerformanceTable(data.salesByProduct);
    updateDailySummaryTable(data.dailySummaries);
  }

  function updateTrendChart(canvasId, labels, data, label, yLabel, chartType) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Destroy previous chart if exists
    if (canvasId === 'salesTrendChart' && salesTrendChart) {
      salesTrendChart.destroy();
    } else if (canvasId === 'quantityTrendChart' && quantityTrendChart) {
      quantityTrendChart.destroy();
    }
    
    const newChart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          backgroundColor: chartType === 'bar' ? 'rgba(54, 162, 235, 0.7)' : 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: chartType === 'bar' ? 1 : 2,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: yLabel
            }
          }
        }
      }
    });
    
    if (canvasId === 'salesTrendChart') {
      salesTrendChart = newChart;
    } else {
      quantityTrendChart = newChart;
    }
  }

  function updateTopProductsChart(canvasId, labels, data, title) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Destroy previous chart if exists
    if (canvasId === 'topProductsChart' && topProductsChart) {
      topProductsChart.destroy();
    } else if (canvasId === 'topQuantityChart' && topQuantityChart) {
      topQuantityChart.destroy();
    }
    
    const newChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          },
          title: {
            display: true,
            text: title
          }
        }
      }
    });
    
    if (canvasId === 'topProductsChart') {
      topProductsChart = newChart;
    } else {
      topQuantityChart = newChart;
    }
  }

  // Table update functions
  function updateProductPerformanceTable(productsData) {
    const tbody = document.getElementById('productPerformance');
    tbody.innerHTML = '';
    
    const productsArray = Object.values(productsData);
    const totalSales = productsArray.reduce((sum, p) => sum + p.sales, 0);
    
    // Sort by revenue descending
    productsArray.sort((a, b) => b.sales - a.sales);
    
    productsArray.forEach(product => {
      const percentage = totalSales > 0 ? (product.sales / totalSales * 100) : 0;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${product.name}</td>
        <td>${product.size}</td>
        <td>${product.quantity}</td>
        <td>₹${product.sales.toFixed(2)}</td>
        <td>${percentage.toFixed(1)}%</td>
      `;
      tbody.appendChild(row);
    });
  }

  function updateDailySummaryTable(dailySummaries) {
    const tbody = document.getElementById('dailySummary');
    tbody.innerHTML = '';
    
    dailySummaries.forEach(day => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${day.date}</td>
        <td>${day.invoices}</td>
        <td>${day.quantity}</td>
        <td>₹${day.revenue.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });
  }

  function updateRecentTransactions(transactions) {
    const tbody = document.getElementById('recentTransactions');
    tbody.innerHTML = '';
    
    transactions.forEach(tx => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${tx.time}</td>
        <td>${tx.dealer.substring(0, 15)}${tx.dealer.length > 15 ? '...' : ''}</td>
        <td>₹${tx.amount.toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });
  }

  async function updateStockAlerts() {
    try {
      const tbody = document.getElementById('stockAlerts');
      tbody.innerHTML = '';
      
      // Get warehouse stock
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        // Check for low stock items
        for (const [key, qty] of Object.entries(warehouseData)) {
          if (qty < 10) { // Threshold for low stock
            const [name, size] = key.split('|');
            const row = document.createElement('tr');
            row.className = qty === 0 ? 'table-danger' : 'table-warning';
            row.innerHTML = `
              <td>${name} (${size})</td>
              <td>${qty}</td>
              <td>${qty === 0 ? 'Out of Stock' : 'Low Stock'}</td>
            `;
            tbody.appendChild(row);
          }
        }
      }
      
      // If no alerts, show message
      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center">No stock alerts</td></tr>';
      }
      
    } catch (error) {
      console.error("Error loading stock alerts:", error);
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading stock alerts</td></tr>';
    }
  }

  // Export dashboard data
  async function exportDashboardData(range) {
    try {
      // Determine date range
      let startDate, endDate = new Date();
      endDate.setHours(23, 59, 59, 999);
      
      switch(range) {
        case 'today':
          startDate = new Date();
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate = new Date();
          startDate.setDate(endDate.getDate() - endDate.getDay()); // Start of week (Sunday)
          break;
        case 'month':
          startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
          break;
        default:
          startDate = new Date(0); // All time
      }
      
      // Get data
      const data = await getDashboardData(startDate, endDate);
      
      // Prepare data for export
      const exportData = {
        summary: {
          totalSales: data.totalSales,
          totalQuantity: data.totalQuantity,
          totalProducts: Object.keys(data.salesByProduct).length,
          transactionCount: data.transactionCount
        },
        products: Object.values(data.salesByProduct)
          .sort((a, b) => b.sales - a.sales)
          .map(p => ({
            product: `${p.name} (${p.size})`,
            quantity: p.quantity,
            revenue: p.sales
          })),
        dailySummary: data.dailySummaries
      };
      
      // Create CSV
      let csv = 'Category,Details\n';
      csv += `Period,${range}\n`;
      csv += `Start Date,${startDate.toLocaleDateString()}\n`;
      csv += `End Date,${endDate.toLocaleDateString()}\n\n`;
      
      // Summary section
      csv += 'SUMMARY\n';
      csv += 'Metric,Value\n';
      csv += `Total Sales,${exportData.summary.totalSales.toFixed(2)}\n`;
      csv += `Total Quantity,${exportData.summary.totalQuantity}\n`;
      csv += `Unique Products,${exportData.summary.totalProducts}\n`;
      csv += `Transactions,${exportData.summary.transactionCount}\n\n`;
      
      // Products section
      csv += 'PRODUCT PERFORMANCE\n';
      csv += 'Product,Quantity,Revenue\n';
      exportData.products.forEach(p => {
        csv += `${p.product},${p.quantity},${p.revenue.toFixed(2)}\n`;
      });
      csv += '\n';
      
      // Daily summary
      csv += 'DAILY SUMMARY\n';
      csv += 'Date,Invoices,Quantity,Revenue\n';
      exportData.dailySummary.forEach(d => {
        csv += `${d.date},${d.invoices},${d.quantity},${d.revenue.toFixed(2)}\n`;
      });
      
      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `campa_sales_${range}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      
    } catch (error) {
      console.error("Error exporting data:", error);
      alert('Error exporting data: ' + error.message);
    }
  }

  // Expose functions to global scope
  window.login = login;
  window.logout = logout;
  window.addProduct = addProduct;
  window.removeItem = removeItem;
  window.saveInvoice = saveInvoice;
  window.printInvoice = printInvoice;
  window.saveDraft = saveDraft;
  window.requestStock = requestStock;
  window.approveInvoice = approveInvoice;
  window.rejectInvoice = rejectInvoice;
  window.approveStockRequest = approveStockRequest;
  window.rejectStockRequest = rejectStockRequest;
  window.viewInvoice = viewInvoice;
  window.printInvoiceFromModal = printInvoiceFromModal;
  window.exportInvoices = exportInvoices;
  window.updateWarehouseStock = updateWarehouseStock;
  window.loadDashboardData = loadDashboardData;
  window.toggleView = toggleView;
  window.toggleChartType = toggleChartType;
  window.loadOperatorSales = loadOperatorSales;
  window.exportOperatorSales = exportOperatorSales;
  window.exportDashboardData = exportDashboardData;

  // Initialize the app when page loads
  window.onload = initApp;
</script>
</body>
</html>
