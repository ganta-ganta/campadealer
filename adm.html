<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUPREME ENTERPRISES - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    
    .main-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      overflow: hidden;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header-section {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .header-section::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      animation: float 20s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    .company-logo {
      font-size: 3rem;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }
    
    .company-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .company-subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }
    
    .nav-tabs {
      background: var(--light-color);
      border-bottom: none;
      padding: 0 30px;
    }
    
    .nav-link {
      border: none;
      color: var(--dark-color);
      font-weight: 600;
      padding: 20px 25px;
      margin: 0 5px;
      border-radius: 15px 15px 0 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .nav-link:hover {
      background: rgba(52, 152, 219, 0.1);
      color: var(--secondary-color);
      transform: translateY(-2px);
    }
    
    .nav-link.active {
      background: white;
      color: var(--primary-color);
      box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
    }
    
    .tab-content {
      padding: 30px;
      min-height: 600px;
    }
    
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 25px;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .card-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      padding: 20px 25px;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .card-body {
      padding: 25px;
    }
    
    .stats-card {
      text-align: center;
      padding: 30px 20px;
      border-radius: 20px;
      color: white;
      position: relative;
      overflow: hidden;
    }
    
    .stats-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      transition: all 0.3s ease;
    }
    
    .stats-card:hover::before {
      transform: scale(1.2);
    }
    
    .stats-icon {
      font-size: 3rem;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }
    
    .stats-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }
    
    .stats-label {
      font-size: 1rem;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }
    
    .bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .bg-gradient-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .bg-gradient-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    
    .btn {
      border-radius: 10px;
      font-weight: 600;
      padding: 12px 25px;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); }
    .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .btn-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .btn-danger { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
    
    .table {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    }
    
    .table thead th {
      background: var(--primary-color);
      color: white;
      border: none;
      font-weight: 600;
      padding: 15px;
    }
    
    .table tbody tr {
      transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
      background: rgba(52, 152, 219, 0.05);
      transform: scale(1.01);
    }
    
    .table tbody td {
      padding: 15px;
      border-color: rgba(0,0,0,0.05);
    }
    
    .form-control, .form-select {
      border-radius: 10px;
      border: 2px solid #e9ecef;
      padding: 12px 15px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .modal-content {
      border-radius: 20px;
      border: none;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      border: none;
      border-radius: 20px 20px 0 0;
    }
    
    .badge {
      border-radius: 20px;
      padding: 8px 15px;
      font-weight: 600;
    }
    
    .alert {
      border-radius: 15px;
      border: none;
      padding: 20px;
      margin-bottom: 25px;
    }
    
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .login-card {
      background: white;
      border-radius: 25px;
      box-shadow: 0 30px 80px rgba(0,0,0,0.2);
      overflow: hidden;
      max-width: 400px;
      width: 100%;
    }
    
    .login-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 40px 30px;
      text-align: center;
    }
    
    .login-body {
      padding: 40px 30px;
    }
    
    .chart-container {
      position: relative;
      height: 400px;
      margin: 20px 0;
    }
    
    .export-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
    }
    
    .export-btn {
      margin: 5px;
      min-width: 120px;
    }
    
    .status-pending { background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); }
    .status-approved { background: linear-gradient(135deg, #55efc4 0%, #81ecec 100%); }
    .status-rejected { background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%); }
    
    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      body { padding: 10px; }
      .main-container { border-radius: 15px; }
      .header-section { padding: 20px; }
      .company-title { font-size: 2rem; }
      .tab-content { padding: 20px; }
      .nav-link { padding: 15px 20px; font-size: 0.9rem; }
      .stats-card { padding: 20px 15px; }
      .stats-number { font-size: 2rem; }
    }
    
    /* Print Styles */
    @media print {
      body { background: white !important; padding: 0 !important; }
      .main-container { box-shadow: none !important; border-radius: 0 !important; }
      .header-section, .nav-tabs, .btn, .export-section { display: none !important; }
      .tab-content { padding: 20px !important; }
      .card { box-shadow: none !important; border: 1px solid #ddd !important; }
      .table { font-size: 12px !important; }
      .page-break { page-break-before: always; }
    }
  </style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="login-container">
  <div class="login-card">
    <div class="login-header">
      <i class="bi bi-shield-lock-fill" style="font-size: 3rem; margin-bottom: 15px;"></i>
      <h2>SUPREME ENTERPRISES</h2>
      <p class="mb-0">Admin Dashboard</p>
    </div>
    <div class="login-body">
      <form onsubmit="login(event)">
        <div class="mb-3">
          <label class="form-label">Email Address</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
            <input type="email" id="loginEmail" class="form-control" placeholder="admin@supremeenterprises.com" required>
          </div>
        </div>
        <div class="mb-4">
          <label class="form-label">Password</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-lock"></i></span>
            <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" required>
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-box-arrow-in-right"></i> Login to Dashboard
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Main Dashboard -->
<div id="mainApp" class="main-container hidden">
  <!-- Header Section -->
  <div class="header-section">
    <div class="company-logo">
      <i class="bi bi-cup-hot-fill"></i>
    </div>
    <h1 class="company-title">SUPREME ENTERPRISES</h1>
    <p class="company-subtitle">Premium Beverage Distribution - Admin Dashboard</p>
    <div class="mt-3">
      <span class="badge bg-light text-dark me-2">
        <i class="bi bi-person-circle"></i> Welcome, Admin
      </span>
      <button onclick="logout()" class="btn btn-outline-light btn-sm">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs" id="mainTabs">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#dashboardTab">
        <i class="bi bi-speedometer2"></i> Dashboard
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#invoicesTab">
        <i class="bi bi-receipt"></i> Invoices
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#inventoryTab">
        <i class="bi bi-boxes"></i> Inventory
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#operatorsTab">
        <i class="bi bi-people"></i> Operators
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#reportsTab">
        <i class="bi bi-graph-up"></i> Reports
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#settingsTab">
        <i class="bi bi-gear"></i> Settings
      </a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content">
    <!-- Dashboard Tab -->
    <div class="tab-pane fade show active" id="dashboardTab">
      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card bg-gradient-primary">
            <div class="stats-icon">
              <i class="bi bi-currency-rupee"></i>
            </div>
            <div class="stats-number" id="totalRevenue">₹0</div>
            <div class="stats-label">Total Revenue</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card bg-gradient-success">
            <div class="stats-icon">
              <i class="bi bi-receipt"></i>
            </div>
            <div class="stats-number" id="totalInvoices">0</div>
            <div class="stats-label">Total Invoices</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card bg-gradient-warning">
            <div class="stats-icon">
              <i class="bi bi-box-seam"></i>
            </div>
            <div class="stats-number" id="totalProducts">0</div>
            <div class="stats-label">Products Sold</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card bg-gradient-info">
            <div class="stats-icon">
              <i class="bi bi-people"></i>
            </div>
            <div class="stats-number" id="activeOperators">0</div>
            <div class="stats-label">Active Operators</div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-graph-up"></i> Sales Trend (Last 30 Days)
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="salesChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-pie-chart"></i> Top Products
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="productsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-clock-history"></i> Recent Invoices
            </div>
            <div class="card-body">
              <div id="recentInvoices">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-2">Loading recent invoices...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-exclamation-triangle"></i> Stock Alerts
            </div>
            <div class="card-body">
              <div id="stockAlerts">
                <div class="text-center py-4">
                  <div class="spinner-border text-warning" role="status"></div>
                  <p class="mt-2">Loading stock alerts...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoices Tab -->
    <div class="tab-pane fade" id="invoicesTab">
      <!-- Export Section -->
      <div class="export-section">
        <h5><i class="bi bi-download"></i> Export Invoice Data</h5>
        <p class="text-muted mb-3">Download comprehensive invoice reports in Excel format</p>
        <div class="row">
          <div class="col-md-3">
            <button onclick="exportInvoices('today')" class="btn btn-primary export-btn">
              <i class="bi bi-file-earmark-excel"></i> Today
            </button>
          </div>
          <div class="col-md-3">
            <button onclick="exportInvoices('week')" class="btn btn-success export-btn">
              <i class="bi bi-file-earmark-excel"></i> This Week
            </button>
          </div>
          <div class="col-md-3">
            <button onclick="exportInvoices('month')" class="btn btn-warning export-btn">
              <i class="bi bi-file-earmark-excel"></i> This Month
            </button>
          </div>
          <div class="col-md-3">
            <button onclick="exportInvoices('all')" class="btn btn-info export-btn">
              <i class="bi bi-file-earmark-excel"></i> All Data
            </button>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-funnel"></i> Filter Invoices
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Date From</label>
              <input type="date" id="invoiceDateFrom" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Date To</label>
              <input type="date" id="invoiceDateTo" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select id="invoiceStatus" class="form-select">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="approved">Approved</option>
                <option value="rejected">Rejected</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Operator</label>
              <select id="invoiceOperator" class="form-select">
                <option value="">All Operators</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <button onclick="filterInvoices()" class="btn btn-primary">
              <i class="bi bi-search"></i> Apply Filters
            </button>
            <button onclick="clearInvoiceFilters()" class="btn btn-secondary">
              <i class="bi bi-x-circle"></i> Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Invoices Table -->
      <div class="card">
        <div class="card-header">
          <i class="bi bi-table"></i> All Invoices
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Invoice No</th>
                  <th>Date</th>
                  <th>Dealer</th>
                  <th>Operator</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="invoicesTableBody">
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading invoices...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Inventory Tab -->
    <div class="tab-pane fade" id="inventoryTab">
      <!-- Export Section -->
      <div class="export-section">
        <h5><i class="bi bi-download"></i> Export Inventory Data</h5>
        <p class="text-muted mb-3">Download warehouse and stock movement reports</p>
        <div class="row">
          <div class="col-md-4">
            <button onclick="exportWarehouseStock()" class="btn btn-primary export-btn">
              <i class="bi bi-file-earmark-excel"></i> Warehouse Stock
            </button>
          </div>
          <div class="col-md-4">
            <button onclick="exportStockMovements()" class="btn btn-success export-btn">
              <i class="bi bi-file-earmark-excel"></i> Stock Movements
            </button>
          </div>
          <div class="col-md-4">
            <button onclick="exportVanStock()" class="btn btn-warning export-btn">
              <i class="bi bi-file-earmark-excel"></i> Van Stock
            </button>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Warehouse Management -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-building"></i> Warehouse Stock
            </div>
            <div class="card-body">
              <!-- Add Stock Form -->
              <div class="mb-4">
                <h6>Add/Remove Stock</h6>
                <div class="row">
                  <div class="col-md-6">
                    <select id="warehouseProduct" class="form-select mb-2">
                      <option value="">Select Product</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <input type="number" id="warehouseQty" class="form-control" placeholder="Qty" min="1">
                  </div>
                  <div class="col-md-3">
                    <select id="warehouseAction" class="form-select">
                      <option value="add">Add</option>
                      <option value="remove">Remove</option>
                    </select>
                  </div>
                </div>
                <button onclick="updateWarehouseStock()" class="btn btn-primary mt-2">
                  <i class="bi bi-arrow-repeat"></i> Update Stock
                </button>
              </div>

              <!-- Current Stock -->
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Size</th>
                      <th>Quantity</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="warehouseStockTable">
                    <tr>
                      <td colspan="4" class="text-center">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Stock Requests -->
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-truck"></i> Stock Requests
            </div>
            <div class="card-body">
              <div id="stockRequestsList">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="mt-2">Loading stock requests...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stock Movement History -->
      <div class="card mt-4">
        <div class="card-header">
          <i class="bi bi-clock-history"></i> Stock Movement History
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Product</th>
                  <th>Type</th>
                  <th>Quantity</th>
                  <th>Operator</th>
                  <th>Action By</th>
                </tr>
              </thead>
              <tbody id="stockMovementTable">
                <tr>
                  <td colspan="6" class="text-center">Loading stock movements...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Operators Tab -->
    <div class="tab-pane fade" id="operatorsTab">
      <!-- Export Section -->
      <div class="export-section">
        <h5><i class="bi bi-download"></i> Export Operator Data</h5>
        <p class="text-muted mb-3">Download operator performance and sales reports</p>
        <div class="row">
          <div class="col-md-4">
            <button onclick="exportOperatorPerformance()" class="btn btn-primary export-btn">
              <i class="bi bi-file-earmark-excel"></i> Performance Report
            </button>
          </div>
          <div class="col-md-4">
            <button onclick="exportOperatorSales()" class="btn btn-success export-btn">
              <i class="bi bi-file-earmark-excel"></i> Sales Report
            </button>
          </div>
          <div class="col-md-4">
            <button onclick="exportOperatorStock()" class="btn btn-warning export-btn">
              <i class="bi bi-file-earmark-excel"></i> Stock Report
            </button>
          </div>
        </div>
      </div>

      <!-- Operator Performance -->
      <div class="card">
        <div class="card-header">
          <i class="bi bi-people"></i> Operator Performance
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Operator</th>
                  <th>Total Sales</th>
                  <th>Invoices</th>
                  <th>Products Sold</th>
                  <th>Avg. Invoice</th>
                  <th>Stock Requests</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="operatorPerformanceTable">
                <tr>
                  <td colspan="7" class="text-center">Loading operator data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-pane fade" id="reportsTab">
      <!-- Export Section -->
      <div class="export-section">
        <h5><i class="bi bi-download"></i> Comprehensive Reports</h5>
        <p class="text-muted mb-3">Generate detailed business reports with all transaction data</p>
        <div class="row">
          <div class="col-md-3">
            <button onclick="exportDailyReport()" class="btn btn-primary export-btn">
              <i class="bi bi-file-earmark-excel"></i> Daily Report
            </button>
          </div>
          <div class="col-md-3">
            <button onclick="exportWeeklyReport()" class="btn btn-success export-btn">
              <i class="bi bi-file-earmark-excel"></i> Weekly Report
            </button>
          </div>
          <div class="col-md-3">
            <button onclick="exportMonthlyReport()" class="btn btn-warning export-btn">
              <i class="bi bi-file-earmark-excel"></i> Monthly Report
            </button>
          </div>
          <div class="col-md-3">
            <button onclick="exportCustomReport()" class="btn btn-info export-btn">
              <i class="bi bi-file-earmark-excel"></i> Custom Report
            </button>
          </div>
        </div>
      </div>

      <!-- Report Filters -->
      <div class="card mb-4">
        <div class="card-header">
          <i class="bi bi-funnel"></i> Report Filters
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Report Type</label>
              <select id="reportType" class="form-select">
                <option value="sales">Sales Report</option>
                <option value="inventory">Inventory Report</option>
                <option value="operator">Operator Report</option>
                <option value="comprehensive">Comprehensive Report</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Date From</label>
              <input type="date" id="reportDateFrom" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Date To</label>
              <input type="date" id="reportDateTo" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Format</label>
              <select id="reportFormat" class="form-select">
                <option value="excel">Excel (.xlsx)</option>
                <option value="csv">CSV (.csv)</option>
              </select>
            </div>
          </div>
          <div class="mt-3">
            <button onclick="generateCustomReport()" class="btn btn-primary">
              <i class="bi bi-file-earmark-excel"></i> Generate Report
            </button>
          </div>
        </div>
      </div>

      <!-- Analytics Charts -->
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-bar-chart"></i> Monthly Sales Trend
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="monthlySalesChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-pie-chart"></i> Product Distribution
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="productDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade" id="settingsTab">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-gear"></i> System Settings
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Company Name</label>
                <input type="text" class="form-control" value="SUPREME ENTERPRISES" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label">GST Number</label>
                <input type="text" id="companyGST" class="form-control" placeholder="Enter GST Number">
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea id="companyAddress" class="form-control" rows="3" placeholder="Enter company address"></textarea>
              </div>
              <button onclick="saveSettings()" class="btn btn-primary">
                <i class="bi bi-save"></i> Save Settings
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-database"></i> Data Management
            </div>
            <div class="card-body">
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Warning:</strong> These actions cannot be undone.
              </div>
              <button onclick="backupData()" class="btn btn-info mb-2">
                <i class="bi bi-download"></i> Backup All Data
              </button>
              <br>
              <button onclick="clearOldData()" class="btn btn-warning mb-2">
                <i class="bi bi-trash"></i> Clear Old Data (>1 year)
              </button>
              <br>
              <button onclick="resetSystem()" class="btn btn-danger">
                <i class="bi bi-arrow-clockwise"></i> Reset System
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-receipt"></i> Invoice Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="invoiceModalBody">
        <!-- Invoice content will be loaded here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="printInvoice()">
          <i class="bi bi-printer"></i> Print
        </button>
        <div id="invoiceActions">
          <!-- Approval buttons will be added here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SheetJS for Excel export -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut,
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    addDoc,
    updateDoc,
    deleteDoc,
    query,
    where,
    orderBy,
    limit,
    getDocs,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBm2Y2-KaPh_9prtDyEh75ys9bOS_YivyU",
    authDomain: "campacola-45a6c.firebaseapp.com",
    projectId: "campacola-45a6c",
    storageBucket: "campacola-45a6c.appspot.com",
    messagingSenderId: "950062364838",
    appId: "1:950062364838:web:c016c1c2b63d661dc09c67",
    measurementId: "G-0F1FMP4D6X"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Global variables
  let currentUser = null;
  let salesChart = null;
  let productsChart = null;
  let monthlySalesChart = null;
  let productDistributionChart = null;
  let currentInvoiceData = null;

  // Product list
  const products = [
    { name: 'Campa Cola', size: '200ml', price: 220 },
    { name: 'Power Up', size: '200ml', price: 220 },
    { name: 'Orange', size: '200ml', price: 220 },
    { name: 'Campa Soda', size: '500ml', price: 260 },
    { name: 'Campa Cola', size: '500ml', price: 360 },
    { name: 'Orange', size: '500ml', price: 360 },
    { name: 'Gold Boost Tin', size: 'Can', price: 580 },
    { name: 'Berry Kick', size: '200ml', price: 220 },
    { name: 'Lemon', size: '200ml', price: 220 },
    { name: 'Raskik Tetra Mango', size: '125ml', price: 280 },
    { name: 'Raskik Mango', size: '150ml', price: 220 },
    { name: 'Raskik Nimbu Pani', size: '150ml', price: 220 },
    { name: 'Raskik Apple Drink', size: '150ml', price: 220 },
    { name: 'Raskik Mixed Fruit', size: '150ml', price: 220 },
    { name: 'Raskik Glucose', size: '150ml', price: 220 },
    { name: 'Spinner Lemon', size: '150ml', price: 220 },
    { name: 'Spinner Orange', size: '150ml', price: 220 },
    { name: 'Spinner Nitro', size: '150ml', price: 220 },
    { name: 'Independence Water', size: '750ml', price: 150 }
  ];

  // Initialize app
  function initApp() {
    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (user && isAdmin(user.email)) {
        currentUser = user;
        showMainApp();
        loadDashboardData();
      } else {
        showLoginPage();
      }
    });

    // Initialize product dropdown
    initializeProductDropdown();
    
    // Set default dates
    const today = new Date();
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(today.getDate() - 7);
    
    document.getElementById('invoiceDateFrom').valueAsDate = oneWeekAgo;
    document.getElementById('invoiceDateTo').valueAsDate = today;
    document.getElementById('reportDateFrom').valueAsDate = oneWeekAgo;
    document.getElementById('reportDateTo').valueAsDate = today;
  }

  function isAdmin(email) {
    return email === 'supremeenterprise79@gmail.com' || email === 'admin@gantasolutions.com';
  }

  function showLoginPage() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
  }

  function showMainApp() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
  }

  function initializeProductDropdown() {
    const dropdown = document.getElementById('warehouseProduct');
    dropdown.innerHTML = '<option value="">Select Product</option>';
    
    products.forEach(product => {
      const option = document.createElement('option');
      option.value = `${product.name}|${product.size}`;
      option.textContent = `${product.name} - ${product.size}`;
      dropdown.appendChild(option);
    });
  }

  // Authentication functions
  async function login(event) {
    event.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      if (!isAdmin(userCredential.user.email)) {
        await signOut(auth);
        alert('Access denied. Admin privileges required.');
        return;
      }
      currentUser = userCredential.user;
      showMainApp();
      loadDashboardData();
    } catch (error) {
      alert('Login failed: ' + error.message);
    }
  }

  async function logout() {
    try {
      await signOut(auth);
      currentUser = null;
      showLoginPage();
    } catch (error) {
      console.error('Logout error:', error);
    }
  }

  // Dashboard functions
  async function loadDashboardData() {
    try {
      // Load stats
      await loadDashboardStats();
      
      // Load charts
      await loadSalesChart();
      await loadProductsChart();
      
      // Load recent data
      await loadRecentInvoices();
      await loadStockAlerts();
      
      // Load other tabs data
      await loadInvoicesData();
      await loadInventoryData();
      await loadOperatorsData();
      
    } catch (error) {
      console.error('Error loading dashboard:', error);
    }
  }

  async function loadDashboardStats() {
    try {
      // Get all approved invoices
      const invoicesQuery = query(
        collection(db, 'invoices'),
        where('status', '==', 'approved')
      );
      
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      let totalRevenue = 0;
      let totalProducts = 0;
      const operators = new Set();
      
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        totalRevenue += invoice.total || 0;
        totalProducts += invoice.items?.reduce((sum, item) => sum + (item.qty || 0), 0) || 0;
        operators.add(invoice.createdBy);
      });

      // Update stats
      document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
      document.getElementById('totalInvoices').textContent = invoicesSnapshot.size;
      document.getElementById('totalProducts').textContent = totalProducts.toLocaleString();
      document.getElementById('activeOperators').textContent = operators.size;
      
    } catch (error) {
      console.error('Error loading stats:', error);
    }
  }

  async function loadSalesChart() {
    try {
      const ctx = document.getElementById('salesChart').getContext('2d');
      
      // Get last 30 days data
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(endDate.getDate() - 30);
      
      const invoicesQuery = query(
        collection(db, 'invoices'),
        where('status', '==', 'approved'),
        where('invoiceDate', '>=', startDate),
        where('invoiceDate', '<=', endDate)
      );
      
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      // Process data by day
      const dailySales = {};
      const labels = [];
      
      // Initialize all days with 0
      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toLocaleDateString();
        dailySales[dateStr] = 0;
        labels.push(dateStr);
      }
      
      // Add actual sales data
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        const dateStr = invoice.invoiceDate.toDate().toLocaleDateString();
        if (dailySales[dateStr] !== undefined) {
          dailySales[dateStr] += invoice.total || 0;
        }
      });
      
      const data = labels.map(label => dailySales[label]);
      
      if (salesChart) {
        salesChart.destroy();
      }
      
      salesChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Daily Sales',
            data: data,
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '₹' + value.toLocaleString();
                }
              }
            }
          }
        }
      });
      
    } catch (error) {
      console.error('Error loading sales chart:', error);
    }
  }

  async function loadProductsChart() {
    try {
      const ctx = document.getElementById('productsChart').getContext('2d');
      
      const invoicesQuery = query(
        collection(db, 'invoices'),
        where('status', '==', 'approved')
      );
      
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      const productSales = {};
      
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        invoice.items?.forEach(item => {
          const productKey = `${item.name} (${item.size})`;
          productSales[productKey] = (productSales[productKey] || 0) + (item.qty || 0);
        });
      });
      
      // Get top 5 products
      const sortedProducts = Object.entries(productSales)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
      
      const labels = sortedProducts.map(([name]) => name);
      const data = sortedProducts.map(([,qty]) => qty);
      
      if (productsChart) {
        productsChart.destroy();
      }
      
      productsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              '#FF6384',
              '#36A2EB',
              '#FFCE56',
              '#4BC0C0',
              '#9966FF'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
    } catch (error) {
      console.error('Error loading products chart:', error);
    }
  }

  async function loadRecentInvoices() {
    try {
      const recentInvoicesDiv = document.getElementById('recentInvoices');
      
      const invoicesQuery = query(
        collection(db, 'invoices'),
        orderBy('createdAt', 'desc'),
        limit(5)
      );
      
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      let html = '';
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        const statusClass = invoice.status === 'approved' ? 'success' : 
                           invoice.status === 'rejected' ? 'danger' : 'warning';
        
        html += `
          <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
            <div>
              <h6 class="mb-1">${invoice.invoiceNo}</h6>
              <small class="text-muted">${invoice.dealer?.name || 'N/A'}</small>
            </div>
            <div class="text-end">
              <div class="fw-bold">₹${(invoice.total || 0).toFixed(2)}</div>
              <span class="badge bg-${statusClass}">${invoice.status}</span>
            </div>
          </div>
        `;
      });
      
      recentInvoicesDiv.innerHTML = html || '<p class="text-muted">No recent invoices</p>';
      
    } catch (error) {
      console.error('Error loading recent invoices:', error);
      document.getElementById('recentInvoices').innerHTML = '<p class="text-danger">Error loading data</p>';
    }
  }

  async function loadStockAlerts() {
    try {
      const stockAlertsDiv = document.getElementById('stockAlerts');
      
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      let html = '';
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const [key, qty] of Object.entries(warehouseData)) {
          if (qty < 10) {
            const [name, size] = key.split('|');
            const alertClass = qty === 0 ? 'danger' : 'warning';
            const alertText = qty === 0 ? 'Out of Stock' : 'Low Stock';
            
            html += `
              <div class="alert alert-${alertClass} py-2 mb-2">
                <div class="d-flex justify-content-between">
                  <span><strong>${name} (${size})</strong></span>
                  <span>${qty} units - ${alertText}</span>
                </div>
              </div>
            `;
          }
        }
      }
      
      stockAlertsDiv.innerHTML = html || '<p class="text-success">All products are well stocked</p>';
      
    } catch (error) {
      console.error('Error loading stock alerts:', error);
      document.getElementById('stockAlerts').innerHTML = '<p class="text-danger">Error loading stock data</p>';
    }
  }

  // Invoices functions
  async function loadInvoicesData() {
    try {
      const tbody = document.getElementById('invoicesTableBody');
      const operatorSelect = document.getElementById('invoiceOperator');
      
      // Load operators for filter
      const operators = new Set();
      
      const invoicesQuery = query(
        collection(db, 'invoices'),
        orderBy('createdAt', 'desc')
      );
      
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      let html = '';
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        operators.add(invoice.createdBy);
        
        const statusClass = invoice.status === 'approved' ? 'success' : 
                           invoice.status === 'rejected' ? 'danger' : 'warning';
        
        html += `
          <tr>
            <td>${invoice.invoiceNo}</td>
            <td>${invoice.invoiceDate?.toDate().toLocaleDateString() || 'N/A'}</td>
            <td>${invoice.dealer?.name || 'N/A'}</td>
            <td>${invoice.createdBy?.split('@')[0] || 'N/A'}</td>
            <td>₹${(invoice.total || 0).toFixed(2)}</td>
            <td><span class="badge bg-${statusClass}">${invoice.status}</span></td>
            <td>
              <button onclick="viewInvoice('${doc.id}')" class="btn btn-primary btn-sm">
                <i class="bi bi-eye"></i> View
              </button>
              ${invoice.status === 'pending' ? `
                <button onclick="approveInvoice('${doc.id}')" class="btn btn-success btn-sm">
                  <i class="bi bi-check"></i>
                </button>
                <button onclick="rejectInvoice('${doc.id}')" class="btn btn-danger btn-sm">
                  <i class="bi bi-x"></i>
                </button>
              ` : ''}
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
      
      // Populate operator filter
      operatorSelect.innerHTML = '<option value="">All Operators</option>';
      operators.forEach(operator => {
        const option = document.createElement('option');
        option.value = operator;
        option.textContent = operator.split('@')[0];
        operatorSelect.appendChild(option);
      });
      
    } catch (error) {
      console.error('Error loading invoices:', error);
      document.getElementById('invoicesTableBody').innerHTML = 
        '<tr><td colspan="7" class="text-center text-danger">Error loading invoices</td></tr>';
    }
  }

  async function viewInvoice(invoiceId) {
    try {
      const docRef = doc(db, 'invoices', invoiceId);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const invoice = docSnap.data();
        currentInvoiceData = { id: invoiceId, ...invoice };
        
        let itemsHTML = '';
        invoice.items?.forEach(item => {
          itemsHTML += `
            <tr>
              <td>${item.name}</td>
              <td>${item.size}</td>
              <td>${item.qty}</td>
              <td>₹${(item.rate || 0).toFixed(2)}</td>
              <td>₹${(item.amount || 0).toFixed(2)}</td>
            </tr>
          `;
        });
        
        const modalBody = `
          <div class="invoice-print-content">
            <div class="text-center mb-4">
              <h2>SUPREME ENTERPRISES</h2>
              <p class="mb-1">Premium Beverage Distribution</p>
              <hr>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <h5>Invoice Details</h5>
                <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
                <p><strong>Date:</strong> ${invoice.invoiceDate?.toDate().toLocaleDateString() || 'N/A'}</p>
                <p><strong>Status:</strong> <span class="badge bg-${invoice.status === 'approved' ? 'success' : invoice.status === 'rejected' ? 'danger' : 'warning'}">${invoice.status}</span></p>
              </div>
              <div class="col-md-6">
                <h5>Dealer Information</h5>
                <p><strong>Name:</strong> ${invoice.dealer?.name || 'N/A'}</p>
                <p><strong>Address:</strong> ${invoice.dealer?.address || 'N/A'}</p>
                <p><strong>GSTIN:</strong> ${invoice.dealer?.gstin || 'N/A'}</p>
              </div>
            </div>
            
            <div class="mb-3">
              <h5>Operator Information</h5>
              <p><strong>Operator:</strong> ${invoice.createdBy || 'N/A'}</p>
              <p><strong>Created:</strong> ${invoice.createdAt?.toDate().toLocaleString() || 'N/A'}</p>
            </div>
            
            <div class="table-responsive mb-3">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Qty</th>
                    <th>Rate</th>
                    <th>Amount</th>
                  </tr>
                </thead>
                <tbody>${itemsHTML}</tbody>
              </table>
            </div>
            
            <div class="row">
              <div class="col-md-6"></div>
              <div class="col-md-6">
                <table class="table">
                  <tr>
                    <td><strong>Subtotal:</strong></td>
                    <td class="text-end">₹${(invoice.subtotal || 0).toFixed(2)}</td>
                  </tr>
                  <tr>
                    <td><strong>GST (18%):</strong></td>
                    <td class="text-end">₹${(invoice.gst || 0).toFixed(2)}</td>
                  </tr>
                  <tr class="table-primary">
                    <td><strong>Total:</strong></td>
                    <td class="text-end"><strong>₹${(invoice.total || 0).toFixed(2)}</strong></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        `;
        
        document.getElementById('invoiceModalBody').innerHTML = modalBody;
        
        // Add approval buttons if pending
        const actionsDiv = document.getElementById('invoiceActions');
        if (invoice.status === 'pending') {
          actionsDiv.innerHTML = `
            <button onclick="approveInvoice('${invoiceId}')" class="btn btn-success">
              <i class="bi bi-check-circle"></i> Approve
            </button>
            <button onclick="rejectInvoice('${invoiceId}')" class="btn btn-danger">
              <i class="bi bi-x-circle"></i> Reject
            </button>
          `;
        } else {
          actionsDiv.innerHTML = '';
        }
        
        const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
        modal.show();
      }
    } catch (error) {
      console.error('Error loading invoice:', error);
      alert('Error loading invoice details');
    }
  }

  function printInvoice() {
    const printContent = document.querySelector('.invoice-print-content');
    if (!printContent) {
      alert('No invoice data to print');
      return;
    }
    
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
      <html>
        <head>
          <title>Invoice Print</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            .table { font-size: 14px; }
            @media print {
              body { padding: 10px; }
              .btn { display: none; }
            }
          </style>
        </head>
        <body>
          ${printContent.innerHTML}
          <div class="text-center mt-4">
            <p><em>Thank you for your business!</em></p>
          </div>
        </body>
      </html>
    `);
    
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  }

  async function approveInvoice(invoiceId) {
    try {
      await updateDoc(doc(db, 'invoices', invoiceId), {
        status: 'approved',
        approvedAt: serverTimestamp(),
        approvedBy: currentUser.email
      });
      
      alert('Invoice approved successfully!');
      loadInvoicesData();
      
      // Close modal if open
      const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
      if (modal) modal.hide();
      
    } catch (error) {
      console.error('Error approving invoice:', error);
      alert('Error approving invoice');
    }
  }

  async function rejectInvoice(invoiceId) {
    try {
      await updateDoc(doc(db, 'invoices', invoiceId), {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        rejectedBy: currentUser.email
      });
      
      alert('Invoice rejected successfully!');
      loadInvoicesData();
      
      // Close modal if open
      const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
      if (modal) modal.hide();
      
    } catch (error) {
      console.error('Error rejecting invoice:', error);
      alert('Error rejecting invoice');
    }
  }

  // Inventory functions
  async function loadInventoryData() {
    try {
      await loadWarehouseStock();
      await loadStockRequests();
      await loadStockMovements();
    } catch (error) {
      console.error('Error loading inventory data:', error);
    }
  }

  async function loadWarehouseStock() {
    try {
      const tbody = document.getElementById('warehouseStockTable');
      
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      let html = '';
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const [key, qty] of Object.entries(warehouseData)) {
          const [name, size] = key.split('|');
          const statusClass = qty === 0 ? 'danger' : qty < 10 ? 'warning' : 'success';
          const statusText = qty === 0 ? 'Out of Stock' : qty < 10 ? 'Low Stock' : 'In Stock';
          
          html += `
            <tr>
              <td>${name}</td>
              <td>${size}</td>
              <td>${qty}</td>
              <td><span class="badge bg-${statusClass}">${statusText}</span></td>
            </tr>
          `;
        }
      }
      
      tbody.innerHTML = html || '<tr><td colspan="4" class="text-center">No stock data</td></tr>';
      
    } catch (error) {
      console.error('Error loading warehouse stock:', error);
      document.getElementById('warehouseStockTable').innerHTML = 
        '<tr><td colspan="4" class="text-center text-danger">Error loading stock</td></tr>';
    }
  }

  async function updateWarehouseStock() {
    try {
      const productValue = document.getElementById('warehouseProduct').value;
      const qty = parseInt(document.getElementById('warehouseQty').value);
      const action = document.getElementById('warehouseAction').value;
      
      if (!productValue || !qty) {
        alert('Please select product and enter quantity');
        return;
      }
      
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      let warehouseData = warehouseSnap.exists() ? warehouseSnap.data() : {};
      
      if (!warehouseData[productValue]) {
        warehouseData[productValue] = 0;
      }
      
      if (action === 'add') {
        warehouseData[productValue] += qty;
      } else {
        if (warehouseData[productValue] < qty) {
          alert('Not enough stock to remove!');
          return;
        }
        warehouseData[productValue] -= qty;
      }
      
      await setDoc(warehouseRef, warehouseData);
      
      // Log the transaction
      const [name, size] = productValue.split('|');
      await addDoc(collection(db, 'stockTransactions'), {
        type: action === 'add' ? 'warehouse_add' : 'warehouse_remove',
        product: { name, size },
        quantity: qty,
        timestamp: serverTimestamp(),
        actionBy: currentUser.email
      });
      
      alert('Warehouse stock updated successfully!');
      loadWarehouseStock();
      
      // Clear form
      document.getElementById('warehouseQty').value = '';
      
    } catch (error) {
      console.error('Error updating warehouse stock:', error);
      alert('Error updating stock');
    }
  }

  async function loadStockRequests() {
    try {
      const requestsDiv = document.getElementById('stockRequestsList');
      
      const requestsQuery = query(
        collection(db, 'stockRequests'),
        where('status', '==', 'pending'),
        orderBy('timestamp', 'desc')
      );
      
      const requestsSnapshot = await getDocs(requestsQuery);
      
      let html = '';
      requestsSnapshot.forEach(doc => {
        const request = doc.data();
        
        html += `
          <div class="card mb-2">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="mb-1">${request.product?.name} (${request.product?.size})</h6>
                  <p class="mb-1 text-muted">Operator: ${request.operatorEmail}</p>
                  <p class="mb-1">Quantity: ${request.quantity}</p>
                  <small class="text-muted">${request.timestamp?.toDate().toLocaleString() || 'N/A'}</small>
                </div>
                <div>
                  <button onclick="approveStockRequest('${doc.id}', '${request.operatorId}', '${request.product?.name}', '${request.product?.size}', ${request.quantity})" 
                          class="btn btn-success btn-sm mb-1">
                    <i class="bi bi-check"></i> Approve
                  </button>
                  <button onclick="rejectStockRequest('${doc.id}')" class="btn btn-danger btn-sm">
                    <i class="bi bi-x"></i> Reject
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      requestsDiv.innerHTML = html || '<p class="text-muted">No pending stock requests</p>';
      
    } catch (error) {
      console.error('Error loading stock requests:', error);
      document.getElementById('stockRequestsList').innerHTML = '<p class="text-danger">Error loading requests</p>';
    }
  }

  async function approveStockRequest(requestId, operatorId, productName, productSize, quantity) {
    try {
      // Update request status
      await updateDoc(doc(db, 'stockRequests', requestId), {
        status: 'approved',
        approvedAt: serverTimestamp(),
        approvedBy: currentUser.email
      });
      
      // Update van stock
      const productKey = `${productName}|${productSize}`;
      const vanStockRef = doc(db, 'vanStock', operatorId);
      const vanStockDoc = await getDoc(vanStockRef);
      
      let stockData = vanStockDoc.exists() ? vanStockDoc.data().stock || {} : {};
      
      if (!stockData[productKey]) {
        stockData[productKey] = {
          name: productName,
          size: productSize,
          loaded: 0,
          sold: 0,
          remaining: 0
        };
      }
      
      stockData[productKey].loaded += quantity;
      stockData[productKey].remaining += quantity;
      
      await setDoc(vanStockRef, { 
        stock: stockData,
        lastUpdated: serverTimestamp()
      });
      
      // Update warehouse stock
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseDoc = await getDoc(warehouseRef);
      
      let warehouseData = warehouseDoc.exists() ? warehouseDoc.data() : {};
      if (warehouseData[productKey]) {
        warehouseData[productKey] -= quantity;
        await setDoc(warehouseRef, warehouseData);
      }
      
      // Log transaction
      await addDoc(collection(db, 'stockTransactions'), {
        type: 'load',
        product: { name: productName, size: productSize },
        quantity: quantity,
        operatorId: operatorId,
        timestamp: serverTimestamp(),
        approvedBy: currentUser.email
      });
      
      alert('Stock request approved successfully!');
      loadStockRequests();
      loadWarehouseStock();
      
    } catch (error) {
      console.error('Error approving stock request:', error);
      alert('Error approving request');
    }
  }

  async function rejectStockRequest(requestId) {
    try {
      await updateDoc(doc(db, 'stockRequests', requestId), {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        rejectedBy: currentUser.email
      });
      
      alert('Stock request rejected successfully!');
      loadStockRequests();
      
    } catch (error) {
      console.error('Error rejecting stock request:', error);
      alert('Error rejecting request');
    }
  }

  async function loadStockMovements() {
    try {
      const tbody = document.getElementById('stockMovementTable');
      
      const movementsQuery = query(
        collection(db, 'stockTransactions'),
        orderBy('timestamp', 'desc'),
        limit(20)
      );
      
      const movementsSnapshot = await getDocs(movementsQuery);
      
      let html = '';
      movementsSnapshot.forEach(doc => {
        const movement = doc.data();
        
        html += `
          <tr>
            <td>${movement.timestamp?.toDate().toLocaleDateString() || 'N/A'}</td>
            <td>${movement.product?.name} (${movement.product?.size})</td>
            <td><span class="badge bg-info">${movement.type}</span></td>
            <td>${movement.quantity}</td>
            <td>${movement.operatorEmail || 'System'}</td>
            <td>${movement.approvedBy || movement.actionBy || 'System'}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html || '<tr><td colspan="6" class="text-center">No movements found</td></tr>';
      
    } catch (error) {
      console.error('Error loading stock movements:', error);
      document.getElementById('stockMovementTable').innerHTML = 
        '<tr><td colspan="6" class="text-center text-danger">Error loading movements</td></tr>';
    }
  }

  // Operators functions
  async function loadOperatorsData() {
    try {
      const tbody = document.getElementById('operatorPerformanceTable');
      
      // Get all invoices
      const invoicesQuery = query(collection(db, 'invoices'));
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      // Get all stock requests
      const requestsQuery = query(collection(db, 'stockRequests'));
      const requestsSnapshot = await getDocs(requestsQuery);
      
      const operatorData = {};
      
      // Process invoices
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        const operator = invoice.createdBy;
        
        if (!operatorData[operator]) {
          operatorData[operator] = {
            totalSales: 0,
            invoices: 0,
            productsSold: 0,
            stockRequests: 0,
            status: 'Active'
          };
        }
        
        operatorData[operator].totalSales += invoice.total || 0;
        operatorData[operator].invoices += 1;
        operatorData[operator].productsSold += invoice.items?.reduce((sum, item) => sum + (item.qty || 0), 0) || 0;
      });
      
      // Process stock requests
      requestsSnapshot.forEach(doc => {
        const request = doc.data();
        const operator = request.operatorEmail;
        
        if (operatorData[operator]) {
          operatorData[operator].stockRequests += 1;
        }
      });
      
      let html = '';
      for (const [operator, data] of Object.entries(operatorData)) {
        const avgInvoice = data.invoices > 0 ? data.totalSales / data.invoices : 0;
        
        html += `
          <tr>
            <td>${operator.split('@')[0]}</td>
            <td>₹${data.totalSales.toFixed(2)}</td>
            <td>${data.invoices}</td>
            <td>${data.productsSold}</td>
            <td>₹${avgInvoice.toFixed(2)}</td>
            <td>${data.stockRequests}</td>
            <td><span class="badge bg-success">${data.status}</span></td>
          </tr>
        `;
      }
      
      tbody.innerHTML = html || '<tr><td colspan="7" class="text-center">No operator data</td></tr>';
      
    } catch (error) {
      console.error('Error loading operators data:', error);
      document.getElementById('operatorPerformanceTable').innerHTML = 
        '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
    }
  }

  // Export functions
  async function exportInvoices(period) {
    try {
      let startDate, endDate = new Date();
      
      switch(period) {
        case 'today':
          startDate = new Date();
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate = new Date();
          startDate.setDate(endDate.getDate() - 7);
          break;
        case 'month':
          startDate = new Date();
          startDate.setMonth(endDate.getMonth() - 1);
          break;
        case 'all':
          startDate = new Date(0);
          break;
      }
      
      const invoicesQuery = period === 'all' ? 
        query(collection(db, 'invoices'), orderBy('createdAt', 'desc')) :
        query(
          collection(db, 'invoices'),
          where('invoiceDate', '>=', startDate),
          where('invoiceDate', '<=', endDate),
          orderBy('invoiceDate', 'desc')
        );
      
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      const data = [];
      const headers = [
        'Invoice No', 'Date', 'Dealer Name', 'Dealer Address', 'Dealer GSTIN',
        'Operator', 'Product', 'Size', 'Quantity', 'Rate', 'Amount',
        'Subtotal', 'GST', 'Total', 'Status', 'Created At'
      ];
      
      data.push(headers);
      
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        
        if (invoice.items && invoice.items.length > 0) {
          invoice.items.forEach(item => {
            data.push([
              invoice.invoiceNo || '',
              invoice.invoiceDate?.toDate().toLocaleDateString() || '',
              invoice.dealer?.name || '',
              invoice.dealer?.address || '',
              invoice.dealer?.gstin || '',
              invoice.createdBy || '',
              item.name || '',
              item.size || '',
              item.qty || 0,
              item.rate || 0,
              item.amount || 0,
              invoice.subtotal || 0,
              invoice.gst || 0,
              invoice.total || 0,
              invoice.status || '',
              invoice.createdAt?.toDate().toLocaleString() || ''
            ]);
          });
        } else {
          data.push([
            invoice.invoiceNo || '',
            invoice.invoiceDate?.toDate().toLocaleDateString() || '',
            invoice.dealer?.name || '',
            invoice.dealer?.address || '',
            invoice.dealer?.gstin || '',
            invoice.createdBy || '',
            '', '', 0, 0, 0,
            invoice.subtotal || 0,
            invoice.gst || 0,
            invoice.total || 0,
            invoice.status || '',
            invoice.createdAt?.toDate().toLocaleString() || ''
          ]);
        }
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      
      // Auto-size columns
      const colWidths = headers.map(() => ({ wch: 15 }));
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, 'Invoices');
      XLSX.writeFile(wb, `Supreme_Invoices_${period}_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting invoices:', error);
      alert('Error exporting data');
    }
  }

  async function exportWarehouseStock() {
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      const data = [];
      const headers = ['Product', 'Size', 'Quantity', 'Status'];
      data.push(headers);
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const [key, qty] of Object.entries(warehouseData)) {
          const [name, size] = key.split('|');
          const status = qty === 0 ? 'Out of Stock' : qty < 10 ? 'Low Stock' : 'In Stock';
          
          data.push([name, size, qty, status]);
        }
      }
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = [{ wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 15 }];
      
      XLSX.utils.book_append_sheet(wb, ws, 'Warehouse Stock');
      XLSX.writeFile(wb, `Warehouse_Stock_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting warehouse stock:', error);
      alert('Error exporting data');
    }
  }

  async function exportStockMovements() {
    try {
      const movementsQuery = query(
        collection(db, 'stockTransactions'),
        orderBy('timestamp', 'desc')
      );
      
      const movementsSnapshot = await getDocs(movementsQuery);
      
      const data = [];
      const headers = ['Date', 'Product', 'Size', 'Type', 'Quantity', 'Operator', 'Action By'];
      data.push(headers);
      
      movementsSnapshot.forEach(doc => {
        const movement = doc.data();
        
        data.push([
          movement.timestamp?.toDate().toLocaleDateString() || '',
          movement.product?.name || '',
          movement.product?.size || '',
          movement.type || '',
          movement.quantity || 0,
          movement.operatorEmail || 'System',
          movement.approvedBy || movement.actionBy || 'System'
        ]);
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = [{ wch: 12 }, { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 20 }, { wch: 20 }];
      
      XLSX.utils.book_append_sheet(wb, ws, 'Stock Movements');
      XLSX.writeFile(wb, `Stock_Movements_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting stock movements:', error);
      alert('Error exporting data');
    }
  }

  async function exportVanStock() {
    try {
      const vanStockQuery = query(collection(db, 'vanStock'));
      const vanStockSnapshot = await getDocs(vanStockQuery);
      
      const data = [];
      const headers = ['Operator', 'Product', 'Size', 'Loaded', 'Sold', 'Remaining'];
      data.push(headers);
      
      vanStockSnapshot.forEach(doc => {
        const vanData = doc.data();
        const operatorId = doc.id;
        
        if (vanData.stock) {
          for (const [key, stockItem] of Object.entries(vanData.stock)) {
            data.push([
              operatorId,
              stockItem.name || '',
              stockItem.size || '',
              stockItem.loaded || 0,
              stockItem.sold || 0,
              stockItem.remaining || 0
            ]);
          }
        }
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = [{ wch: 15 }, { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];
      
      XLSX.utils.book_append_sheet(wb, ws, 'Van Stock');
      XLSX.writeFile(wb, `Van_Stock_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting van stock:', error);
      alert('Error exporting data');
    }
  }

  async function exportOperatorPerformance() {
    try {
      // Get all invoices
      const invoicesQuery = query(collection(db, 'invoices'));
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      // Get all stock requests
      const requestsQuery = query(collection(db, 'stockRequests'));
      const requestsSnapshot = await getDocs(requestsQuery);
      
      const operatorData = {};
      
      // Process invoices
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        const operator = invoice.createdBy;
        
        if (!operatorData[operator]) {
          operatorData[operator] = {
            totalSales: 0,
            invoices: 0,
            productsSold: 0,
            stockRequests: 0,
            approvedInvoices: 0,
            rejectedInvoices: 0,
            pendingInvoices: 0
          };
        }
        
        operatorData[operator].totalSales += invoice.total || 0;
        operatorData[operator].invoices += 1;
        operatorData[operator].productsSold += invoice.items?.reduce((sum, item) => sum + (item.qty || 0), 0) || 0;
        
        if (invoice.status === 'approved') operatorData[operator].approvedInvoices += 1;
        else if (invoice.status === 'rejected') operatorData[operator].rejectedInvoices += 1;
        else operatorData[operator].pendingInvoices += 1;
      });
      
      // Process stock requests
      requestsSnapshot.forEach(doc => {
        const request = doc.data();
        const operator = request.operatorEmail;
        
        if (operatorData[operator]) {
          operatorData[operator].stockRequests += 1;
        }
      });
      
      const data = [];
      const headers = [
        'Operator', 'Total Sales', 'Total Invoices', 'Products Sold', 'Average Invoice',
        'Approved Invoices', 'Rejected Invoices', 'Pending Invoices', 'Stock Requests'
      ];
      data.push(headers);
      
      for (const [operator, opData] of Object.entries(operatorData)) {
        const avgInvoice = opData.invoices > 0 ? opData.totalSales / opData.invoices : 0;
        
        data.push([
          operator,
          opData.totalSales,
          opData.invoices,
          opData.productsSold,
          avgInvoice,
          opData.approvedInvoices,
          opData.rejectedInvoices,
          opData.pendingInvoices,
          opData.stockRequests
        ]);
      }
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = headers.map(() => ({ wch: 15 }));
      
      XLSX.utils.book_append_sheet(wb, ws, 'Operator Performance');
      XLSX.writeFile(wb, `Operator_Performance_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting operator performance:', error);
      alert('Error exporting data');
    }
  }

  async function exportOperatorSales() {
    try {
      const invoicesQuery = query(collection(db, 'invoices'));
      const invoicesSnapshot = await getDocs(invoicesQuery);
      
      const data = [];
      const headers = [
        'Operator', 'Invoice No', 'Date', 'Dealer', 'Product', 'Size',
        'Quantity', 'Rate', 'Amount', 'Invoice Total', 'Status'
      ];
      data.push(headers);
      
      invoicesSnapshot.forEach(doc => {
        const invoice = doc.data();
        
        if (invoice.items && invoice.items.length > 0) {
          invoice.items.forEach(item => {
            data.push([
              invoice.createdBy || '',
              invoice.invoiceNo || '',
              invoice.invoiceDate?.toDate().toLocaleDateString() || '',
              invoice.dealer?.name || '',
              item.name || '',
              item.size || '',
              item.qty || 0,
              item.rate || 0,
              item.amount || 0,
              invoice.total || 0,
              invoice.status || ''
            ]);
          });
        }
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      ws['!cols'] = headers.map(() => ({ wch: 15 }));
      
      XLSX.utils.book_append_sheet(wb, ws, 'Operator Sales');
      XLSX.writeFile(wb, `Operator_Sales_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting operator sales:', error);
      alert('Error exporting data');
    }
  }

  async function exportOperatorStock() {
    try {
      const vanStockQuery = query(collection(db, 'vanStock'));
      const vanStockSnapshot = await getDocs(vanStockQuery);
      
      const requestsQuery = query(collection(db, 'stockRequests'));
      const requestsSnapshot = await getDocs(requestsQuery);
      
      // Van Stock Sheet
      const vanStockData = [];
      const vanStockHeaders = ['Operator', 'Product', 'Size', 'Loaded', 'Sold', 'Remaining', 'Last Updated'];
      vanStockData.push(vanStockHeaders);
      
      vanStockSnapshot.forEach(doc => {
        const vanData = doc.data();
        const operatorId = doc.id;
        
        if (vanData.stock) {
          for (const [key, stockItem] of Object.entries(vanData.stock)) {
            vanStockData.push([
              operatorId,
              stockItem.name || '',
              stockItem.size || '',
              stockItem.loaded || 0,
              stockItem.sold || 0,
              stockItem.remaining || 0,
              vanData.lastUpdated?.toDate().toLocaleString() || ''
            ]);
          }
        }
      });
      
      // Stock Requests Sheet
      const requestsData = [];
      const requestsHeaders = ['Operator', 'Product', 'Size', 'Quantity', 'Date', 'Status', 'Approved By'];
      requestsData.push(requestsHeaders);
      
      requestsSnapshot.forEach(doc => {
        const request = doc.data();
        
        requestsData.push([
          request.operatorEmail || '',
          request.product?.name || '',
          request.product?.size || '',
          request.quantity || 0,
          request.timestamp?.toDate().toLocaleDateString() || '',
          request.status || '',
          request.approvedBy || ''
        ]);
      });
      
      const wb = XLSX.utils.book_new();
      
      const vanStockWs = XLSX.utils.aoa_to_sheet(vanStockData);
      vanStockWs['!cols'] = vanStockHeaders.map(() => ({ wch: 15 }));
      XLSX.utils.book_append_sheet(wb, vanStockWs, 'Van Stock');
      
      const requestsWs = XLSX.utils.aoa_to_sheet(requestsData);
      requestsWs['!cols'] = requestsHeaders.map(() => ({ wch: 15 }));
      XLSX.utils.book_append_sheet(wb, requestsWs, 'Stock Requests');
      
      XLSX.writeFile(wb, `Operator_Stock_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error exporting operator stock:', error);
      alert('Error exporting data');
    }
  }

  // Report functions
  async function exportDailyReport() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const endDate = new Date(today);
    endDate.setHours(23, 59, 59, 999);
    
    await generateComprehensiveReport(today, endDate, 'Daily');
  }

  async function exportWeeklyReport() {
    const today = new Date();
    const startDate = new Date();
    startDate.setDate(today.getDate() - 7);
    
    await generateComprehensiveReport(startDate, today, 'Weekly');
  }

  async function exportMonthlyReport() {
    const today = new Date();
    const startDate = new Date();
    startDate.setMonth(today.getMonth() - 1);
    
    await generateComprehensiveReport(startDate, today, 'Monthly');
  }

  async function exportCustomReport() {
    const startDate = new Date(document.getElementById('reportDateFrom').value);
    const endDate = new Date(document.getElementById('reportDateTo').value);
    
    if (!startDate || !endDate) {
      alert('Please select both start and end dates');
      return;
    }
    
    endDate.setHours(23, 59, 59, 999);
    await generateComprehensiveReport(startDate, endDate, 'Custom');
  }

  async function generateCustomReport() {
    const reportType = document.getElementById('reportType').value;
    const startDate = new Date(document.getElementById('reportDateFrom').value);
    const endDate = new Date(document.getElementById('reportDateTo').value);
    const format = document.getElementById('reportFormat').value;
    
    if (!startDate || !endDate) {
      alert('Please select both start and end dates');
      return;
    }
    
    endDate.setHours(23, 59, 59, 999);
    
    switch(reportType) {
      case 'sales':
        await exportInvoices('custom');
        break;
      case 'inventory':
        await exportWarehouseStock();
        break;
      case 'operator':
        await exportOperatorPerformance();
        break;
      case 'comprehensive':
        await generateComprehensiveReport(startDate, endDate, 'Comprehensive');
        break;
    }
  }

  async function generateComprehensiveReport(startDate, endDate, reportName) {
    try {
      const wb = XLSX.utils.book_new();
      
      // 1. Summary Sheet
      const summaryData = await generateSummaryData(startDate, endDate);
      const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
      
      // 2. Invoices Sheet
      const invoicesData = await generateInvoicesData(startDate, endDate);
      const invoicesWs = XLSX.utils.aoa_to_sheet(invoicesData);
      XLSX.utils.book_append_sheet(wb, invoicesWs, 'Invoices');
      
      // 3. Products Sheet
      const productsData = await generateProductsData(startDate, endDate);
      const productsWs = XLSX.utils.aoa_to_sheet(productsData);
      XLSX.utils.book_append_sheet(wb, productsWs, 'Products');
      
      // 4. Operators Sheet
      const operatorsData = await generateOperatorsData(startDate, endDate);
      const operatorsWs = XLSX.utils.aoa_to_sheet(operatorsData);
      XLSX.utils.book_append_sheet(wb, operatorsWs, 'Operators');
      
      // 5. Warehouse Sheet
      const warehouseData = await generateWarehouseData();
      const warehouseWs = XLSX.utils.aoa_to_sheet(warehouseData);
      XLSX.utils.book_append_sheet(wb, warehouseWs, 'Warehouse');
      
      // 6. Stock Movements Sheet
      const movementsData = await generateMovementsData(startDate, endDate);
      const movementsWs = XLSX.utils.aoa_to_sheet(movementsData);
      XLSX.utils.book_append_sheet(wb, movementsWs, 'Stock Movements');
      
      XLSX.writeFile(wb, `Supreme_${reportName}_Report_${startDate.toISOString().slice(0,10)}_to_${endDate.toISOString().slice(0,10)}.xlsx`);
      
    } catch (error) {
      console.error('Error generating comprehensive report:', error);
      alert('Error generating report');
    }
  }

  async function generateSummaryData(startDate, endDate) {
    const invoicesQuery = query(
      collection(db, 'invoices'),
      where('invoiceDate', '>=', startDate),
      where('invoiceDate', '<=', endDate)
    );
    
    const invoicesSnapshot = await getDocs(invoicesQuery);
    
    let totalRevenue = 0;
    let totalInvoices = 0;
    let approvedInvoices = 0;
    let rejectedInvoices = 0;
    let pendingInvoices = 0;
    let totalProducts = 0;
    const operators = new Set();
    
    invoicesSnapshot.forEach(doc => {
      const invoice = doc.data();
      totalInvoices += 1;
      
      if (invoice.status === 'approved') {
        approvedInvoices += 1;
        totalRevenue += invoice.total || 0;
        totalProducts += invoice.items?.reduce((sum, item) => sum + (item.qty || 0), 0) || 0;
      } else if (invoice.status === 'rejected') {
        rejectedInvoices += 1;
      } else {
        pendingInvoices += 1;
      }
      
      operators.add(invoice.createdBy);
    });
    
    return [
      ['SUPREME ENTERPRISES - BUSINESS SUMMARY'],
      ['Report Period:', `${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`],
      ['Generated On:', new Date().toLocaleString()],
      [''],
      ['FINANCIAL SUMMARY'],
      ['Total Revenue (Approved)', totalRevenue],
      ['Average Invoice Value', totalInvoices > 0 ? totalRevenue / approvedInvoices : 0],
      [''],
      ['INVOICE SUMMARY'],
      ['Total Invoices', totalInvoices],
      ['Approved Invoices', approvedInvoices],
      ['Rejected Invoices', rejectedInvoices],
      ['Pending Invoices', pendingInvoices],
      ['Approval Rate (%)', totalInvoices > 0 ? (approvedInvoices / totalInvoices * 100).toFixed(2) : 0],
      [''],
      ['OPERATIONAL SUMMARY'],
      ['Total Products Sold', totalProducts],
      ['Active Operators', operators.size],
      ['Average Products per Invoice', approvedInvoices > 0 ? (totalProducts / approvedInvoices).toFixed(2) : 0]
    ];
  }

  async function generateInvoicesData(startDate, endDate) {
    const invoicesQuery = query(
      collection(db, 'invoices'),
      where('invoiceDate', '>=', startDate),
      where('invoiceDate', '<=', endDate),
      orderBy('invoiceDate', 'desc')
    );
    
    const invoicesSnapshot = await getDocs(invoicesQuery);
    
    const data = [];
    const headers = [
      'Invoice No', 'Date', 'Dealer Name', 'Dealer Address', 'Dealer GSTIN',
      'Operator', 'Subtotal', 'GST', 'Total', 'Status', 'Created At'
    ];
    data.push(headers);
    
    invoicesSnapshot.forEach(doc => {
      const invoice = doc.data();
      
      data.push([
        invoice.invoiceNo || '',
        invoice.invoiceDate?.toDate().toLocaleDateString() || '',
        invoice.dealer?.name || '',
        invoice.dealer?.address || '',
        invoice.dealer?.gstin || '',
        invoice.createdBy || '',
        invoice.subtotal || 0,
        invoice.gst || 0,
        invoice.total || 0,
        invoice.status || '',
        invoice.createdAt?.toDate().toLocaleString() || ''
      ]);
    });
    
    return data;
  }

  async function generateProductsData(startDate, endDate) {
    const invoicesQuery = query(
      collection(db, 'invoices'),
      where('invoiceDate', '>=', startDate),
      where('invoiceDate', '<=', endDate),
      where('status', '==', 'approved')
    );
    
    const invoicesSnapshot = await getDocs(invoicesQuery);
    
    const productData = {};
    
    invoicesSnapshot.forEach(doc => {
      const invoice = doc.data();
      invoice.items?.forEach(item => {
        const key = `${item.name}|${item.size}`;
        if (!productData[key]) {
          productData[key] = {
            name: item.name,
            size: item.size,
            quantity: 0,
            revenue: 0,
            invoices: 0
          };
        }
        productData[key].quantity += item.qty || 0;
        productData[key].revenue += item.amount || 0;
        productData[key].invoices += 1;
      });
    });
    
    const data = [];
    const headers = ['Product', 'Size', 'Total Quantity', 'Total Revenue', 'Number of Invoices', 'Avg Qty per Invoice'];
    data.push(headers);
    
    Object.values(productData)
      .sort((a, b) => b.revenue - a.revenue)
      .forEach(product => {
        data.push([
          product.name,
          product.size,
          product.quantity,
          product.revenue,
          product.invoices,
          (product.quantity / product.invoices).toFixed(2)
        ]);
      });
    
    return data;
  }

  async function generateOperatorsData(startDate, endDate) {
    const invoicesQuery = query(
      collection(db, 'invoices'),
      where('invoiceDate', '>=', startDate),
      where('invoiceDate', '<=', endDate)
    );
    
    const invoicesSnapshot = await getDocs(invoicesQuery);
    
    const operatorData = {};
    
    invoicesSnapshot.forEach(doc => {
      const invoice = doc.data();
      const operator = invoice.createdBy;
      
      if (!operatorData[operator]) {
        operatorData[operator] = {
          totalSales: 0,
          invoices: 0,
          approvedInvoices: 0,
          rejectedInvoices: 0,
          pendingInvoices: 0,
          productsSold: 0
        };
      }
      
      operatorData[operator].invoices += 1;
      
      if (invoice.status === 'approved') {
        operatorData[operator].approvedInvoices += 1;
        operatorData[operator].totalSales += invoice.total || 0;
        operatorData[operator].productsSold += invoice.items?.reduce((sum, item) => sum + (item.qty || 0), 0) || 0;
      } else if (invoice.status === 'rejected') {
        operatorData[operator].rejectedInvoices += 1;
      } else {
        operatorData[operator].pendingInvoices += 1;
      }
    });
    
    const data = [];
    const headers = [
      'Operator', 'Total Sales', 'Total Invoices', 'Approved', 'Rejected', 'Pending',
      'Products Sold', 'Avg Invoice Value', 'Approval Rate (%)'
    ];
    data.push(headers);
    
    Object.entries(operatorData)
      .sort(([,a], [,b]) => b.totalSales - a.totalSales)
      .forEach(([operator, data]) => {
        const avgInvoice = data.approvedInvoices > 0 ? data.totalSales / data.approvedInvoices : 0;
        const approvalRate = data.invoices > 0 ? (data.approvedInvoices / data.invoices * 100) : 0;
        
        data.push([
          operator,
          data.totalSales,
          data.invoices,
          data.approvedInvoices,
          data.rejectedInvoices,
          data.pendingInvoices,
          data.productsSold,
          avgInvoice.toFixed(2),
          approvalRate.toFixed(2)
        ]);
      });
    
    return data;
  }

  async function generateWarehouseData() {
    const warehouseRef = doc(db, 'warehouse', 'stock');
    const warehouseSnap = await getDoc(warehouseRef);
    
    const data = [];
    const headers = ['Product', 'Size', 'Current Stock', 'Status', 'Reorder Level'];
    data.push(headers);
    
    if (warehouseSnap.exists()) {
      const warehouseData = warehouseSnap.data();
      
      Object.entries(warehouseData)
        .sort(([,a], [,b]) => a - b)
        .forEach(([key, qty]) => {
          const [name, size] = key.split('|');
          const status = qty === 0 ? 'Out of Stock' : qty < 10 ? 'Low Stock' : 'In Stock';
          const reorderLevel = qty < 10 ? 'Yes' : 'No';
          
          data.push([name, size, qty, status, reorderLevel]);
        });
    }
    
    return data;
  }

  async function generateMovementsData(startDate, endDate) {
    const movementsQuery = query(
      collection(db, 'stockTransactions'),
      where('timestamp', '>=', startDate),
      where('timestamp', '<=', endDate),
      orderBy('timestamp', 'desc')
    );
    
    const movementsSnapshot = await getDocs(movementsQuery);
    
    const data = [];
    const headers = ['Date', 'Time', 'Product', 'Size', 'Movement Type', 'Quantity', 'Operator', 'Action By'];
    data.push(headers);
    
    movementsSnapshot.forEach(doc => {
      const movement = doc.data();
      const date = movement.timestamp?.toDate();
      
      data.push([
        date?.toLocaleDateString() || '',
        date?.toLocaleTimeString() || '',
        movement.product?.name || '',
        movement.product?.size || '',
        movement.type || '',
        movement.quantity || 0,
        movement.operatorEmail || 'System',
        movement.approvedBy || movement.actionBy || 'System'
      ]);
    });
    
    return data;
  }

  // Filter functions
  function filterInvoices() {
    // Implementation for filtering invoices
    loadInvoicesData();
  }

  function clearInvoiceFilters() {
    document.getElementById('invoiceDateFrom').value = '';
    document.getElementById('invoiceDateTo').value = '';
    document.getElementById('invoiceStatus').value = '';
    document.getElementById('invoiceOperator').value = '';
    loadInvoicesData();
  }

  // Settings functions
  async function saveSettings() {
    try {
      const gst = document.getElementById('companyGST').value;
      const address = document.getElementById('companyAddress').value;
      
      await setDoc(doc(db, 'settings', 'company'), {
        name: 'SUPREME ENTERPRISES',
        gst: gst,
        address: address,
        updatedAt: serverTimestamp(),
        updatedBy: currentUser.email
      });
      
      alert('Settings saved successfully!');
    } catch (error) {
      console.error('Error saving settings:', error);
      alert('Error saving settings');
    }
  }

  async function backupData() {
    try {
      // Generate comprehensive backup
      const startDate = new Date(0); // All time
      const endDate = new Date();
      
      await generateComprehensiveReport(startDate, endDate, 'BACKUP');
      alert('Data backup completed successfully!');
    } catch (error) {
      console.error('Error backing up data:', error);
      alert('Error creating backup');
    }
  }

  async function clearOldData() {
    if (!confirm('This will permanently delete all data older than 1 year. Are you sure?')) {
      return;
    }
    
    try {
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
      
      // Delete old invoices
      const oldInvoicesQuery = query(
        collection(db, 'invoices'),
        where('createdAt', '<', oneYearAgo)
      );
      
      const oldInvoicesSnapshot = await getDocs(oldInvoicesQuery);
      
      for (const docSnapshot of oldInvoicesSnapshot.docs) {
        await deleteDoc(doc(db, 'invoices', docSnapshot.id));
      }
      
      // Delete old stock transactions
      const oldTransactionsQuery = query(
        collection(db, 'stockTransactions'),
        where('timestamp', '<', oneYearAgo)
      );
      
      const oldTransactionsSnapshot = await getDocs(oldTransactionsQuery);
      
      for (const docSnapshot of oldTransactionsSnapshot.docs) {
        await deleteDoc(doc(db, 'stockTransactions', docSnapshot.id));
      }
      
      alert(`Deleted ${oldInvoicesSnapshot.size} old invoices and ${oldTransactionsSnapshot.size} old transactions`);
      loadDashboardData();
      
    } catch (error) {
      console.error('Error clearing old data:', error);
      alert('Error clearing old data');
    }
  }

  async function resetSystem() {
    if (!confirm('This will reset the entire system and delete ALL data. This cannot be undone. Are you absolutely sure?')) {
      return;
    }
    
    if (!confirm('Last warning: This will permanently delete everything. Type "RESET" to confirm.')) {
      return;
    }
    
    const confirmation = prompt('Type "RESET" to confirm system reset:');
    if (confirmation !== 'RESET') {
      alert('Reset cancelled');
      return;
    }
    
    try {
      // This is a dangerous operation - implement with extreme caution
      alert('System reset functionality disabled for safety. Contact developer for manual reset.');
    } catch (error) {
      console.error('Error resetting system:', error);
      alert('Error resetting system');
    }
  }

  // Expose functions to global scope
  window.login = login;
  window.logout = logout;
  window.viewInvoice = viewInvoice;
  window.printInvoice = printInvoice;
  window.approveInvoice = approveInvoice;
  window.rejectInvoice = rejectInvoice;
  window.updateWarehouseStock = updateWarehouseStock;
  window.approveStockRequest = approveStockRequest;
  window.rejectStockRequest = rejectStockRequest;
  window.exportInvoices = exportInvoices;
  window.exportWarehouseStock = exportWarehouseStock;
  window.exportStockMovements = exportStockMovements;
  window.exportVanStock = exportVanStock;
  window.exportOperatorPerformance = exportOperatorPerformance;
  window.exportOperatorSales = exportOperatorSales;
  window.exportOperatorStock = exportOperatorStock;
  window.exportDailyReport = exportDailyReport;
  window.exportWeeklyReport = exportWeeklyReport;
  window.exportMonthlyReport = exportMonthlyReport;
  window.exportCustomReport = exportCustomReport;
  window.generateCustomReport = generateCustomReport;
  window.filterInvoices = filterInvoices;
    window.clearInvoiceFilters = clearInvoiceFilters;
  window.saveSettings = saveSettings;
  window.backupData = backupData;
  window.clearOldData = clearOldData;
  window.resetSystem = resetSystem;

  // Initialize the app when the page loads
  document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
