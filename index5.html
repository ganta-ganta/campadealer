<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUPREME ENTERPRISES</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --info-color: #3498db;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 10px; 
      max-width: 100%; 
      margin: auto; 
      font-size: 14px; 
      background-color: #f8f9fa;
      color: #333;
    }
    
    .card {
      border-radius: 8px;
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 15px;
      transition: transform 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
    }
    
    .card-header {
      background-color: var(--primary-color);
      color: white;
      border-radius: 8px 8px 0 0 !important;
      padding: 12px 15px;
      font-weight: 600;
    }
    
    table { 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0;
      margin-top: 10px; 
      font-size: 13px;
    }
    
    th, td { 
      border: 1px solid #e0e0e0; 
      padding: 8px; 
      text-align: center; 
    }
    
    th { 
      background-color: var(--light-color); 
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    .btn { 
      padding: 8px 12px; 
      font-size: 13px;
      border: none; 
      cursor: pointer; 
      margin: 2px 0;
      border-radius: 6px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .btn i {
      font-size: 14px;
    }
    
    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
    }
    
    .btn-primary { 
      background: var(--secondary-color); 
      color: white;
    }
    
    .btn-success { 
      background: var(--success-color); 
      color: white;
    }
    
    .btn-danger { 
      background: var(--danger-color); 
      color: white;
    }
    
    .btn-warning { 
      background: var(--warning-color); 
      color: white;
    }
    
    .btn-info { 
      background: var(--info-color); 
      color: white;
    }
    
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    
    .right { text-align: right; }
    
    .company-header { 
      background-color: white; 
      padding: 15px; 
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 15px;
    }
    
    .login-container { 
      max-width: 400px; 
      margin: 40px auto;
      padding: 0 15px;
    }
    
    .hidden { display: none; }
    
    .nav-tabs { 
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
    }
    
    .nav-link {
      padding: 10px 15px;
      color: #7f8c8d;
      font-weight: 500;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .nav-link.active {
      color: var(--secondary-color);
      background: transparent;
      border-bottom: 2px solid var(--secondary-color);
    }
    
    .nav-link:hover {
      color: var(--secondary-color);
      border-color: transparent;
    }
    
    .offline-banner { 
      position: fixed; 
      top: 0; 
      left: 0; 
      right: 0; 
      background: var(--warning-color); 
      color: #000; 
      padding: 10px; 
      text-align: center;
      z-index: 1000;
      font-size: 13px;
      font-weight: 500;
    }
    
    .modal-lg { max-width: 95%; }
    
    .form-control, .form-select {
      padding: 8px;
      font-size: 13px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }
    
    .input-group {
      margin-bottom: 8px;
    }
    
    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    h2 { font-size: 20px; font-weight: 700; }
    h3 { font-size: 18px; font-weight: 600; }
    h4 { font-size: 16px; font-weight: 600; }
    h5 { font-size: 15px; font-weight: 600; }
    
    .badge {
      font-size: 11px;
      padding: 4px 7px;
      font-weight: 500;
      border-radius: 10px;
    }
    
    .stock-low { background-color: #fff3cd; }
    .stock-out { background-color: #f8d7da; }
    
    .text-success {
      color: var(--success-color) !important;
    }
    
    .text-danger {
      color: var(--danger-color) !important;
    }
    
    .table-sm td, .table-sm th {
      padding: 6px;
    }
    
    .card.bg-primary, 
    .card.bg-success, 
    .card.bg-info, 
    .card.bg-warning {
      color: white;
    }
    
    .card.bg-primary { background-color: var(--primary-color) !important; }
    .card.bg-success { background-color: var(--success-color) !important; }
    .card.bg-info { background-color: var(--info-color) !important; }
    .card.bg-warning { background-color: var(--warning-color) !important; }
    
    .card.bg-primary .card-text,
    .card.bg-success .card-text,
    .card.bg-info .card-text,
    .card.bg-warning .card-text {
      opacity: 0.9;
    }
    
    .alert {
      border-radius: 8px;
      padding: 10px 15px;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 768px) {
      .nav-tabs .nav-item {
        width: 33.33%;
        text-align: center;
      }
      
      .nav-link {
        padding: 8px 4px;
        font-size: 12px;
        justify-content: center;
      }
      
      .company-header {
        padding: 12px;
      }
      
      .tab-content {
        padding: 5px;
      }
      
      .row {
        margin-left: -5px;
        margin-right: -5px;
      }
      
      .col-md-6, .col-md-4, .col-md-2 {
        padding-left: 5px;
        padding-right: 5px;
      }
      
      #invoiceBody td, #invoiceBody th {
        padding: 6px;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 8px;
      }
      
      .modal-body {
        padding: 15px;
      }
    }
    
    /* Print styles */
    @media print {
      body { padding: 0; font-size: 12px; background: white; }
      .nav-tabs, .btn, #offlineBanner { display: none !important; }
      .company-header { padding: 5px; box-shadow: none; }
      table { font-size: 11px; }
      th, td { padding: 4px; }
      .card { box-shadow: none; border: 1px solid #ddd; }
    }
  </style>
</head>
<body>

<div id="offlineBanner" class="offline-banner hidden">
  <i class="bi bi-exclamation-triangle-fill"></i> You are currently offline. Changes will be saved locally and synced when you reconnect.
</div>

<div id="loginPage" class="login-container">
  <div class="text-center mb-4">
    <i class="bi bi-cup-hot-fill" style="font-size: 2.5rem; color: var(--accent-color);"></i>
    <h2 class="mt-2">SUPREME ENTERPRISES</h2>
    <p class="text-muted">Inventory & Invoice System</p>
  </div>
  <div class="card">
    <div class="card-body">
      <div class="mb-3">
        <label for="loginEmail" class="form-label">Email</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-envelope"></i></span>
          <input type="email" class="form-control" id="loginEmail" placeholder="operator@campa.com">
        </div>
      </div>
      <div class="mb-3">
        <label for="loginPassword" class="form-label">Password</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-lock"></i></span>
          <input type="password" class="form-control" id="loginPassword" placeholder="Password">
        </div>
      </div>
      <button id="loginBtn" class="btn btn-primary w-100">
        <i class="bi bi-box-arrow-in-right"></i> Login
      </button>
    </div>
  </div>
</div>

<div id="appContainer" class="hidden">
  <ul class="nav nav-tabs" id="myTab">
    <li class="nav-item">
      <a class="nav-link active" data-bs-toggle="tab" href="#invoiceTab">
        <i class="bi bi-receipt"></i> Invoices
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" data-bs-toggle="tab" href="#stockTab">
        <i class="bi bi-box-seam"></i> Stock
      </a>
    </li>
    <li class="nav-item" id="adminTabItem">
      <a class="nav-link" data-bs-toggle="tab" href="#adminTab">
        <i class="bi bi-shield-lock"></i> Admin
      </a>
    </li>
    <li class="nav-item" id="dashboardTabItem">
      <a class="nav-link" data-bs-toggle="tab" href="#dashboardTab">
        <i class="bi bi-graph-up"></i> Dashboard
      </a>
    </li>
    <li class="nav-item" id="operatorSalesTabItem">
      <a class="nav-link" data-bs-toggle="tab" href="#operatorSalesTab">
        <i class="bi bi-people"></i> Operator Sales
      </a>
    </li>
    <li class="nav-item" id="ordersTabItem">
      <a class="nav-link" data-bs-toggle="tab" href="#ordersTab">
       <i class="bi bi-cart-check"></i> Orders
      </a>
     </li>
    <li class="nav-item ms-auto">
      <button onclick="logout()" class="btn btn-danger btn-sm">
        <i class="bi bi-box-arrow-left"></i> Logout
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Invoice Generator Tab -->
    <div class="tab-pane fade show active" id="invoiceTab">
      <div class="company-header text-center">
        <div class="d-flex justify-content-center align-items-center mb-2">
          <i class="bi bi-cup-hot-fill me-2" style="font-size: 1.8rem; color: var(--accent-color);"></i>
          <h2 class="mb-0">SUPREME ENTERPRISES</h2>
        </div>
        <div class="row">
          <div class="col-md-6">
            <p class="mb-1"><i class="bi bi-file-earmark-text"></i> <strong>Invoice No:</strong> <span id="invoiceNo" class="badge bg-primary">INV-001</span></p>
          </div>
          <div class="col-md-6">
            <p class="mb-1"><i class="bi bi-calendar"></i> <strong>Date:</strong> <span id="invoiceDate">01 Jan 2023</span></p>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-person-badge"></i> Dealer Information
            </div>
            <div class="card-body">
              <div class="mb-2">
                <label for="dealerName" class="form-label">Dealer Name</label>
                <input type="text" id="dealerName" class="form-control" placeholder="Enter dealer name" required>
              </div>
              <div class="mb-2">
                <label for="dealerAddress" class="form-label">Address</label>
                <input type="text" id="dealerAddress" class="form-control" placeholder="Enter address">
              </div>
              <div class="mb-2">
                <label for="dealerGST" class="form-label">GSTIN</label>
                <input type="text" id="dealerGST" class="form-control" placeholder="Enter GST number">
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <i class="bi bi-cart-plus"></i> Add Products
            </div>
            <div class="card-body">
              <div class="mb-2">
                <label for="productSelect" class="form-label">Product</label>
                <select id="productSelect" class="form-select">
                  <option value="">-- Select Product --</option>
                  <option value="Campa Cola|200ml|220">Campa Cola - 200ml</option>
                  <option value="Power Up|200ml|220">Power Up - 200ml</option>
                  <option value="Orange|200ml|220">Orange - 200ml</option>
                  <option value="Campa Soda|500ml|260">Campa Soda - 500ml</option>
                  <option value="Campa Cola|500ml|360">Campa Cola - 500ml</option>
                  <option value="Orange|500ml|360">Orange - 500ml</option>
                  <option value="Gold Boost Tin|Can|580">Gold Boost Tin</option>
                  <option value="Berry Kick|200ml|220">Berry Kick - 200ml</option>
                  <option value="Lemon|200ml|220">Lemon - 200ml</option>
                  <option value="Raskik Tetra Mango|125ml|280">Raskik Tetra Mango - 125ml</option>
                  <option value="Raskik Mango|150ml|220">Raskik Mango - 150ml</option>
                  <option value="Raskik Nimbu Pani|150ml|220">Raskik Nimbu Pani - 150ml</option>
                  <option value="Raskik Apple Drink|150ml|220">Raskik Apple Drink - 150ml</option>
                  <option value="Raskik Mixed Fruit|150ml|220">Raskik Mixed Fruit - 150ml</option>
                  <option value="Raskik Glucose|150ml|220">Raskik Glucose - 150ml</option>
                  <option value="Spinner Lemon|150ml|220">Spinner Lemon - 150ml</option>
                  <option value="Spinner Orange|150ml|220">Spinner Orange - 150ml</option>
                  <option value="Spinner Nitro|150ml|220">Spinner Nitro - 150ml</option>
                  <option value="Independence Water|750ml|150">Independence Water - 750ml</option>
                </select>
              </div>
              <div class="mb-2">
                <label for="qty" class="form-label">Quantity</label>
                <div class="input-group">
                  <input type="number" id="qty" class="form-control" placeholder="Qty" min="1" value="1">
                  <button class="btn btn-primary" onclick="addProduct()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="bi bi-list-check"></i> Invoice Items
        </div>
        <div class="card-body p-0">
          <div style="overflow-x: auto;">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Size</th>
                  <th>Qty</th>
                  <th>Rate (₹)</th>
                  <th>Amount (₹)</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="invoiceBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card mt-3">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold">Subtotal:</span>
                <span id="subtotal">₹0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold">GST (0%):</span>
                <span id="gst">₹0.00</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold">Total:</span>
                <span id="total" class="fw-bold fs-5">₹0.00</span>
              </div>
            </div>
            <div class="col-md-6 d-flex align-items-end justify-content-end">
              <div>
                <button class="btn btn-success me-2" onclick="saveInvoice()">
                  <i class="bi bi-save"></i> Save
                </button>
                <button class="btn btn-primary me-2" onclick="printInvoice()">
                  <i class="bi bi-printer"></i> Print
                </button>
                <button class="btn btn-warning" onclick="saveDraft()">
                  <i class="bi bi-file-earmark"></i> Draft
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Van Stock Management Tab -->
    <div class="tab-pane fade" id="stockTab">
      <div class="card">
        <div class="card-header">
          <i class="bi bi-truck"></i> Van Stock Summary
        </div>
        <div class="card-body">
          <div class="alert alert-info py-2 mb-3">
            <i class="bi bi-info-circle"></i> <strong>Current Operator:</strong> <span id="vanOperatorName">operator name </span>
          </div>
          
          <div class="alert alert-warning py-2 mb-3">
            <i class="bi bi-box-seam"></i> <strong>Current Stock:</strong> <span id="currentStockDisplay">15 products loaded, 5 sold, 10 remaining</span>
          </div>
          
          <div class="card mb-3">
            <div class="card-header">
              <i class="bi bi-plus-circle"></i> Request Stock
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <label for="stockProductSelect" class="form-label">Product</label>
                  <select id="stockProductSelect" class="form-select mb-2">
                    <option value="">-- Select Product --</option>
                    <option value="Campa Cola|200ml">Campa Cola - 200ml</option>
                    <option value="Power Up|200ml">Power Up - 200ml</option>
                    <option value="Orange|200ml">Orange - 200ml</option>
                    <option value="Campa Soda|500ml">Campa Soda - 500ml</option>
                    <option value="Campa Cola|500ml">Campa Cola - 500ml</option>
                    <option value="Orange|500ml">Orange - 500ml</option>
                    <option value="Gold Boost Tin|Can">Gold Boost Tin</option>
                    <option value="Berry Kick|200ml">Berry Kick - 200ml</option>
                    <option value="Lemon|200ml">Lemon - 200ml</option>
                    <option value="Raskik Tetra Mango|125ml">Raskik Tetra Mango - 125ml</option>
                    <option value="Raskik Mango|150ml">Raskik Mango - 150ml</option>
                    <option value="Raskik Nimbu Pani|150ml">Raskik Nimbu Pani - 150ml</option>
                    <option value="Raskik Apple Drink|150ml">Raskik Apple Drink - 150ml</option>
                    <option value="Raskik Mixed Fruit|150ml">Raskik Mixed Fruit - 150ml</option>
                    <option value="Raskik Glucose|150ml">Raskik Glucose - 150ml</option>
                    <option value="Spinner Lemon|150ml">Spinner Lemon - 150ml</option>
                    <option value="Spinner Orange|150ml">Spinner Orange - 150ml</option>
                    <option value="Spinner Nitro|150ml">Spinner Nitro - 150ml</option>
                    <option value="Independence Water|750ml">Independence Water - 750ml</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="stockQty" class="form-label">Quantity</label>
                  <input type="number" id="stockQty" class="form-control" placeholder="Qty" min="1" value="1">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button class="btn btn-primary w-100" onclick="requestStock()">
                    <i class="bi bi-send"></i> Request
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card mb-3">
            <div class="card-header">
              <i class="bi bi-box-seam"></i> Current Stock
            </div>
            <div class="card-body p-0">
              <div style="overflow-x: auto;">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Size</th>
                      <th>Loaded</th>
                      <th>Sold</th>
                      <th>Remaining</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="vanStockBody"></tbody>
                </table>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <i class="bi bi-clock-history"></i> Pending Requests
            </div>
            <div class="card-body p-0">
              <div style="overflow-x: auto;">
                <table class="table mb-0">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Size</th>
                      <th>Qty</th>
                      <th>Date</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="pendingRequestsBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Dashboard Tab -->
    <div class="tab-pane fade" id="adminTab">
      <h3 class="mb-3"><i class="bi bi-shield-lock"></i> Admin Dashboard</h3>
      
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-primary text-white">
              <i class="bi bi-file-earmark-text"></i> Pending Invoices
            </div>
            <div class="card-body">
              <div id="pendingApprovalsList" class="list-group">
                <!-- Will be populated by JavaScript -->
                <div class="text-center py-3 text-muted">
                  <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                  <p class="mt-2">Loading pending invoices...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header bg-warning text-white">
              <i class="bi bi-box-seam"></i> Pending Stock Requests
            </div>
            <div class="card-body">
              <div id="pendingStockApprovals" class="list-group">
                <!-- Will be populated by JavaScript -->
                <div class="text-center py-3 text-muted">
                  <i class="bi bi-hourglass-split" style="font-size: 2rem;"></i>
                  <p class="mt-2">Loading stock requests...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header bg-info text-white">
          <i class="bi bi-building"></i> Warehouse Management
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="warehouseProductSelect" class="form-label">Product</label>
              <select id="warehouseProductSelect" class="form-select">
                <option value="">-- Select Product --</option>
                <option value="Campa Cola|200ml">Campa Cola - 200ml</option>
                <option value="Power Up|200ml">Power Up - 200ml</option>
                <option value="Orange|200ml">Orange - 200ml</option>
                <option value="Campa Soda|500ml">Campa Soda - 500ml</option>
                <option value="Campa Cola|500ml">Campa Cola - 500ml</option>
                <option value="Orange|500ml">Orange - 500ml</option>
                <option value="Gold Boost Tin|Can">Gold Boost Tin</option>
                <option value="Berry Kick|200ml">Berry Kick - 200ml</option>
                <option value="Lemon|200ml">Lemon - 200ml</option>
                <option value="Raskik Tetra Mango|125ml">Raskik Tetra Mango - 125ml</option>
                <option value="Raskik Mango|150ml">Raskik Mango - 150ml</option>
                <option value="Raskik Nimbu Pani|150ml">Raskik Nimbu Pani - 150ml</option>
                <option value="Raskik Apple Drink|150ml">Raskik Apple Drink - 150ml</option>
                <option value="Raskik Mixed Fruit|150ml">Raskik Mixed Fruit - 150ml</option>
                <option value="Raskik Glucose|150ml">Raskik Glucose - 150ml</option>
                <option value="Spinner Lemon|150ml">Spinner Lemon - 150ml</option>
                <option value="Spinner Orange|150ml">Spinner Orange - 150ml</option>
                <option value="Spinner Nitro|150ml">Spinner Nitro - 150ml</option>
                <option value="Independence Water|750ml">Independence Water - 750ml</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="warehouseQty" class="form-label">Quantity</label>
              <input type="number" id="warehouseQty" class="form-control" placeholder="Qty" min="1" value="1">
            </div>
            <div class="col-md-3">
              <label for="warehouseAction" class="form-label">Action</label>
              <select id="warehouseAction" class="form-select">
                <option value="add">Add Stock</option>
                <option value="remove">Remove Stock</option>
              </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-primary w-100" onclick="updateWarehouseStock()">
                <i class="bi bi-arrow-repeat"></i> Update
              </button>
            </div>
          </div>
          
          <h5 class="mb-3"><i class="bi bi-boxes"></i> Current Warehouse Stock</h5>
          <div style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Size</th>
                  <th>Quantity</th>
                </tr>
              </thead>
              <tbody id="warehouseStockBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <i class="bi bi-people-fill"></i> Van Operators
        </div>
        <div class="card-body">
          <div id="vanOperatorsSummary">
            <!-- Will be populated by JavaScript -->
            <div class="text-center py-3 text-muted">
              <i class="bi bi-people" style="font-size: 2rem;"></i>
              <p class="mt-2">Loading operator data...</p>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <i class="bi bi-receipt"></i> Recent Invoices
        </div>
        <div class="card-body">
          <div class="mb-3">
            <button class="btn btn-secondary btn-sm me-2" onclick="exportInvoices('csv')">
              <i class="bi bi-file-earmark-spreadsheet"></i> CSV
            </button>
            <button class="btn btn-secondary btn-sm" onclick="exportInvoices('excel')">
              <i class="bi bi-file-excel"></i> Excel
            </button>
          </div>
          <div style="overflow-x: auto;">
            <table class="table">
              <thead>
                <tr>
                  <th>Inv No</th>
                  <th>Date</th>
                  <th>Dealer</th>
                  <th>Amount</th>
                  <th>Operator</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="invoicesList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-pane fade" id="dashboardTab">
      <h3 class="mb-3"><i class="bi bi-graph-up"></i> Sales Dashboard</h3>
      
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="dashboardTimeRange" class="form-label">Time Period</label>
          <select id="dashboardTimeRange" class="form-select" onchange="loadDashboardData()">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="col-md-4" id="customDateRange" style="display:none;">
          <label for="dashboardStartDate" class="form-label">Start Date</label>
          <input type="date" id="dashboardStartDate" class="form-control">
        </div>
        <div class="col-md-4" id="customDateRangeEnd" style="display:none;">
          <label for="dashboardEndDate" class="form-label">End Date</label>
          <input type="date" id="dashboardEndDate" class="form-control">
        </div>
      </div>
      
      <!-- Download Buttons -->
      <div class="mb-3">
        <button class="btn btn-primary btn-sm me-2" onclick="exportDashboardData('today')">
          <i class="bi bi-download"></i> Today
        </button>
        <button class="btn btn-primary btn-sm me-2" onclick="exportDashboardData('week')">
          <i class="bi bi-download"></i> Week
        </button>
        <button class="btn btn-primary btn-sm me-2" onclick="exportDashboardData('month')">
          <i class="bi bi-download"></i> Month
        </button>
        <button class="btn btn-secondary btn-sm" onclick="toggleView()">
          <i class="bi bi-arrow-left-right"></i> Toggle View
        </button>
      </div>
      
      <!-- Summary Cards -->
      <div class="row mb-3">
        <div class="col-md-3">
          <div class="card text-white bg-primary h-100">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-currency-rupee fs-4 me-2"></i>
                <h5 class="card-title mb-0">Total Sales</h5>
              </div>
              <h2 id="totalSales">₹0.00</h2>
              <p class="card-text"><span id="salesChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-success h-100">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-box-seam fs-4 me-2"></i>
                <h5 class="card-title mb-0">Total Quantity</h5>
              </div>
              <h2 id="totalQuantity">0</h2>
              <p class="card-text"><span id="quantityChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-info h-100">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-collection fs-4 me-2"></i>
                <h5 class="card-title mb-0">Products Sold</h5>
              </div>
              <h2 id="totalProducts">0</h2>
              <p class="card-text"><span id="productsChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-white bg-warning h-100">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <i class="bi bi-graph-up-arrow fs-4 me-2"></i>
                <h5 class="card-title mb-0">Avg. Sale</h5>
              </div>
              <h2 id="avgSale">₹0.00</h2>
              <p class="card-text"><span id="avgSaleChange">0%</span> vs previous period</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Product/Quantity Toggle View -->
      <div id="productView">
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Sales Trend</h5>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType('sales')">
                    <i class="bi bi-arrow-repeat"></i> Toggle Chart
                  </button>
                </div>
              </div>
              <div class="card-body">
                <canvas id="salesTrendChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Top Products by Revenue</h5>
              </div>
              <div class="card-body">
                <canvas id="topProductsChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="quantityView" style="display:none;">
        <div class="row mb-3">
          <div class="col-md-8">
            <div class="card h-100">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bar-chart-line"></i> Quantity Trend</h5>
                <div>
                  <button class="btn btn-sm btn-outline-secondary" onclick="toggleChartType('quantity')">
                    <i class="bi bi-arrow-repeat"></i> Toggle Chart
                  </button>
                </div>
              </div>
              <div class="card-body">
                <canvas id="quantityTrendChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card h-100">
              <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Top Products by Quantity</h5>
              </div>
              <div class="card-body">
                <canvas id="topQuantityChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Detailed Tables -->
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-table"></i> Product Performance</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Size</th>
                    <th>Qty</th>
                    <th>Revenue</th>
                    <th>% of Total</th>
                  </tr>
                </thead>
                <tbody id="productPerformance">
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Daily Summary</h5>
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Invoices</th>
                    <th>Qty</th>
                    <th>Revenue</th>
                  </tr>
                </thead>
                <tbody id="dailySummary">
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Operator Sales Tab -->
    <div class="tab-pane fade" id="operatorSalesTab">
      <h3 class="mb-3"><i class="bi bi-people"></i> Van Operator Sales Performance</h3>
      
      <div class="card mb-3">
        <div class="card-header">
          <i class="bi bi-funnel"></i> Filters
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="operatorSelect" class="form-label">Operator</label>
              <select id="operatorSelect" class="form-select">
                <option value="all">All Operators</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
            <div class="col-md-4">
              <label for="productFilter" class="form-label">Product</label>
              <select id="productFilter" class="form-select">
                <option value="all">All Products</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
            <div class="col-md-4">
              <label for="timePeriodFilter" class="form-label">Time Period</label>
              <select id="timePeriodFilter" class="form-select">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3" id="customDateRangeOperator" style="display:none;">
            <div class="col-md-6">
              <label for="operatorStartDate" class="form-label">Start Date</label>
              <input type="date" id="operatorStartDate" class="form-control">
            </div>
            <div class="col-md-6">
              <label for="operatorEndDate" class="form-label">End Date</label>
              <input type="date" id="operatorEndDate" class="form-control">
            </div>
          </div>
          
          <div class="d-flex justify-content-between">
            <button class="btn btn-primary" onclick="loadOperatorSales()">
              <i class="bi bi-funnel"></i> Apply Filters
            </button>
            <button class="btn btn-success" onclick="exportOperatorSales()">
              <i class="bi bi-download"></i> Export Data
            </button>
          </div>
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-table"></i> Product-wise Sales by Operator</h5>
        </div>
        <div class="card-body" style="overflow-x: auto;">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th>Operator</th>
                <th>Product</th>
                <th>Size</th>
                <th>Quantity Sold</th>
                <th>Total Revenue</th>
                <th>% of Operator Sales</th>
              </tr>
            </thead>
            <tbody id="operatorSalesBody">
              <!-- Will be populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> Sales Summary</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <canvas id="operatorProductChart" height="300"></canvas>
            </div>
            <div class="col-md-6">
              <canvas id="operatorPerformanceChart" height="300"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Tab -->
    <div class="tab-pane fade" id="ordersTab">
      <h3><i class="bi bi-cart-check"></i> Order History</h3>
      
      <div class="card mb-3">
        <div class="card-header">
          <i class="bi bi-funnel"></i> Filters
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label"><i class="bi bi-calendar"></i> Start Date</label>
              <input type="date" id="ordersStartDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label"><i class="bi bi-calendar"></i> End Date</label>
              <input type="date" id="ordersEndDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label"><i class="bi bi-person"></i> Operator</label>
              <select id="ordersOperatorFilter" class="form-select">
                <option value="all">All Operators</option>
              </select>
            </div>
          </div>
          
          <div class="d-flex justify-content-between">
            <button class="btn btn-primary" onclick="loadOrderHistory()">
              <i class="bi bi-search"></i> Search
            </button>
            <button class="btn btn-success" onclick="exportAllCategoryData()">
              <i class="bi bi-download"></i> Export All Data
            </button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-table"></i> Orders</h5>
        </div>
        <div class="card-body p-0">
          <div style="overflow-x: auto;">
            <table class="table mb-0">
              <thead>
                <tr>
                  <th>Order No</th>
                  <th>Date</th>
                  <th>Dealer</th>
                  <th>Products</th>
                  <th>Quantity</th>
                  <th>Amount</th>
                  <th>Operator</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- SheetJS for export -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    signOut,
    onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    addDoc,
    updateDoc,
    query,
    where,
    orderBy,
    limit,
    getDocs,
    serverTimestamp,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBm2Y2-KaPh_9prtDyEh75ys9bOS_YivyU",
    authDomain: "campacola-45a6c.firebaseapp.com",
    projectId: "campacola-45a6c",
    storageBucket: "campacola-45a6c.appspot.com",
    messagingSenderId: "950062364838",
    appId: "1:950062364838:web:c016c1c2b63d661dc09c67",
    measurementId: "G-0F1FMP4D6X"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Global variables
  let currentUser = null;
  let subtotal = 0;
  let invoiceItems = [];
  let vanStock = {};
  let invoiceCounter = 0;
  let isOnline = navigator.onLine;
  const offlineInvoices = JSON.parse(localStorage.getItem('offlineInvoices')) || [];
  const offlineStockRequests = JSON.parse(localStorage.getItem('offlineStockRequests')) || [];
  const draftInvoices = JSON.parse(localStorage.getItem('draftInvoices')) || [];
  let salesTrendChart = null;
  let quantityTrendChart = null;
  let topProductsChart = null;
  let topQuantityChart = null;
  let operatorProductChart = null;
  let operatorPerformanceChart = null;
  let currentView = 'product'; // 'product' or 'quantity'
  let currentChartType = { sales: 'line', quantity: 'line' };

  // Initialize the app
  function initApp() {
    // Hide app container initially
    document.getElementById('appContainer').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
    
    // Create invoice modal
    createInvoiceModal();
    
    // Connect login button
    document.getElementById('loginBtn').addEventListener('click', login);
    
    // Setup offline detection
    window.addEventListener('online', handleConnectionChange);
    window.addEventListener('offline', handleConnectionChange);
    updateOnlineStatus();
    
    // Set default dates for dashboard
    const today = new Date();
    const oneWeekAgo = new Date();
    oneWeekAgo.setDate(today.getDate() - 7);
    
    document.getElementById('dashboardStartDate').valueAsDate = oneWeekAgo;
    document.getElementById('dashboardEndDate').valueAsDate = today;
    document.getElementById('operatorStartDate').valueAsDate = oneWeekAgo;
    document.getElementById('operatorEndDate').valueAsDate = today;
    
    // Set default dates for orders tab
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(today.getMonth() - 1);
    document.getElementById('ordersStartDate').valueAsDate = oneMonthAgo;
    document.getElementById('ordersEndDate').valueAsDate = today;
    
    // Initialize operator sales tab when shown
    document.getElementById('operatorSalesTab').addEventListener('shown.bs.tab', function() {
      initOperatorSalesTab();
    });
    
    // Initialize orders tab when shown
    document.getElementById('ordersTab').addEventListener('shown.bs.tab', function() {
      loadOrderHistory();
    });
    
    // Check if user is already logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadUserData();
        document.getElementById('appContainer').classList.remove('hidden');
        document.getElementById('loginPage').classList.add('hidden');
      }
    }, (error) => {
      console.error("Auth state error:", error);
      alert("Authentication error: " + error.message);
    });
  }

  // Initialize operator sales tab
  async function initOperatorSalesTab() {
    // Populate operator dropdown
    const operatorSelect = document.getElementById('operatorSelect');
    operatorSelect.innerHTML = '<option value="all">All Operators</option>';
    
    // Populate product filter
    const productFilter = document.getElementById('productFilter');
    productFilter.innerHTML = '<option value="all">All Products</option>';
    
    // Setup event listeners
    document.getElementById('timePeriodFilter').addEventListener('change', function() {
      const isCustom = this.value === 'custom';
      document.getElementById('customDateRangeOperator').style.display = isCustom ? 'flex' : 'none';
    });
    
    // Load initial data
    await loadOperators();
    await loadProducts();
    loadOperatorSales();
  }

  // Load operators list
  async function loadOperators() {
    try {
      const querySnapshot = await getDocs(collection(db, 'vanStock'));
      const operatorSelect = document.getElementById('operatorSelect');
      
      querySnapshot.forEach(doc => {
        // Get operator email from vanStock document ID (assuming ID is operator UID)
        // You might need to store operator emails in vanStock documents for better display
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = doc.id.substring(0, 8) + '...'; // Shorten for display
        operatorSelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error loading operators:", error);
    }
  }

  // Load products list
  async function loadProducts() {
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      const productFilter = document.getElementById('productFilter');
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const key in warehouseData) {
          const [name, size] = key.split('|');
          const option = document.createElement('option');
          option.value = key;
          option.textContent = `${name} (${size})`;
          productFilter.appendChild(option);
        }
      }
    } catch (error) {
      console.error("Error loading products:", error);
    }
  }

  // Main function to load operator sales data
  async function loadOperatorSales() {
    try {
      // Get filter values
      const operatorId = document.getElementById('operatorSelect').value;
      const productFilter = document.getElementById('productFilter').value;
      const timePeriod = document.getElementById('timePeriodFilter').value;
      
      // Determine date range
      let startDate, endDate = new Date();
      endDate.setHours(23, 59, 59, 999);
      
      if (timePeriod === 'custom') {
        startDate = new Date(document.getElementById('operatorStartDate').value);
        endDate = new Date(document.getElementById('operatorEndDate').value);
        endDate.setHours(23, 59, 59, 999);
      } else {
        startDate = calculateStartDate(timePeriod);
      }
      
      // Build the Firestore query
      let invoicesQuery = query(
        collection(db, 'invoices'),
        where('invoiceDate', '>=', startDate),
        where('invoiceDate', '<=', endDate),
        where('status', '==', 'approved')
      );
      
      // Add operator filter if not "all"
      if (operatorId !== 'all') {
        invoicesQuery = query(invoicesQuery, where('createdByUid', '==', operatorId));
      }
      
      const querySnapshot = await getDocs(invoicesQuery);
      
      // Process the data
      const operatorSales = {};
      const productSales = {};
      let totalQuantity = 0;
      let totalRevenue = 0;
      
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        const operatorKey = invoice.createdByUid || invoice.createdBy; // Fallback to email if UID not available
        
        if (!operatorSales[operatorKey]) {
          operatorSales[operatorKey] = {
            email: invoice.createdBy,
            products: {},
            totalQuantity: 0,
            totalRevenue: 0
          };
        }
        
        invoice.items.forEach(item => {
          const productKey = `${item.name}|${item.size}`;
          
          // Apply product filter if not "all"
          if (productFilter === 'all' || productFilter === productKey) {
            // Update operator sales
            if (!operatorSales[operatorKey].products[productKey]) {
              operatorSales[operatorKey].products[productKey] = {
                name: item.name,
                size: item.size,
                quantity: 0,
                revenue: 0
              };
            }
            
            operatorSales[operatorKey].products[productKey].quantity += item.qty;
            operatorSales[operatorKey].products[productKey].revenue += item.amount;
            operatorSales[operatorKey].totalQuantity += item.qty;
            operatorSales[operatorKey].totalRevenue += item.amount;
            
            // Update global product sales
            if (!productSales[productKey]) {
              productSales[productKey] = {
                name: item.name,
                size: item.size,
                quantity: 0,
                revenue: 0
              };
            }
            
            productSales[productKey].quantity += item.qty;
            productSales[productKey].revenue += item.amount;
            
            // Update totals
            totalQuantity += item.qty;
            totalRevenue += item.amount;
          }
        });
      });
      
      // Update the table
      updateOperatorSalesTable(operatorSales);
      
      // Update the charts
      updateOperatorCharts(operatorSales, productSales);
      
    } catch (error) {
      console.error("Error loading operator sales:", error);
      alert("Error loading operator sales data: " + error.message);
    }
  }

  function calculateStartDate(timePeriod) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    switch(timePeriod) {
      case 'today':
        return today;
      case 'week':
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
        return weekStart;
      case 'month':
        return new Date(today.getFullYear(), today.getMonth(), 1);
      case 'quarter':
        const quarter = Math.floor(today.getMonth() / 3);
        return new Date(today.getFullYear(), quarter * 3, 1);
      case 'year':
        return new Date(today.getFullYear(), 0, 1);
      default:
        return new Date(0); // All time
    }
  }

  function updateOperatorSalesTable(operatorSales) {
    const tbody = document.getElementById('operatorSalesBody');
    tbody.innerHTML = '';
    
    for (const operatorId in operatorSales) {
      const operator = operatorSales[operatorId];
      
      for (const productKey in operator.products) {
        const product = operator.products[productKey];
        const percentage = operator.totalRevenue > 0 
          ? (product.revenue / operator.totalRevenue * 100) 
          : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${operator.email}</td>
          <td>${product.name}</td>
          <td>${product.size}</td>
          <td>${product.quantity}</td>
          <td>₹${product.revenue.toFixed(2)}</td>
          <td>${percentage.toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
      }
    }
    
    if (tbody.children.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center">No sales data found for selected filters</td></tr>';
    }
  }

  function updateOperatorCharts(operatorSales, productSales) {
    // Operator Performance Chart (Top operators by quantity)
    const operatorsArray = Object.values(operatorSales)
      .sort((a, b) => b.totalQuantity - a.totalQuantity)
      .slice(0, 5);
    
    const operatorLabels = operatorsArray.map(op => op.email.substring(0, 8) + '...');
    const operatorQuantities = operatorsArray.map(op => op.totalQuantity);
    
    // Product Performance Chart (Top products across all operators)
    const productsArray = Object.values(productSales)
      .sort((a, b) => b.quantity - a.quantity)
      .slice(0, 5);
    
    const productLabels = productsArray.map(p => `${p.name} (${p.size})`);
    const productQuantities = productsArray.map(p => p.quantity);
    
    // Destroy previous charts if they exist
    if (operatorPerformanceChart) {
      operatorPerformanceChart.destroy();
    }
    if (operatorProductChart) {
      operatorProductChart.destroy();
    }
    
    // Create Operator Performance Chart
    const operatorCtx = document.getElementById('operatorPerformanceChart').getContext('2d');
    operatorPerformanceChart = new Chart(operatorCtx, {
      type: 'bar',
      data: {
        labels: operatorLabels,
        datasets: [{
          label: 'Quantity Sold',
          data: operatorQuantities,
          backgroundColor: 'rgba(54, 162, 235, 0.7)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Top Operators by Quantity'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Items Sold'
            }
          }
        }
      }
    });
    
    // Create Product Performance Chart
    const productCtx = document.getElementById('operatorProductChart').getContext('2d');
    operatorProductChart = new Chart(productCtx, {
      type: 'pie',
      data: {
        labels: productLabels,
        datasets: [{
          data: productQuantities,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Top Products Across Operators'
          }
        }
      }
    });
  }

  // Export operator sales data
  async function exportOperatorSales() {
    try {
      // Get the current table data
      const rows = document.getElementById('operatorSalesBody').querySelectorAll('tr');
      
      // Prepare CSV content
      let csv = 'Operator,Product,Size,Quantity Sold,Total Revenue,% of Operator Sales\n';
      
      rows.forEach(row => {
        if (row.cells.length === 6) { // Skip the "no data" row
          const cells = Array.from(row.cells).map(cell => {
            // Handle currency values (remove ₹ symbol)
            return cell.textContent.replace('₹', '').trim();
          });
          csv += cells.join(',') + '\n';
        }
      });
      
      // Create download link
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // Generate filename based on filters
      const operator = document.getElementById('operatorSelect').value === 'all' ? 'all-operators' : document.getElementById('operatorSelect').value;
      const product = document.getElementById('productFilter').value === 'all' ? 'all-products' : document.getElementById('productFilter').value;
      const period = document.getElementById('timePeriodFilter').value;
      
      a.download = `operator-sales_${operator}_${product}_${period}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      
    } catch (error) {
      console.error("Error exporting operator sales:", error);
      alert("Error exporting data: " + error.message);
    }
  }

  // Handle connection changes
  function handleConnectionChange() {
    isOnline = navigator.onLine;
    updateOnlineStatus();
    if (isOnline) {
      syncOfflineData();
    }
  }

  function updateOnlineStatus() {
    const offlineBanner = document.getElementById('offlineBanner');
    if (isOnline) {
      offlineBanner.classList.add('hidden');
    } else {
      offlineBanner.classList.remove('hidden');
    }
  }

  // Sync offline data when connection is restored
  async function syncOfflineData() {
    if (!currentUser) return;
    
    // Sync offline invoices
    while (offlineInvoices.length > 0) {
      const invoice = offlineInvoices[0];
      try {
        await addDoc(collection(db, 'invoices'), invoice);
        offlineInvoices.shift();
        localStorage.setItem('offlineInvoices', JSON.stringify(offlineInvoices));
      } catch (error) {
        console.error("Error syncing offline invoice:", error);
        break;
      }
    }
    
    // Sync stock requests
    while (offlineStockRequests.length > 0) {
      const request = offlineStockRequests[0];
      try {
        await addDoc(collection(db, 'stockRequests'), request);
        offlineStockRequests.shift();
        localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
      } catch (error) {
        console.error("Error syncing stock request:", error);
        break;
      }
    }
    
    // Reload data after sync
    if (isSupermanAdmin(currentUser.email)) {
      loadPendingApprovals();
      loadPendingStockApprovals();
      loadWarehouseStock();
    } else {
      loadPendingStockRequests();
    }
  }

  // Check if user is super admin
  function isSupermanAdmin(email) {
    return email === 'supremeenterprise79@gmail.com' || email === 'admin@gantasolutions.com';
  }

  // Create invoice modal for detailed view
  function createInvoiceModal() {
    const modalHTML = `
      <div class="modal fade" id="invoiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Invoice Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody">
              <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="printInvoiceFromModal()">Print</button>
              <span id="approvalButtons"></span>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
  }

  // Login function
  async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      currentUser = userCredential.user;
      document.getElementById('appContainer').classList.remove('hidden');
      document.getElementById('loginPage').classList.add('hidden');
      loadUserData();
    } catch (error) {
      alert('Login failed: ' + error.message);
      console.error("Login error:", error);
    }
  }

  // Logout function
  function logout() {
    signOut(auth).then(() => {
      currentUser = null;
      document.getElementById('appContainer').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }).catch((error) => {
      console.error("Logout error:", error);
    });
  }

  // Load user-specific data
  async function loadUserData() {
    if (!currentUser) return;
    
    // Show/hide tabs based on user role
    const isSuperAdmin = isSupermanAdmin(currentUser.email);
    document.getElementById('adminTabItem').classList.toggle('hidden', !isSuperAdmin);
    document.getElementById('dashboardTabItem').classList.toggle('hidden', !isSuperAdmin);
    document.getElementById('operatorSalesTabItem').classList.toggle('hidden', !isSuperAdmin);
    document.getElementById('ordersTabItem').classList.toggle('hidden', !isSuperAdmin);
    
    if (isSuperAdmin) {
      loadAdminData();
      loadWarehouseStock();
    } else {
      loadOperatorData();
    }
    
    // Generate invoice number
    generateInvoiceNo();
    
    // Setup real-time listeners
    setupRealTimeListeners();
    
    // Initialize dashboard if shown
    if (document.getElementById('dashboardTab').classList.contains('active')) {
      loadDashboardData();
    }
  }

  // Setup real-time listeners
  function setupRealTimeListeners() {
    if (isSupermanAdmin(currentUser.email)) {
      // Invoices
      onSnapshot(query(collection(db, 'invoices'), where('status', '==', 'pending')), 
        () => loadPendingApprovals());
        
      // Stock requests
      onSnapshot(query(collection(db, 'stockRequests'), where('status', '==', 'pending')), 
        () => loadPendingStockApprovals());
    }
  }

  // Load operator-specific data
  async function loadOperatorData() {
    // Set van operator name
    document.getElementById('vanOperatorName').textContent = currentUser.email.split('@')[0];
    
    // Load van stock
    try {
      const vanStockDoc = await getDoc(doc(db, 'vanStock', currentUser.uid));
      if (vanStockDoc.exists()) {
        vanStock = vanStockDoc.data().stock || {};
        updateVanStockDisplay();
      } else {
        // Initialize empty stock if none exists
        vanStock = {};
        updateVanStockDisplay();
      }
    } catch (error) {
      console.error("Error loading van stock:", error);
      alert("Error loading van stock: " + error.message);
    }
    
    // Load pending stock requests
    loadPendingStockRequests();
  }

  // Load admin-specific data
  async function loadAdminData() {
    loadPendingApprovals();
    loadPendingStockApprovals();
    loadVanOperatorsSummary();
    loadRecentInvoices();
  }

  // Load warehouse stock data
  async function loadWarehouseStock() {
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      const tbody = document.getElementById('warehouseStockBody');
      tbody.innerHTML = '';
      
      if (warehouseSnap.exists()) {
        const warehouseData = warehouseSnap.data();
        
        for (const [key, qty] of Object.entries(warehouseData)) {
          const [name, size] = key.split('|');
          const row = document.createElement('tr');
          row.className = qty < 10 ? 'stock-low' : (qty === 0 ? 'stock-out' : '');
          row.innerHTML = `
            <td>${name}</td>
            <td>${size}</td>
            <td>${qty}</td>
          `;
          tbody.appendChild(row);
        }
      }
    } catch (error) {
      console.error("Error loading warehouse stock:", error);
      alert("Error loading warehouse stock: " + error.message);
    }
  }

  // Generate invoice number
  async function generateInvoiceNo() {
    try {
      const counterDoc = await getDoc(doc(db, 'counters', 'invoiceCounter'));
      if (counterDoc.exists()) {
        invoiceCounter = counterDoc.data().value;
      } else {
        // Initialize counter if it doesn't exist
        invoiceCounter = 0;
        await setDoc(doc(db, 'counters', 'invoiceCounter'), { value: invoiceCounter });
      }
    } catch (error) {
      console.error("Error loading invoice counter:", error);
      invoiceCounter = 0;
    }
    
    const now = new Date();
    const id = 'CB-' + now.getFullYear() + '-' + String(invoiceCounter + 1).padStart(4, '0');
    document.getElementById('invoiceNo').textContent = id;
    document.getElementById('invoiceDate').textContent = now.toLocaleDateString();
  }

  // Add product to invoice
  function addProduct() {
    const select = document.getElementById('productSelect');
    const value = select.value;
    const qty = parseInt(document.getElementById('qty').value) || 1;
    
    if (!value) return alert('Please select a product.');
    if (qty <= 0) return alert('Quantity must be greater than 0.');
    
    const [name, size, rate] = value.split('|');
    const productKey = `${name}|${size}`;
    
    // Check stock if operator
    if (!isSupermanAdmin(currentUser.email)) {
      if (!vanStock[productKey] || vanStock[productKey].remaining < qty) {
        return alert('Not enough stock in van for this product!');
      }
    }
    
    const amount = qty * parseFloat(rate);
    subtotal += amount;
    
    // Add to invoice items
    const item = {
      name,
      size,
      qty,
      rate: parseFloat(rate),
      amount
    };
    
    invoiceItems.push(item);
    
    // Update invoice table
    updateInvoiceTable();
    
    // Update van stock (preliminary - will be finalized on save)
    if (!isSupermanAdmin(currentUser.email)) {
      vanStock[productKey].sold = (vanStock[productKey].sold || 0) + qty;
      vanStock[productKey].remaining = vanStock[productKey].loaded - vanStock[productKey].sold;
      updateVanStockDisplay();
    }
  }

  // Update invoice table display
  function updateInvoiceTable() {
    const invoiceBody = document.getElementById('invoiceBody');
    invoiceBody.innerHTML = '';
    
    let newSubtotal = 0;
    
    invoiceItems.forEach((item, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.size}</td>
        <td>${item.qty}</td>
        <td>₹${item.rate.toFixed(2)}</td>
        <td>₹${item.amount.toFixed(2)}</td>
        <td><button class="btn btn-danger btn-sm" onclick="removeItem(${index})">X</button></td>
      `;
      invoiceBody.appendChild(row);
      newSubtotal += item.amount;
    });
    
    subtotal = newSubtotal;
    const total = subtotal;
    
    document.getElementById('subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('gst').textContent = '0.00';
    document.getElementById('total').textContent = total.toFixed(2);
  }

  // Remove item from invoice
  function removeItem(index) {
    const removedItem = invoiceItems.splice(index, 1)[0];
    
    // Update van stock if needed
    if (!isSupermanAdmin(currentUser.email)) {
      const productKey = `${removedItem.name}|${removedItem.size}`;
      if (vanStock[productKey]) {
        vanStock[productKey].sold -= removedItem.qty;
        vanStock[productKey].remaining = vanStock[productKey].loaded - vanStock[productKey].sold;
        updateVanStockDisplay();
      }
    }
    
    updateInvoiceTable();
  }

  // Save invoice to Firebase
  async function saveInvoice() {
    if (invoiceItems.length === 0) return alert('Add products to invoice before saving!');
    
    const dealerName = document.getElementById('dealerName').value;
    if (!dealerName) return alert('Please enter dealer name!');
    
    const invoiceNo = document.getElementById('invoiceNo').textContent;
    const invoiceDate = document.getElementById('invoiceDate').textContent;
    
    const total = subtotal;
    
    const invoiceData = {
      invoiceNo,
      invoiceDate: new Date(),
      dealer: {
        name: dealerName,
        address: document.getElementById('dealerAddress').value || '',
        gstin: document.getElementById('dealerGST').value || ''
      },
      items: invoiceItems,
      subtotal,
      gst: 0,
      total,
      status: isSupermanAdmin(currentUser.email) ? 'approved' : 'pending',
      createdBy: currentUser.email,
      createdByUid: currentUser.uid,
      createdAt: serverTimestamp(),
      isOffline: !isOnline
    };
    
    if (isOnline) {
      try {
        // Save invoice
        await addDoc(collection(db, 'invoices'), invoiceData);
        
        // Update invoice counter
        invoiceCounter++;
        await setDoc(doc(db, 'counters', 'invoiceCounter'), { value: invoiceCounter });
        
        // Update van stock if operator
        if (!isSupermanAdmin(currentUser.email)) {
          await setDoc(doc(db, 'vanStock', currentUser.uid), {
            stock: vanStock,
            lastUpdated: serverTimestamp()
          });
        }
        
        alert('Invoice saved successfully!');
        resetInvoiceForm();
      } catch (error) {
        console.error("Error saving invoice:", error);
        // Fallback to offline
        saveInvoiceOffline(invoiceData);
      }
    } else {
      saveInvoiceOffline(invoiceData);
    }
  }

  // Save invoice offline
  function saveInvoiceOffline(invoiceData) {
    offlineInvoices.push(invoiceData);
    localStorage.setItem('offlineInvoices', JSON.stringify(offlineInvoices));
    
    // Update van stock locally
    if (!isSupermanAdmin(currentUser.email)) {
      localStorage.setItem(`vanStock_${currentUser.uid}`, JSON.stringify(vanStock));
    }
    
    alert('Invoice saved offline. Will sync when connection is restored.');
    resetInvoiceForm();
  }

  // Save draft invoice
  function saveDraft() {
    if (invoiceItems.length === 0) return alert('Add products to invoice before saving!');
    
    const dealerName = document.getElementById('dealerName').value;
    if (!dealerName) return alert('Please enter dealer name!');
    
    const invoiceNo = document.getElementById('invoiceNo').textContent;
    
    const draftData = {
      invoiceNo,
      dealerName,
      dealerAddress: document.getElementById('dealerAddress').value || '',
      dealerGST: document.getElementById('dealerGST').value || '',
      items: invoiceItems,
      subtotal,
      timestamp: new Date().toISOString()
    };
    
    draftInvoices.push(draftData);
    localStorage.setItem('draftInvoices', JSON.stringify(draftInvoices));
    
    alert('Draft saved successfully!');
    resetInvoiceForm();
  }

  // Reset invoice form
  function resetInvoiceForm() {
    invoiceItems = [];
    subtotal = 0;
    document.getElementById('invoiceBody').innerHTML = '';
    document.getElementById('subtotal').textContent = '0.00';
    document.getElementById('gst').textContent = '0.00';
    document.getElementById('total').textContent = '0.00';
    document.getElementById('dealerName').value = '';
    document.getElementById('dealerAddress').value = '';
    document.getElementById('dealerGST').value = '';
    generateInvoiceNo();
  }

  // Print invoice
  function printInvoice() {
    window.print();
  }

  // Print from modal
  function printInvoiceFromModal() {
    const modal = document.getElementById('invoiceModal');
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write('<html><head><title>Invoice Print</title>');
    printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
    printWindow.document.write('<style>body { font-family: Arial; padding: 5px; font-size: 12px; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(modal.querySelector('.modal-body').innerHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => {
      printWindow.print();
      printWindow.close();
    }, 500);
  }

  // Remove stock from van
  async function removeStock(productName, productSize) {
    const qty = prompt(`Enter quantity to remove for ${productName} (${productSize}):`);
    if (!qty || isNaN(qty)) return;
    
    const productKey = `${productName}|${productSize}`;
    if (!vanStock[productKey] || vanStock[productKey].remaining < qty) {
      return alert('Not enough stock to remove!');
    }
    
    try {
      if (isOnline) {
        // Record stock transaction
        await addDoc(collection(db, 'stockTransactions'), {
          type: 'unload',
          product: {
            name: productName,
            size: productSize
          },
          quantity: parseInt(qty),
          operatorId: currentUser.uid,
          operatorEmail: currentUser.email,
          timestamp: serverTimestamp()
        });
        
        // Update van stock
        vanStock[productKey].remaining -= parseInt(qty);
        await setDoc(doc(db, 'vanStock', currentUser.uid), {
          stock: vanStock,
          lastUpdated: serverTimestamp()
        });
        
        alert('Stock removed successfully!');
        updateVanStockDisplay();
      } else {
        // Offline handling
        vanStock[productKey].remaining -= parseInt(qty);
        localStorage.setItem(`vanStock_${currentUser.uid}`, JSON.stringify(vanStock));
        alert('Stock removal recorded offline. Will sync when connection is restored.');
        updateVanStockDisplay();
      }
    } catch (error) {
      console.error("Error removing stock:", error);
      alert('Error removing stock: ' + error.message);
    }
  }

  // Van stock management functions
  async function requestStock() {
    const select = document.getElementById('stockProductSelect');
    const value = select.value;
    const qty = parseInt(document.getElementById('stockQty').value) || 1;
    
    if (!value) return alert('Please select a product.');
    if (qty <= 0) return alert('Quantity must be greater than 0.');
    
    const [name, size] = value.split('|');
    
    // Check warehouse availability first
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      if (warehouseSnap.exists()) {
        const warehouseStock = warehouseSnap.data();
        const productKey = `${name}|${size}`;
        
        if (!warehouseStock[productKey] || warehouseStock[productKey] < qty) {
          return alert('Not enough stock in warehouse!');
        }
      }
    } catch (error) {
      console.error("Error checking warehouse stock:", error);
      return alert('Error checking warehouse availability');
    }
    
    const stockRequest = {
      operatorId: currentUser.uid,
      operatorEmail: currentUser.email,
      product: { name, size },
      quantity: qty,
      timestamp: new Date(),
      status: 'pending',
      isOffline: !isOnline
    };
    
    if (isOnline) {
      try {
        await addDoc(collection(db, 'stockRequests'), stockRequest);
        alert('Stock request submitted for admin approval');
        loadPendingStockRequests();
      } catch (error) {
        console.error("Error saving stock request:", error);
        saveStockRequestOffline(stockRequest);
      }
    } else {
      saveStockRequestOffline(stockRequest);
    }
    
    document.getElementById('stockQty').value = '';
  }

  // Save stock request offline
  function saveStockRequestOffline(request) {
    offlineStockRequests.push(request);
    localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
    alert('Stock request saved offline. Will submit when connection is restored.');
    loadPendingStockRequests();
  }

  // Update warehouse stock
  async function updateWarehouseStock() {
    const select = document.getElementById('warehouseProductSelect');
    const value = select.value;
    const qty = parseInt(document.getElementById('warehouseQty').value) || 1;
    const action = document.getElementById('warehouseAction').value;
    
    if (!value) return alert('Please select a product.');
    if (qty <= 0) return alert('Quantity must be greater than 0.');
    
    const [name, size] = value.split('|');
    const productKey = `${name}|${size}`;
    
    try {
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseSnap = await getDoc(warehouseRef);
      
      let warehouseData = warehouseSnap.exists() ? warehouseSnap.data() : {};
      if (!warehouseData[productKey]) {
        warehouseData[productKey] = 0;
      }
      
      if (action === 'add') {
        warehouseData[productKey] += qty;
      } else {
        if (warehouseData[productKey] < qty) {
          return alert('Not enough stock to remove!');
        }
        warehouseData[productKey] -= qty;
      }
      
      await setDoc(warehouseRef, warehouseData);
      alert('Warehouse stock updated!');
      loadWarehouseStock();
    } catch (error) {
      console.error("Error updating warehouse stock:", error);
      alert('Error updating warehouse: ' + error.message);
    }
  }

  // Update van stock display
  function updateVanStockDisplay() {
    const vanStockBody = document.getElementById('vanStockBody');
    vanStockBody.innerHTML = '';
    
    let stockDisplay = '';
    let totalStock = 0;
    let lowStockCount = 0;
    
    for (const key in vanStock) {
      const item = vanStock[key];
      const row = document.createElement('tr');
      row.className = item.remaining < 5 ? 'stock-low' : (item.remaining === 0 ? 'stock-out' : '');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.size}</td>
        <td>${item.loaded}</td>
        <td>${item.sold}</td>
        <td>${item.remaining}</td>
        <td>
          <button onclick="removeStock('${item.name}', '${item.size}')" class="btn btn-danger btn-sm">
            <i class="bi bi-dash-circle"></i> Remove
          </button>
        </td>
      `;
      vanStockBody.appendChild(row);
      
      if (item.remaining > 0) {
        stockDisplay += `${item.name} (${item.size}): ${item.remaining}, `;
        totalStock += item.remaining;
        
        if (item.remaining < 5) {
          lowStockCount++;
        }
      }
    }
    
    const summaryHTML = `
      <div class="row text-center mb-2">
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body p-2">
              <h6>Total Products</h6>
              <h4>${Object.keys(vanStock).length}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body p-2">
              <h6>Total Stock</h6>
              <h4>${totalStock}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-light">
            <div class="card-body p-2">
              <h6>Low Stock (<5)</h6>
              <h4>${lowStockCount}</h4>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('currentStockDisplay').innerHTML = 
      summaryHTML + (stockDisplay.length > 0 ? stockDisplay.slice(0, -2) : 'No stock available');
    
    // Update tab title with stock count
    document.querySelector('[href="#stockTab"]').innerHTML = 
      `Stock <span class="badge bg-primary">${totalStock}</span>`;
  }

  // Load pending stock requests for operator
  async function loadPendingStockRequests() {
    const pendingRequestsBody = document.getElementById('pendingRequestsBody');
    pendingRequestsBody.innerHTML = '';
    
    // Check offline requests first
    const allRequests = [...offlineStockRequests];
    
    if (isOnline) {
      try {
        const q = query(
          collection(db, 'stockRequests'),
          where('operatorId', '==', currentUser.uid),
          orderBy('timestamp', 'desc')
        );
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
          allRequests.push({ id: doc.id, ...doc.data() });
        });
      } catch (error) {
        console.error("Error loading stock requests:", error);
      }
    }
    
    allRequests.forEach(request => {
      let displayDate = 'N/A';
      try {
        if (request.timestamp) {
          const dateObj = request.timestamp.toDate ? request.timestamp.toDate() : new Date(request.timestamp);
          displayDate = dateObj.toLocaleDateString();
        }
      } catch (e) {
        console.error("Error formatting date:", e);
      }

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${request.product.name}</td>
        <td>${request.product.size}</td>
        <td>${request.quantity}</td>
        <td>${displayDate}</td>
        <td>${request.status} ${request.isOffline ? '(Offline)' : ''}</td>
      `;
      pendingRequestsBody.appendChild(row);
    });
  }

  // Admin functions
  async function loadPendingApprovals() {
    try {
      const q = query(
        collection(db, 'invoices'),
        where('status', '==', 'pending'),
        orderBy('createdAt', 'desc'),
        limit(5)
      );
      
      const querySnapshot = await getDocs(q);
      let html = '';
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        html += `
          <div class="card mb-2">
            <div class="card-body p-2">
              <h5 class="card-title mb-1">${invoice.invoiceNo}</h5>
              <p class="card-text mb-1">
                <strong>Dealer:</strong> ${invoice.dealer.name}<br>
                <strong>Amount:</strong> ₹${invoice.total.toFixed(2)}<br>
                <strong>Operator:</strong> ${invoice.createdBy}
              </p>
              <button onclick="approveInvoice('${doc.id}')" class="btn btn-success btn-sm">Approve</button>
              <button onclick="rejectInvoice('${doc.id}')" class="btn btn-danger btn-sm">Reject</button>
              <button onclick="viewInvoice('${doc.id}')" class="btn btn-primary btn-sm">View</button>
            </div>
          </div>
        `;
      });
      
      if (!html) html = '<p>No pending approvals</p>';
      document.getElementById('pendingApprovalsList').innerHTML = html;
    } catch (error) {
      console.error("Error loading pending approvals:", error);
      alert("Error loading pending approvals: " + error.message);
    }
  }

  async function loadPendingStockApprovals() {
    try {
      let allRequests = [];
      
      // Get online requests
      if (isOnline) {
        const q = query(
          collection(db, 'stockRequests'),
          where('status', '==', 'pending'),
          orderBy('timestamp', 'desc')
        );
        
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
          allRequests.push({ id: doc.id, ...doc.data() });
        });
      }
      
      // Add offline requests
      allRequests = allRequests.concat(offlineStockRequests);
      
      let html = '';
      allRequests.forEach(request => {
        const isOffline = request.isOffline || false;
        const requestId = request.id || 'offline-' + Math.random().toString(36).substr(2, 9);
        
        html += `
          <div class="card mb-2">
            <div class="card-body p-2">
              <h5 class="mb-1">${request.product.name} (${request.product.size})</h5>
              <p class="mb-1">Operator: ${request.operatorEmail}</p>
              <p class="mb-1">Qty: ${request.quantity}</p>
              <p class="mb-1">Date: ${request.timestamp ? new Date(request.timestamp).toLocaleDateString() : 'N/A'}</p>
              ${isOffline ? '<p class="text-warning mb-1">Offline Request</p>' : ''}
              <button onclick="approveStockRequest('${requestId}', '${request.operatorId}', 
                '${request.product.name}', '${request.product.size}', ${request.quantity}, ${isOffline})" 
                class="btn btn-success btn-sm">Approve</button>
              <button onclick="rejectStockRequest('${requestId}', ${isOffline})" 
                class="btn btn-danger btn-sm">Reject</button>
            </div>
          </div>
        `;
      });
      
      if (!html) html = '<p>No pending requests</p>';
      document.getElementById('pendingStockApprovals').innerHTML = html;
    } catch (error) {
      console.error("Error loading stock requests:", error);
      alert("Error loading stock requests: " + error.message);
    }
  }

  async function loadVanOperatorsSummary() {
    try {
      const querySnapshot = await getDocs(collection(db, 'vanStock'));
      let html = '<table class="table"><thead><tr><th>Operator</th><th>Products</th><th>Stock</th></tr></thead><tbody>';
      
      querySnapshot.forEach(doc => {
        const stock = doc.data().stock;
        let productCount = 0;
        let totalStock = 0;
        
        for (const key in stock) {
          productCount++;
          totalStock += stock[key].remaining;
        }
        
        html += `
          <tr>
            <td>${doc.id.substring(0, 8)}...</td>
            <td>${productCount}</td>
            <td>${totalStock}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('vanOperatorsSummary').innerHTML = html;
    } catch (error) {
      console.error("Error loading van operators summary:", error);
      alert("Error loading van operators: " + error.message);
    }
  }

  async function loadRecentInvoices() {
    try {
      const q = query(
        collection(db, 'invoices'),
        orderBy('createdAt', 'desc'),
        limit(10)
      );
      
      const querySnapshot = await getDocs(q);
      let html = '';
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        html += `
          <tr>
            <td>${invoice.invoiceNo}</td>
            <td>${invoice.invoiceDate.toDate().toLocaleDateString()}</td>
            <td>${invoice.dealer.name.substring(0, 10)}...</td>
            <td>₹${invoice.total.toFixed(2)}</td>
            <td>${invoice.createdBy.substring(0, 10)}...</td>
            <td>${invoice.status}</td>
            <td>
              <button onclick="viewInvoice('${doc.id}')" class="btn btn-primary btn-sm">View</button>
            </td>
          </tr>
        `;
      });
      
      document.getElementById('invoicesList').innerHTML = html;
    } catch (error) {
      console.error("Error loading recent invoices:", error);
      alert("Error loading invoices: " + error.message);
    }
  }

  async function approveInvoice(invoiceId) {
    try {
      await updateDoc(doc(db, 'invoices', invoiceId), {
        status: 'approved',
        approvedAt: serverTimestamp(),
        approvedBy: currentUser.email
      });
      alert('Invoice approved!');
      loadPendingApprovals();
      loadRecentInvoices();
    } catch (error) {
      console.error("Error approving invoice:", error);
      alert('Error approving invoice: ' + error.message);
    }
  }

  async function rejectInvoice(invoiceId) {
    try {
      await updateDoc(doc(db, 'invoices', invoiceId), {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        rejectedBy: currentUser.email
      });
      alert('Invoice rejected!');
      loadPendingApprovals();
      loadRecentInvoices();
    } catch (error) {
      console.error("Error rejecting invoice:", error);
      alert('Error rejecting invoice: ' + error.message);
    }
  }

  async function approveStockRequest(requestId, operatorId, productName, productSize, quantity, isOffline) {
    try {
      if (!isOffline) {
        // Update request status in Firestore
        await updateDoc(doc(db, 'stockRequests', requestId), {
            status: 'approved',
            approvedAt: serverTimestamp(),
            approvedBy: currentUser.email
        });
      } else {
        // Remove from offline requests
        const index = offlineStockRequests.findIndex(req => 
            req.operatorId === operatorId && 
            req.product.name === productName && 
            req.product.size === productSize &&
            req.quantity === quantity
        );
        if (index !== -1) {
            offlineStockRequests.splice(index, 1);
            localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
        }
      }
      
      // Record stock transaction
      await addDoc(collection(db, 'stockTransactions'), {
        type: 'load',
        product: {
          name: productName,
          size: productSize
        },
        quantity: quantity,
        operatorId: operatorId,
        operatorEmail: isOffline ? 'Offline Sync' : currentUser.email,
        timestamp: serverTimestamp(),
        approvedBy: currentUser.email
      });
      
      // Update van stock
      const productKey = `${productName}|${productSize}`;
      const vanStockRef = doc(db, 'vanStock', operatorId);
      const vanStockDoc = await getDoc(vanStockRef);
      
      let stockData = vanStockDoc.exists() ? vanStockDoc.data().stock : {};
      
      if (!stockData[productKey]) {
        stockData[productKey] = {
          name: productName,
          size: productSize,
          loaded: 0,
          sold: 0,
          remaining: 0
        };
      }
      
      stockData[productKey].loaded += quantity;
      stockData[productKey].remaining += quantity;
      
      await setDoc(vanStockRef, { 
        stock: stockData,
        lastUpdated: serverTimestamp()
      });
      
      // Update warehouse stock
      const warehouseRef = doc(db, 'warehouse', 'stock');
      const warehouseDoc = await getDoc(warehouseRef);
      
      let warehouseData = warehouseDoc.exists() ? warehouseDoc.data() : {};
      if (!warehouseData[productKey]) {
        warehouseData[productKey] = 0;
      }
      
      warehouseData[productKey] -= quantity;
      
      await setDoc(warehouseRef, warehouseData);
      
      alert('Stock request approved and updated!');
      loadPendingStockApprovals();
      loadWarehouseStock();
    } catch (error) {
      console.error("Error approving stock request:", error);
      alert('Error approving stock request: ' + error.message);
    }
  }

  async function rejectStockRequest(requestId, isOffline) {
    try {
      if (!isOffline) {
        await updateDoc(doc(db, 'stockRequests', requestId), {
          status: 'rejected',
          rejectedAt: serverTimestamp(),
          rejectedBy: currentUser.email
        });
      } else {
        // Remove from offline requests
        const index = offlineStockRequests.findIndex(req => req.id === requestId);
        if (index !== -1) {
          offlineStockRequests.splice(index, 1);
          localStorage.setItem('offlineStockRequests', JSON.stringify(offlineStockRequests));
        }
      }
      
      alert('Stock request rejected!');
      loadPendingStockApprovals();
    } catch (error) {
      console.error("Error rejecting stock request:", error);
      alert('Error rejecting stock request: ' + error.message);
    }
  }

  async function viewInvoice(invoiceId) {
    try {
      const docRef = doc(db, 'invoices', invoiceId);
      const docSnap = await getDoc(docRef);
      
      if (docSnap.exists()) {
        const invoice = docSnap.data();
        let itemsHTML = '';
        
        invoice.items.forEach(item => {
          itemsHTML += `
            <tr>
              <td>${item.name}</td>
              <td>${item.size}</td>
              <td>${item.qty}</td>
              <td>₹${item.rate.toFixed(2)}</td>
              <td>₹${item.amount.toFixed(2)}</td>
            </tr>
          `;
        });
        
        const modalBody = `
          <div class="company-header">
            <h2>Campa Beverages Pvt. Ltd.</h2>
            <p><strong>Invoice No:</strong> ${invoice.invoiceNo}</p>
            <p><strong>Date:</strong> ${invoice.invoiceDate.toDate().toLocaleDateString()}</p>
            <p><strong>Status:</strong> ${invoice.status}</p>
            <p><strong>Operator:</strong> ${invoice.createdBy}</p>
          </div>
          
          <div class="mt-2">
            <h4>Dealer Information</h4>
            <p><strong>Name:</strong> ${invoice.dealer.name}</p>
            <p><strong>Address:</strong> ${invoice.dealer.address || 'N/A'}</p>
            <p><strong>GSTIN:</strong> ${invoice.dealer.gstin || 'N/A'}</p>
          </div>
          
          <div style="overflow-x: auto;">
            <table class="table-bordered mt-2">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Size</th>
                  <th>Qty</th>
                  <th>Rate</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>${itemsHTML}</tbody>
            </table>
          </div>
          
          <div class="right mt-2">
            <h4>Subtotal: ₹${invoice.subtotal.toFixed(2)}</h4>
            <h4>GST (0%): ₹${invoice.gst.toFixed(2)}</h4>
            <h3>Total: ₹${invoice.total.toFixed(2)}</h3>
          </div>
        `;
        
        document.getElementById('invoiceModalBody').innerHTML = modalBody;
        
        // Add approval buttons if pending
        const approvalButtons = document.getElementById('approvalButtons');
        if (invoice.status === 'pending') {
          approvalButtons.innerHTML = `
            <button onclick="approveInvoice('${invoiceId}')" class="btn btn-success btn-sm">Approve</button>
            <button onclick="rejectInvoice('${invoiceId}')" class="btn btn-danger btn-sm">Reject</button>
          `;
        } else {
          approvalButtons.innerHTML = '';
        }
        
        const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
        modal.show();
      }
    } catch (error) {
      console.error("Error loading invoice:", error);
      alert('Error loading invoice: ' + error.message);
    }
  }

  // Export invoices
  function exportInvoices(format) {
    try {
      const table = document.getElementById('invoicesList');
      const rows = table.querySelectorAll('tr');
      
      const data = [];
      const headers = ['Invoice No', 'Date', 'Dealer', 'Amount', 'Operator', 'Status'];
      data.push(headers);
      
      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        if (cols.length > 0) {
          const rowData = [
            cols[0].innerText,
            cols[1].innerText,
            cols[2].innerText,
            cols[3].innerText,
            cols[4].innerText,
            cols[5].innerText
          ];
          data.push(rowData);
        }
      });
      
      if (format === 'csv') {
        let csv = '';
        data.forEach(row => {
          csv += row.join(',') + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'campa_invoices.csv';
        a.click();
      } else if (format === 'excel') {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Invoices');
        XLSX.writeFile(wb, 'campa_invoices.xlsx');
      }
    } catch (error) {
      console.error("Error exporting invoices:", error);
      alert('Error exporting invoices: ' + error.message);
    }
  }

  // Dashboard functions
  document.getElementById('dashboardTab').addEventListener('shown.bs.tab', function() {
    loadDashboardData();
  });

  document.getElementById('dashboardTimeRange').addEventListener('change', function() {
    const isCustom = this.value === 'custom';
    document.getElementById('customDateRange').style.display = isCustom ? 'block' : 'none';
    document.getElementById('customDateRangeEnd').style.display = isCustom ? 'block' : 'none';
    
    if (!isCustom) {
      loadDashboardData();
    }
  });

  // Toggle between product and quantity views
  function toggleView() {
    const productView = document.getElementById('productView');
    const quantityView = document.getElementById('quantityView');
    
    if (currentView === 'product') {
      productView.style.display = 'none';
      quantityView.style.display = 'block';
      currentView = 'quantity';
    } else {
      productView.style.display = 'block';
      quantityView.style.display = 'none';
      currentView = 'product';
    }
    
    // Redraw charts for the current view
    loadDashboardData();
  }

  // Toggle chart type (line/bar)
  function toggleChartType(chartGroup) {
    currentChartType[chartGroup] = currentChartType[chartGroup] === 'line' ? 'bar' : 'line';
    loadDashboardData();
  }

  async function loadDashboardData() {
    try {
      const timeRange = document.getElementById('dashboardTimeRange').value;
      let startDate, endDate, previousStartDate, previousEndDate;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // Set date ranges based on selection
      switch(timeRange) {
        case 'today':
          startDate = new Date(today);
          endDate = new Date(today);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today);
          previousStartDate.setDate(today.getDate()
                    previousStartDate.setDate(today.getDate() - 1);
          previousEndDate = new Date(previousStartDate);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'week':
          startDate = new Date(today);
          startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
          endDate = new Date(today);
          endDate.setDate(today.getDate() + (6 - today.getDay())); // End of week (Saturday)
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(startDate);
          previousStartDate.setDate(startDate.getDate() - 7);
          previousEndDate = new Date(endDate);
          previousEndDate.setDate(endDate.getDate() - 7);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'month':
          startDate = new Date(today.getFullYear(), today.getMonth(), 1);
          endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
          previousEndDate = new Date(today.getFullYear(), today.getMonth(), 0);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'quarter':
          const quarter = Math.floor(today.getMonth() / 3);
          startDate = new Date(today.getFullYear(), quarter * 3, 1);
          endDate = new Date(today.getFullYear(), (quarter * 3) + 3, 0);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today.getFullYear(), (quarter - 1) * 3, 1);
          previousEndDate = new Date(today.getFullYear(), quarter * 3, 0);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'year':
          startDate = new Date(today.getFullYear(), 0, 1);
          endDate = new Date(today.getFullYear(), 11, 31);
          endDate.setHours(23, 59, 59, 999);
          
          previousStartDate = new Date(today.getFullYear() - 1, 0, 1);
          previousEndDate = new Date(today.getFullYear() - 1, 11, 31);
          previousEndDate.setHours(23, 59, 59, 999);
          break;
          
        case 'custom':
          startDate = new Date(document.getElementById('dashboardStartDate').value);
          endDate = new Date(document.getElementById('dashboardEndDate').value);
          endDate.setHours(23, 59, 59, 999);
          
          // For custom range, we won't calculate previous period automatically
          previousStartDate = null;
          previousEndDate = null;
          break;
      }
      
      // Get current period data
      const q = query(
        collection(db, 'invoices'),
        where('invoiceDate', '>=', startDate),
        where('invoiceDate', '<=', endDate),
        where('status', '==', 'approved')
      );
      
      const querySnapshot = await getDocs(q);
      
      // Process data
      const salesData = {};
      const productData = {};
      const dailyData = {};
      let totalSales = 0;
      let totalQuantity = 0;
      let uniqueProducts = new Set();
      
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        const dateKey = invoice.invoiceDate.toDate().toLocaleDateString();
        
        // Initialize daily data if not exists
        if (!dailyData[dateKey]) {
          dailyData[dateKey] = {
            date: invoice.invoiceDate.toDate(),
            invoices: 0,
            quantity: 0,
            revenue: 0
          };
        }
        
        dailyData[dateKey].invoices += 1;
        dailyData[dateKey].revenue += invoice.total;
        
        // Process items
        invoice.items.forEach(item => {
          const productKey = `${item.name}|${item.size}`;
          
          // Update product data
          if (!productData[productKey]) {
            productData[productKey] = {
              name: item.name,
              size: item.size,
              quantity: 0,
              revenue: 0
            };
          }
          
          productData[productKey].quantity += item.qty;
          productData[productKey].revenue += item.amount;
          
          // Update totals
          totalSales += item.amount;
          totalQuantity += item.qty;
          uniqueProducts.add(productKey);
          
          // Update daily quantity
          dailyData[dateKey].quantity += item.qty;
        });
      });
      
      // Get previous period data if not custom range
      let previousTotalSales = 0;
      let previousTotalQuantity = 0;
      let previousUniqueProducts = 0;
      
      if (timeRange !== 'custom' && previousStartDate && previousEndDate) {
        const prevQ = query(
          collection(db, 'invoices'),
          where('invoiceDate', '>=', previousStartDate),
          where('invoiceDate', '<=', previousEndDate),
          where('status', '==', 'approved')
        );
        
        const prevSnapshot = await getDocs(prevQ);
        
        prevSnapshot.forEach(doc => {
          const invoice = doc.data();
          previousTotalSales += invoice.total;
          
          invoice.items.forEach(item => {
            previousTotalQuantity += item.qty;
            uniqueProducts.add(`${item.name}|${item.size}`);
          });
        });
      }
      
      // Calculate changes
      const salesChange = previousTotalSales > 0 
        ? ((totalSales - previousTotalSales) / previousTotalSales * 100).toFixed(1)
        : 'N/A';
      
      const quantityChange = previousTotalQuantity > 0 
        ? ((totalQuantity - previousTotalQuantity) / previousTotalQuantity * 100).toFixed(1)
        : 'N/A';
      
      const productsChange = previousUniqueProducts > 0 
        ? ((uniqueProducts.size - previousUniqueProducts) / previousUniqueProducts * 100).toFixed(1)
        : 'N/A';
      
      const avgSale = totalSales / (querySnapshot.size || 1);
      const previousAvgSale = previousTotalSales / (previousTotalSales ? 1 : 1);
      const avgSaleChange = previousAvgSale > 0 
        ? ((avgSale - previousAvgSale) / previousAvgSale * 100).toFixed(1)
        : 'N/A';
      
      // Update summary cards
      document.getElementById('totalSales').textContent = `₹${totalSales.toFixed(2)}`;
      document.getElementById('totalQuantity').textContent = totalQuantity;
      document.getElementById('totalProducts').textContent = uniqueProducts.size;
      document.getElementById('avgSale').textContent = `₹${avgSale.toFixed(2)}`;
      
      document.getElementById('salesChange').textContent = `${salesChange}%`;
      document.getElementById('quantityChange').textContent = `${quantityChange}%`;
      document.getElementById('productsChange').textContent = `${productsChange}%`;
      document.getElementById('avgSaleChange').textContent = `${avgSaleChange}%`;
      
      // Set color for change indicators
      setChangeIndicator('salesChange', salesChange);
      setChangeIndicator('quantityChange', quantityChange);
      setChangeIndicator('productsChange', productsChange);
      setChangeIndicator('avgSaleChange', avgSaleChange);
      
      // Prepare data for charts
      const sortedDailyData = Object.values(dailyData).sort((a, b) => a.date - b.date);
      const dates = sortedDailyData.map(d => d.date.toLocaleDateString());
      const dailySales = sortedDailyData.map(d => d.revenue);
      const dailyQuantities = sortedDailyData.map(d => d.quantity);
      
      // Sort product data
      const sortedProductData = Object.values(productData).sort((a, b) => b.revenue - a.revenue);
      const topProducts = sortedProductData.slice(0, 5);
      const topProductLabels = topProducts.map(p => `${p.name} (${p.size})`);
      const topProductValues = topProducts.map(p => p.revenue);
      
      const sortedQuantityData = Object.values(productData).sort((a, b) => b.quantity - a.quantity);
      const topQuantityProducts = sortedQuantityData.slice(0, 5);
      const topQuantityLabels = topQuantityProducts.map(p => `${p.name} (${p.size})`);
      const topQuantityValues = topQuantityProducts.map(p => p.quantity);
      
      // Update charts
      updateCharts(
        dates, 
        dailySales, 
        dailyQuantities, 
        topProductLabels, 
        topProductValues,
        topQuantityLabels,
        topQuantityValues
      );
      
      // Update tables
      updateTables(sortedProductData, sortedDailyData);
      
    } catch (error) {
      console.error("Error loading dashboard data:", error);
      alert("Error loading dashboard: " + error.message);
    }
  }

  function setChangeIndicator(elementId, changeValue) {
    const element = document.getElementById(elementId);
    if (changeValue === 'N/A') {
      element.className = '';
      return;
    }
    
    const change = parseFloat(changeValue);
    if (change > 0) {
      element.className = 'text-success';
      element.innerHTML = `+${changeValue}% <i class="bi bi-arrow-up"></i>`;
    } else if (change < 0) {
      element.className = 'text-danger';
      element.innerHTML = `${changeValue}% <i class="bi bi-arrow-down"></i>`;
    } else {
      element.className = '';
      element.innerHTML = `${changeValue}%`;
    }
  }

  function updateCharts(
    dates, 
    dailySales, 
    dailyQuantities, 
    topProductLabels, 
    topProductValues,
    topQuantityLabels,
    topQuantityValues
  ) {
    // Destroy previous charts if they exist
    if (salesTrendChart) salesTrendChart.destroy();
    if (quantityTrendChart) quantityTrendChart.destroy();
    if (topProductsChart) topProductsChart.destroy();
    if (topQuantityChart) topQuantityChart.destroy();
    
    // Sales Trend Chart
    const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
    salesTrendChart = new Chart(salesCtx, {
      type: currentChartType.sales,
      data: {
        labels: dates,
        datasets: [{
          label: 'Daily Sales (₹)',
          data: dailySales,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Sales Trend'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '₹' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '₹' + value;
              }
            }
          }
        }
      }
    });
    
    // Quantity Trend Chart
    const quantityCtx = document.getElementById('quantityTrendChart').getContext('2d');
    quantityTrendChart = new Chart(quantityCtx, {
      type: currentChartType.quantity,
      data: {
        labels: dates,
        datasets: [{
          label: 'Daily Quantity',
          data: dailyQuantities,
          backgroundColor: 'rgba(255, 159, 64, 0.2)',
          borderColor: 'rgba(255, 159, 64, 1)',
          borderWidth: 1,
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Quantity Trend'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Top Products Chart
    const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');
    topProductsChart = new Chart(topProductsCtx, {
      type: 'doughnut',
      data: {
        labels: topProductLabels,
        datasets: [{
          data: topProductValues,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Top Products by Revenue'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '₹' + context.raw.toFixed(2);
              }
            }
          }
        }
      }
    });
    
    // Top Quantity Chart
    const topQuantityCtx = document.getElementById('topQuantityChart').getContext('2d');
    topQuantityChart = new Chart(topQuantityCtx, {
      type: 'doughnut',
      data: {
        labels: topQuantityLabels,
        datasets: [{
          data: topQuantityValues,
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Top Products by Quantity'
          }
        }
      }
    });
  }

  function updateTables(productData, dailyData) {
    // Product Performance Table
    const productPerformance = document.getElementById('productPerformance');
    productPerformance.innerHTML = '';
    
    // Sort by revenue descending
    const sortedProducts = [...productData].sort((a, b) => b.revenue - a.revenue);
    
    sortedProducts.forEach(product => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${product.name}</td>
        <td>${product.size}</td>
        <td>${product.quantity}</td>
        <td>₹${product.revenue.toFixed(2)}</td>
        <td>${(product.revenue / totalSales * 100).toFixed(1)}%</td>
      `;
      productPerformance.appendChild(row);
    });
    
    // Daily Summary Table
    const dailySummary = document.getElementById('dailySummary');
    dailySummary.innerHTML = '';
    
    // Sort by date ascending
    const sortedDaily = [...dailyData].sort((a, b) => a.date - b.date);
    
    sortedDaily.forEach(day => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${day.date.toLocaleDateString()}</td>
        <td>${day.invoices}</td>
        <td>${day.quantity}</td>
        <td>₹${day.revenue.toFixed(2)}</td>
      `;
      dailySummary.appendChild(row);
    });
  }

  function exportDashboardData(timeRange) {
    // This would export data for the specified time range
    // Implementation would be similar to exportInvoices()
    alert(`Exporting ${timeRange} data - to be implemented`);
  }

  // Order History Functions
  async function loadOrderHistory() {
    try {
      const startDate = new Date(document.getElementById('ordersStartDate').value);
      const endDate = new Date(document.getElementById('ordersEndDate').value);
      endDate.setHours(23, 59, 59, 999);
      
      const operatorFilter = document.getElementById('ordersOperatorFilter').value;
      
      let q = query(
        collection(db, 'invoices'),
        where('invoiceDate', '>=', startDate),
        where('invoiceDate', '<=', endDate),
        orderBy('invoiceDate', 'desc')
      );
      
      if (operatorFilter !== 'all') {
        q = query(q, where('createdByUid', '==', operatorFilter));
      }
      
      const querySnapshot = await getDocs(q);
      const tbody = document.getElementById('ordersTableBody');
      tbody.innerHTML = '';
      
      querySnapshot.forEach(doc => {
        const invoice = doc.data();
        const date = invoice.invoiceDate.toDate();
        const products = invoice.items.map(item => `${item.name} (${item.size})`).join(', ');
        const totalQty = invoice.items.reduce((sum, item) => sum + item.qty, 0);
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${invoice.invoiceNo}</td>
          <td>${date.toLocaleDateString()}</td>
          <td>${invoice.dealer.name.substring(0, 15)}...</td>
          <td>${products.substring(0, 20)}...</td>
          <td>${totalQty}</td>
          <td>₹${invoice.total.toFixed(2)}</td>
          <td>${invoice.createdBy.substring(0, 10)}...</td>
          <td><span class="badge ${invoice.status === 'approved' ? 'bg-success' : invoice.status === 'pending' ? 'bg-warning' : 'bg-danger'}">${invoice.status}</span></td>
          <td><button onclick="viewInvoice('${doc.id}')" class="btn btn-primary btn-sm">View</button></td>
        `;
        tbody.appendChild(row);
      });
      
      if (tbody.children.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No orders found for selected filters</td></tr>';
      }
    } catch (error) {
      console.error("Error loading order history:", error);
      alert("Error loading orders: " + error.message);
    }
  }

  function exportAllCategoryData() {
    // This would export all order data for the selected filters
    alert("Exporting all category data - to be implemented");
  }

  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', initApp);

  // Make functions available globally
  window.addProduct = addProduct;
  window.removeItem = removeItem;
  window.saveInvoice = saveInvoice;
  window.printInvoice = printInvoice;
  window.saveDraft = saveDraft;
  window.logout = logout;
  window.removeStock = removeStock;
  window.requestStock = requestStock;
  window.updateWarehouseStock = updateWarehouseStock;
  window.approveInvoice = approveInvoice;
  window.rejectInvoice = rejectInvoice;
  window.viewInvoice = viewInvoice;
  window.approveStockRequest = approveStockRequest;
  window.rejectStockRequest = rejectStockRequest;
  window.exportInvoices = exportInvoices;
  window.toggleView = toggleView;
  window.toggleChartType = toggleChartType;
  window.exportDashboardData = exportDashboardData;
  window.loadOperatorSales = loadOperatorSales;
  window.exportOperatorSales = exportOperatorSales;
  window.loadOrderHistory = loadOrderHistory;
  window.exportAllCategoryData = exportAllCategoryData;
  window.printInvoiceFromModal = printInvoiceFromModal;
</script>
</body>
</html>                          
